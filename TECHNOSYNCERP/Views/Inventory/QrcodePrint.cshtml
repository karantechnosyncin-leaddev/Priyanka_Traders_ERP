@{
    Layout = "_Layout";
}

<style id="print-style">
    @@page {
        size: 50mm 25mm;
        margin: 0;
    }

    @@media print {
        body {
            margin: 0;
            padding: 0;
            width: 50mm;
            height: 25mm;
            font-family: Arial, sans-serif;
        }

        .Main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        .Qrcode_sec {
            width: 30%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .Discripiton_sec {
            width: 70%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 5px;
        }

        .Discriptiontext {
            font-size: 12px;
            font-weight: bold;
            line-height: 1.2;
        }

        .ItemCodelable {
            font-size: 11px;
            font-weight: bold;
            margin-top: -10px;
        }

        .Slplable {
            font-size: 8px;
            font-weight: bold;
        }
    }
</style>

<!-- QR Code CDN -->

<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b> <i class="bi bi-upc-scan me-2"></i>QrCode Printing</b></h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <!-- Left Section (Details) -->
                    <div class="col-12 col-md-7 mb-3">

                    </div>
                    <!-- Right Section (Buttons) -->
                    <div class="col-12 col-md-5 text-end justify-content-md-end justify-content-start flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-2 me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary w-100" role="alert">
                                No actions available
                            </div>
                        }
                    </div>
                    <div class="container-fluid">
                        <div class="app-card">
                            <div class="p-3 p-sm-">
                                <!-- Tabs -->
                                <ul class="nav nav-tabs" id="modeTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="grpo-tab" data-bs-toggle="tab" data-bs-target="#grpo" type="button" role="tab">GRPO Wise</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="item-tab" data-bs-toggle="tab" data-bs-target="#item" type="button" role="tab">ITEM Wise</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="box-tab" data-bs-toggle="tab" data-bs-target="#box" type="button" role="tab">BOX Wise</button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3">
                                    <!-- GRPO -->
                                    <div class="tab-pane fade show active" id="grpo" role="tabpanel">
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-5 col-sm-12 mb-2">
                                                <label class="form-label">GRPO Number :</label>
                                                <input class="form-control" id="grpoNumber" placeholder="Enter GRPO number">
                                            </div>
                                            <div class="col-md-3 col-sm-12 text-md-center mb-2">
                                                <button class="btn btn-danger generate-btn mt-4 " id="GenerateQRGRPO">Generate QR Code</button>
                                            </div>
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width:40px"><input type="checkbox" id="selectAll"></th>
                                                        <th>Item Code</th>
                                                        <th>Item Name</th>
                                                        <th>GRPO Qty</th>
                                                        <th>Sales Employee</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="grpoTbody">
                                                    <!-- sample empty row -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ITEM -->
                                    <div class="tab-pane fade" id="item" role="tabpanel">
                                        <form class="row g-3 align-items-end">
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Item Code :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item code" id="txtItemCode">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label">Item Name :</label>
                                                <input class="form-control item-name-input" placeholder="Enter item name" id="txtItemName">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label" for="itemSalesEmployee">Sales Employee :</label>
                                                <select class="form-select" id="itemSalesEmployee"><option>-No Sales Employee-</option></select>
                                            </div>
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Copies :</label>
                                                <input class="form-control" id="itemCopies" value="1">
                                            </div>
                                            <div class="col-md-2 col-sm-12 text-end">
                                                <button type="button" class="btn btn-primary mt-2" id="generateItemQR">Generate QR Code</button>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- BOX -->
                                    <div class="tab-pane fade" id="box" role="tabpanel">
                                        <form class="row g-3 align-items-end">
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Item Code :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item code" id="boxTabCode">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label">Item Name :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item name" id="boxTabName">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label" for="boxSalesEmployee">Sales Employee :</label>
                                                <select class="form-select" id="boxSalesEmployee"><option>-No Sales Employee-</option></select>
                                            </div>
                                            <div class="col-md-1 col-sm-6">
                                                <label class="form-label">Copies :</label>
                                                <input class="form-control" id="boxCopies" value="1">
                                            </div>
                                            <div class="col-md-1 col-sm-6">
                                                <label class="form-label">Quantity :</label>
                                                <input class="form-control" id="boxQuantity" value="1">
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <button type="button" class="btn btn-primary mt-2" id="generateBoxBarcode">Generate Barcode</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Print Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">QR Codes for Printing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qrCodeContainer" class="qr-code-container">
                    <!-- QR codes will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printQRCodes">Print</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <script>
    $(document).ready(function () {

        var GRPOWise = [];
        var ItemData = [];
        var GrpoData = []; // Store GRPO data

        @*// Function to load GRPOWise
        function loadDocNum(id) {
            // AJAX call to get GRPOWise
            $.ajax({
                url: '@Url.Action("GETGRPONUM", "Inventory")',
                method: 'GET',
                data:{id:id},
                success: function (response) {
                    if(response[0].Success=="true"){
                        $("#Docnum").val(response[0].Message)
                    }else{
                           Notify('error', response[0].Message,'');
                    }
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }*@

        function loadItemMasterTable() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GETITEMLIST", "Master")',
                contentType: "application/json; charset=utf-8",
                cache: false,
                success: function (data) {
                    console.log(data)
                    ItemData = data || [];
                },
                error: function(xhr) {
                    Notify('error', 'Error', xhr.responseText || 'Error loading items');
                }
            });
        }

        @*function loadGrpoData() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("FINDMODE", "Purchase")',
                contentType: "application/json; charset=utf-8",
                cache: false,
                success: function(data) {
                    GrpoData = data || [];
                },
                error: function(xhr) {
                    console.error("Error loading GRPO data:", xhr);
                    Notify('error', 'Error', xhr.responseText || 'Error loading GRPO data');
                }
            });
        }*@





        // Initialize on page load
        loadItemMasterTable();


        // ==================== GRPO NUMBER AUTOCOMPLETE ====================



             loadEmployeeDropdown()
             function loadEmployeeDropdown() {
                 $.ajax({
                     url: '@Url.Action("GETEMPLOYEEDROPDOWN", "Inventory")',
                     type: 'GET',
                     success: function (response) {
                         GrpoSalesEmployeeData = Array.isArray(response) ? response : [];

                         const $ddl = $("#itemSalesEmployee,#boxSalesEmployee");
                         $ddl.empty().append('<option value="">Select Employee</option>');

                         response.forEach(function (emp) {
                             $ddl.append(`
                                 <option value="${emp.EmployeeID}" data-code="${emp.EmployeeCode}">
                                     ${emp.FirstName} ${emp.LastName}
                                 </option>
                             `);
                         });
                     },
                     error: function (xhr) {
                         Notify('error', 'Error', xhr.responseText);
                     }
                 });
        }

        // 🔹 Input typing
        $(document).on('input', '.GrpoSalesEmployee', function () {

            const $input = $(this);
            $activeGrpoSalesEmployeeInput = $input;

            const search = $input.val().toLowerCase();
            const rowIndex = $input.closest('tr').index();
            const suggestionId = 'GrpoSalesEmployeeSuggestions-' + rowIndex;

            if (!$('#' + suggestionId).length) {
                $('<div>', {
                    id: suggestionId,
                    class: 'GrpoSalesEmployee-suggestions'
                }).appendTo('body');
            }

            const $container = $('#' + suggestionId).empty();

            if (!search || GrpoSalesEmployeeData.length === 0) {
                $container.hide();
                return;
            }

            // 🔍 Search by Code, FirstName, LastName
            const matches = GrpoSalesEmployeeData.filter(emp => {
                const fullName = `${emp.FirstName} ${emp.LastName}`.toLowerCase();
                return (

                    emp.EmployeeCode.toLowerCase().includes(search) ||
                    emp.EmployeeID.toLowerCase().includes(search) ||
                    emp.FirstName.toLowerCase().includes(search) ||
                    emp.LastName.toLowerCase().includes(search) ||
                    fullName.includes(search)
                );
            }).slice(0, 10);

            if (matches.length === 0) {
                $container.hide();
                return;
            }

            // 📌 Build suggestion list
            matches.forEach(emp => {
                const fullName = `${emp.FirstName} ${emp.LastName}`;
                const EmpID = `${emp.EmployeeID}`
                $container.append(`
            <div class="GrpoSalesEmployee-item"
                data-code="${emp.EmployeeCode}"
                data-empid="${emp.EmployeeID.toString()}"
                data-name="${fullName}">
                <strong>${emp.EmployeeCode}</strong> - ${fullName}
            </div>
        `);
            });

            const offset = $input.offset();
            $container.css({
                top: offset.top + $input.outerHeight(),
                left: offset.left,
                width: $input.outerWidth(),
                position: 'absolute',
                zIndex: 1050
            }).show();
        });


        // 🔹 Click suggestion → bind to same row
        $(document).on('click', '.GrpoSalesEmployee-item', function () {

            const empName = $(this).data('name');      // John Doe
            const empCode = $(this).data('code');      // EMP001
            const empId = $(this).data('empid');     // 123

            if (!$activeGrpoSalesEmployeeInput) return;

            // ✅ Show name/code in input
            $activeGrpoSalesEmployeeInput
                .val(empName)
                .attr('data-empid', empId.toString())   // ⭐ STORE EmployeeID HERE
                .attr('data-code', empCode); // optional

            // Hide suggestions
            $('.GrpoSalesEmployee-suggestions').hide();
        });


        // 🔹 Hide on outside click
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.GrpoSalesEmployee, .GrpoSalesEmployee-suggestions').length) {
                $('.GrpoSalesEmployee-suggestions').hide();
            }
        });








             $(document).on('input', "#grpoNumber", function () {

                var $input = $(this);
                var value = $input.val().toLowerCase().replace(/_/g, ' ');
                var suggestions = [];

                // Unique container ID for GRPO Number
                var suggestionContainerId = 'GrpoNumberSuggestions';
                if (!$('#' + suggestionContainerId).length) {
                    $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
                }

                var $suggestionContainer = $('#' + suggestionContainerId);
                $suggestionContainer.empty();

                if (Array.isArray(GrpoData) && GrpoData.length > 0) {
                    if (value.length > 0) {
                        var searchTokens = value.split(/\s+/);
                        suggestions = GrpoData.filter(function (data) {
                            if (data && typeof data === 'object') {
                                // Adjust these property names based on your actual GRPO data structure
                                var grpoNumber = (data.GRPONumber || data.DocNum || data.Number || data.DocEntry || '').toString().toLowerCase();
                                var vendor = (data.VendorName || data.CardName || data.SupplierName || '').toString().toLowerCase();
                                var allTokens = grpoNumber.split(/\s+|[_-]+/).concat(vendor.split(/\s+|[_-]+/));

                                return searchTokens.every(function (token) {
                                    return allTokens.some(function (grpoToken) {
                                        return grpoToken.includes(token);
                                    });
                                });
                            }
                            return false;
                        }).sort(function (a, b) {
                            // Sort by GRPO number or date - adjust based on your data structure
                            var aNum = a.GRPONumber || a.DocNum || a.DocEntry || '';
                            var bNum = b.GRPONumber || b.DocNum || b.DocEntry || '';
                            return bNum.toString().localeCompare(aNum.toString());
                        }).slice(0, 50);
                    }

                    if (suggestions.length > 0) {
                        suggestions.forEach(function (data) {
                            // Adjust these property names based on your actual GRPO data structure
                            var grpoNumber = data.GRPONumber || data.DocNum || data.Number || data.DocEntry || 'N/A';
                            var vendor = data.VendorName || data.CardName || data.SupplierName || 'N/A';
                            var date = data.DocDate || data.Date || data.CreateDate || '';
                            var grpoId = data.GRPOId || data.DocEntry || data.Id || '';

                            $suggestionContainer.append(
                                `<div class="suggestion-item grpo-number-set"
                                      data-grponumber="${grpoNumber}"
                                      data-vendor="${vendor}"
                                      data-date="${date}"
                                      data-grpoid="${grpoId}">
                                     <span class="grpo-number"><b>GRPO: ${grpoNumber}</b></span><br/>
                                     <small class="text-muted">Vendor: ${vendor}</small>
                                     ${date ? `<br/><small class="text-muted">Date: ${formatDate(date)}</small>` : ''}
                                 </div>`
                            );
                        });

                        var offset = $input.offset();
                        $suggestionContainer.css({
                            top: offset.top + $input.outerHeight(),
                            left: offset.left,
                            width: $input.outerWidth(),
                            position: 'absolute',
                            "z-index": 1000,
                            "max-height": "300px",
                            "overflow-y": "auto"
                        }).show();
                    } else {
                        $suggestionContainer.hide();
                    }
                } else {
                    $suggestionContainer.hide();
                }
            });


            // GRPO Number Click handler - Load GRPO items
            $(document).on('click', '.grpo-number-set', function () {
                var grpoNumber = $(this).data('grponumber');
                var vendor = $(this).data('vendor');
                var grpoId = $(this).data('grpoid');

                // Set the GRPO number
                $("#grpoNumber").val(grpoNumber);
                $("#grpoNumber").attr("data-grpo-id", grpoId);

                // Hide suggestions
                $("#GrpoNumberSuggestions").hide();

                // Load GRPO items
                loadGrpoItems(grpoId, grpoNumber);
            });

            // Hide GRPO suggestions when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.suggestions-container, #grpoNumber').length) {
                    $('#GrpoNumberSuggestions').hide();
                }
            });

            // Format date for display
            function formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    return date.toLocaleDateString();
                } catch (e) {
                    return dateString;
                }
        }
                // Load GRPO items when GRPO number changes
        $("#grpoNumber").on("input", function () {
            LoadGrpoNumber($(this).val());   // ❌ called first
            if ($("#grpoNumber").val().trim() === "") {
                $("#grpoTbody").html("");
                return;
            }
        });

        function LoadGrpoNumber(DocNum) {

         $.ajax({
             url: '@Url.Action("GETGRPOITEM","Inventory")',
             method: 'GET',
             data: { DocNum: DocNum },
             success: function (response) {
                 console.log(response);
                 $("#grpoTbody").empty();

                 if (response && response.length > 0) {
                     // Populate table with GRPO items
                     response.forEach(function (item, index) {
                         var row = `
                         <tr>
                             <td class="text-center">
                                 <input type="checkbox" class="row-checkbox">
                             </td>
                             <td>
                                 <input class="form-control form-control-sm item-code-input"
                                        value="${item.ItemCode || ''}"
                                        placeholder="Item code" readonly>
                             </td>
                             <td>
                                 <input class="form-control form-control-sm item-name-input"
                                        value="${item.ItemName || ''}"
                                        placeholder="Item name" readonly>
                             </td>
                             <td>
                                 <input class="form-control form-control-sm group-qty-input"
                                        type="number"
                                        value="${item.Quantity || 1}"
                                        min="1">
                             </td>
                              <td>
                              <input type="text"  class="form-control form-control-sm GrpoSalesEmployee   ">
                              </td>
                         </tr>`;
                         $("#grpoTbody").append(row);
                     });

                     Notify('success', 'Success', `Loaded ${response.length} items from GRPO: ${DocNum}`);
                 } else {
                     // If no data returned, show empty table
                     $("#grpoTbody").html('<tr><td colspan="5" class="text-center">No items found for this GRPO</td></tr>');
                     Notify('warning', 'No Data', `No items found for GRPO: ${DocNum}`);
                 }
             },
             error: function(xhr) {
                 console.error("Error loading GRPO items:", xhr);
                 //Notify('error', 'Error', xhr.responseText || 'Error loading GRPO items');
             }
         });
        }




        // ==================== ITEM WISE TAB - SEPARATED AUTOCOMPLETE ====================
        var $activeInput = null;
        $(document).on('input', "#txtItemCode,#txtItemName", function () {

            var $input = $(this);
            $activeInput = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Unique container ID for ITEM Wise tab
            var suggestionContainerId = 'ItemWiseSuggestions';
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty();

            if (Array.isArray(ItemData) && ItemData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    suggestions = ItemData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ItemCode || '').toLowerCase();
                            var name = (data.ItemName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.ItemName.localeCompare(b.ItemName);
                    }).slice(0, 50);
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item item-wise-set" data-code="${data.ItemCode || ''}" data-id="${data.ItemID || ''}" data-name="${data.ItemName || ''}">
                                 <span class="item-code"><b>${data.ItemCode || ''}</b></span> -
                                 <span class="item-name"><b>${data.ItemName || ''}</b></span>
                             </div>`
                        );
                    });

                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("Item Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });



        // ITEM Wise Tab - Click handler
        $(document).on('click', '.item-wise-set', function () {
            var selectedCode = $(this).data('code');
            var selectedName = $(this).data('name');
            var id = $(this).data('id');

            // Only update ITEM Wise tab fields
            $("#txtItemCode").val(selectedCode);
            $("#txtItemName").val(selectedName);
            $("#txtItemCode").attr("data-id", id);
            $("#DocumentEntry").val(id);

            // Hide only ITEM Wise suggestions
            $("#ItemWiseSuggestions").hide();
        });

        // ==================== BOX WISE TAB - SEPARATED AUTOCOMPLETE ====================
        var $activeInputbox = null;
        $(document).on('input', "#boxTabCode,#boxTabName", function () {

            var $input = $(this);
            $activeInputbox = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Unique container ID for BOX Wise tab
            var suggestionContainerId = 'BoxWiseSuggestions';
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty();

            if (Array.isArray(ItemData) && ItemData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    suggestions = ItemData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ItemCode || '').toLowerCase();
                            var name = (data.ItemName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.ItemName.localeCompare(b.ItemName);
                    }).slice(0, 50);
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item box-wise-set" data-code="${data.ItemCode || ''}" data-id="${data.ItemID || ''}" data-name="${data.ItemName || ''}">
                                 <span class="item-code"><b>${data.ItemCode || ''}</b></span> -
                                 <span class="item-name"><b>${data.ItemName || ''}</b></span>
                             </div>`
                        );
                    });

                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("Item Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });


        // BOX Wise Tab - Click handler
        $(document).on('click', '.box-wise-set', function () {
            var selectedCode = $(this).data('code');
            var selectedName = $(this).data('name');
            var id = $(this).data('id');

            // Only update BOX Wise tab fields
            $("#boxTabCode").val(selectedCode);
            $("#boxTabName").val(selectedName);
            $("#boxTabCode").attr("data-id", id);
            $("#DocumentEntry").val(id);

            // Hide only BOX Wise suggestions
            $("#BoxWiseSuggestions").hide();
        });

        // Hide suggestions when clicking outside - Updated to handle all containers
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.suggestions-container, #txtItemCode, #txtItemName, #boxTabCode, #boxTabName, #grpoNumber').length) {
                $('#ItemWiseSuggestions, #BoxWiseSuggestions, #GrpoNumberSuggestions').hide();
            }
        });

        // Select All functionality
        $('#selectAll').on('change', function () {
            $('.row-checkbox').prop('checked', this.checked);
        });

        // ----------------------- ON TAB SHOW -----------------------
        $('#modeTabs button').on('shown.bs.tab', function (e) {
            if (e.target.id === "grpo-tab") {

            }
        });

        // ----------------------- RESET FUNCTIONALITY -----------------------
        $("#btnReset").on("click", function () {
            let activeTab = $(".tab-pane.active").attr("id");

            switch (activeTab) {
                case "grpo":
                    $("#grpoNumber").val("");
                    $("#grpoTbody").empty();
                    Notify('success', 'Reset', 'GRPO tab has been reset');
                    break;
                case "item":
                    $('#txtItemCode').val("");
                    $('#txtItemName').val("");
                    $('#itemSalesEmployee').prop("selectedIndex", 0);
                    $('#itemCopies').val("1");
                    Notify('success', 'Reset', 'ITEM tab has been reset');
                    break;
                case "box":
                    $('#boxTabCode').val("");
                    $('#boxTabName').val("");
                    $('#boxSalesEmployee').prop("selectedIndex", 0);
                    $('#boxCopies').val("1");
                    $('#boxQuantity').val("1");
                    Notify('success', 'Reset', 'BOX tab has been reset');
                    break;
            }
        });

        // ==================== QR CODE GENERATION FUNCTIONS ====================

        //Genratye Qr Code For Grpo Tab
            {
                $('.generate-btn').on('click', function () {

                    const grpoNumber = $('#grpoNumber').val();
                    if (!grpoNumber) {
                        Notify('warning', 'Warning', 'Please enter GRPO number');
                        return;
                    }

                    const selectedRows = $('#grpoTbody .row-checkbox:checked');
                    if (selectedRows.length === 0) {
                        Notify('warning', 'Warning', 'Please select at least one item');
                        return;
                    }

                    const itemsToPrint = [];

                    selectedRows.each(function () {
                        const $row = $(this).closest('tr');

                        itemsToPrint.push({
                            itemCode: $row.find('.item-code-input').val(),
                            itemName: $row.find('.item-name-input').val(),
                            groupQty: parseInt($row.find('.group-qty-input').val()) || 1,
                            salesEmployee: $row.find('.sales-employee-input').val() || '',
                            salesEmployeeID: $row.find('.sales-employee-input').attr('data-id') || '',
                            grpoNumber: grpoNumber
                        });
                    });

                    generateQRCodes(itemsToPrint);
                });
                function generateQRCodes(data) {

                    if (!data || data.length === 0) {
                        Swal.fire('Please Select Rows In Table', '', 'warning');
                        return;
                    }

                    function formatText(text, maxLength = 17) {
                        text = text.replace(/_/g, ' ');
                        const words = text.split(' ');
                        let result = '';
                        let line = '';

                        for (let word of words) {
                            if ((line + ' ' + word).trim().length <= maxLength) {
                                line += (line ? ' ' : '') + word;
                            } else {
                                result += line + '<br>';
                                line = word;
                            }
                        }
                        return (result + line).trim();
                    }

                    const tempContainer = document.createElement('div');
                    tempContainer.style.display = 'none';
                    document.body.appendChild(tempContainer);

                    const htmlFragments = [];
                    const qrPromises = [];

                    data.forEach((item, i) => {

                        const qty = parseInt(item.groupQty);
                        const description = formatText(item.itemName);

                        for (let j = 0; j < qty; j++) {

                            qrPromises.push(new Promise((resolve) => {

                                const qrDiv = document.createElement('div');
                                tempContainer.appendChild(qrDiv);

                                new QRCode(qrDiv, {
                                    text: item.itemCode,          // ✅ FIXED
                                    width: 48,
                                    height: 48,
                                    correctLevel: QRCode.CorrectLevel.H
                                });

                                const checker = setInterval(() => {
                                    if (qrDiv.querySelector('canvas, img')) {
                                        clearInterval(checker);

                                        htmlFragments.push(`
    <div class="Main">
    <div class="Discripiton_sec">
    <div class="Discriptiontext">${description}</div>
    </div>
    <div class="Qrcode_sec">
    <div class="Bulkqrcode">
                                            ${qrDiv.innerHTML}
    <div class="ItemCodelable">${item.itemCode}</div>
    <div class="Slplable">S.(${item.salesEmployeeID})</div>
    </div>
    </div>
    </div>
                            `);

                                        resolve();
                                    }
                                }, 10);

                            }));
                        }
                    });

                    Promise.all(qrPromises).then(() => {
                        document.body.removeChild(tempContainer);
                        const printHTML = `
    <style>
                    @@page {
                        size: 50mm 25mm;
                        margin: 0;
                    }

                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }

                    .Main {
                        width: 50mm;
                        height: 25mm;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 4px;
                        box-sizing: border-box;
                        page-break-after: always;
                    }

                    .Discripiton_sec {
                        width: 65%;
                        font-size: 11px;
                        font-weight: bold;
                        line-height: 1.2;
                    }

                    .Qrcode_sec {
                        width: 35%;
                        text-align: center;
                    }

                    .ItemCodelable {
                        font-size: 12px;
                        font-weight: bold;
                        margin-top: 2px;
                    }

                    .Slplable {
                        font-size: 8px;
                        font-weight: bold;
                    }
    </style>
                ${htmlFragments.join('')}
            `;

                        const printWindow = window.open('', '', 'width=800,height=600');
                        printWindow.document.open();
                        printWindow.document.write(printHTML);
                        printWindow.document.close();

                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    });
                }

            }

        // Generate QR Code for ITEM tab
            {
                $("#generateItemQR").click(function () {

                    var ItemCode1 = $("#txtItemCode").val();
                    var descrio = $("#txtItemName").val();
                    var Copies = $("#itemCopies").val();
                    var QRSalesEmp1 = $("#itemSalesEmployee").val();
                    var QRSalesEmpName1 = $("#itemSalesEmployee option:selected").text();

                    if (!ItemCode1) {
                        alert("Please provide an Item Code.");
                        return;
                    }
                    else if (QRSalesEmp1 === "-1") {
                        Swal.fire(
                            "Please select a Sales Employee for Item No " + ItemCode1,
                            "",
                            "warning"
                        );
                        return;
                    }

                    try {



                        var tempDiv = document.createElement("div");

                        var qrCode = new QRCode(tempDiv, {
                            text: ItemCode1,
                            width: 48,
                            height: 48,
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        setTimeout(function () {

                            var qrCodeHTML = tempDiv.innerHTML;
                            var printhtml = "";

                            for (var i = 0; i < Copies; i++) {

                                var printhtml = "";
                                // Prepare the Print HTML
                                for (var i = 0; i < Copies; i++) {
                                    printhtml += `

            <style>
                                            /* Page size for 50mm x 25mm */
                                                @@page {
                                                    size: 50mm 25mm;
                                                    margin: 0; /* Remove margins */
                                                }
                                                @@media print {
                                                    body {
                                                          margin: 0;
                                                          padding: 0;
                                                          width: 50mm;
                                                          height: 25mm;
                                                          font-family: Arial, sans-serif;
                                                      }
                                                      .Main {
                                                          display: flex;
                                                          align-items: center;
                                                          justify-content: space-between;
                                                          width: 100%;
                                                          height: 100%;
                                                          box-sizing: border-box;
                                                          padding: 5px;
                                                          margin: 0;
                                                      }
                                                      .Qrcode_sec {
                                                          width: 30%; /* Adjusted to fit */
                                                          height: 100%;
                                                          display: flex;
                                                          align-items: center;
                                                          justify-content: center;
                                                      }
                                                      .Bulkqrcode{
                                                          text-align:right;
                                                      }
                                                      .Discripiton_sec {
                                                          width: 70%; /* Adjusted to fit */
                                                          height: 100%;
                                                          display: flex;
                                                          flex-direction: column;
                                                          justify-content: center;
                                                          padding: 0 5px;
                                                          text-align:left;
                                                          box-sizing: border-box;
                                                      }
                                                      .Discriptiontext {
                                                          width: 100%; /* Adjusted to fit */
                                                          height: 100%;
                                                          font-size: 12px; /* Adjust font size to fit content */
                                                          font-weight: bold;
                                                          line-height: 1.2;

                                                      }
                                                      .ItemCodelable {
                                                          font-size: 11px; /* Adjust font size */
                                                          font-weight: bold;
                                                          margin: 0;
                                                          padding: 0;
                                                          margin-top: -10px;
                                                      }
                                                      .Slplable {
                                                          font-size: 8px; /* Adjust font size */
                                                          font-weight: bold;
                                                          margin: 0;
                                                          padding: 0;
                                                          margin-top: 0px;
                                                      }
                                                }

                                        </style>

            <div class="p-1 Main">
            <div class="Discripiton_sec">
            <div class="Discriptiontext"><br>${lineBreakAfter2UnderscoreAndSpace(descrio)}</div>
            </div>
            <div class="Qrcode_sec">
            <div class="Bulkqrcode QRCode">
                                                ${qrCodeHTML}<br>
            <h6 class="ItemCodelable">${ItemCode1}</h6>
            <h6 class="Slplable">S.(${QRSalesEmp1})</h6>
            </div>
            </div>
            </div>

                                `;

                            }
                            }

                            var printWindow = window.open("", "", "width=1000,height=1000");

                            printWindow.document.open();
                            printWindow.document.write(printhtml);
                            printWindow.document.close();

                            printWindow.print();
                            printWindow.close();

                            var data = [
                                {
                                    ItemCode: ItemCode1,
                                    DisCription: descrio,
                                    PRINTQTY: Copies,
                                    GRPOQTY: "0",
                                    DocEntry: "0",
                                    DocNum: "0",
                                    UserId: sessionStorage.getItem("UserID"),
                                    SaleEmpId: QRSalesEmp1,
                                    SaleEmpName: QRSalesEmpName1
                                }
                            ];

                            printWindow.addEventListener("unload", () => {
                                $.ajax({
                                    type: "POST",
                                    url: '@Url.Action("ADDBARCODEPRINTLOG","Inventory")',
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(data),
                                    cache: true,
                                    success: function () {},
                                    error: function (xhr) {
                                        $("#error").text(xhr.responseJSON.error);
                                    }
                                });
                            });

                        }, 500);

                    } catch (error) {
                        console.error("Printing error:", error);
                    }
                });

                $("#printQrButton").click(function () {
                    var printWindow = window.open("", "", "width=1000,height=1000");
                    var contentToPrint = $("#printContainer").html();

                    printWindow.document.open();
                    printWindow.document.write(contentToPrint);
                    printWindow.document.close();

                    printWindow.print();
                    printWindow.close();
                });
        }

        // Generate Barcode for Box Wise
             {
               $('#generateBoxBarcode').click(function () {
                   const barcodeData = $('#boxTabCode').val();
                   const Quantity = parseInt($('#boxQuantity').val());
                   const Copies = parseInt($('#boxCopies').val());
                   const QRItemName1 = $('#boxTabName').val();
                   var QRSalesEmp2 = $("#boxSalesEmployee").val();
                   var QRSalesEmpName2 = $("#boxSalesEmployee option:selected").text();
                         const description = lineBreakAfter2UnderscoreAndSpace(QRItemName1);
                         if (!barcodeData || isNaN(Quantity) || isNaN(Copies) || !QRItemName1) {
                             alert("Please provide valid input values.");
                             return;
                         }
                         else if (QRSalesEmp2 == "-1") {
                             Swal.fire("Please select a Sales Employee for Item No " + barcodeData, "", "warning");
                             return;
                         }
                         const htmlFragments = [];
                         const BarcodePromises = [];
                         const tempContainer = document.createElement("div");
                         tempContainer.style.display = "none"; // Hidden container
                         document.body.appendChild(tempContainer);
                         //if (Quantity > 100) {
                         //    Swal.fire("Only 100 Copies Are Allow..!","","")
                         //    return false
                         //}
                         for (let j = 0; j < Copies; j++) {
                             const BarcodeString = `${barcodeData}_${Quantity}`;
                             BarcodePromises.push(
                                 new Promise((resolve) => {
                                     const Barcode = document.createElement("svg");
                                     tempContainer.appendChild(Barcode);
                                     JsBarcode(Barcode, BarcodeString, {
                                         format: "CODE128", // Barcode format
                                         lineColor: "#000", // Barcode color
                                         width: 1,          // Width of each bar
                                         height: 20,       // Height of the barcode
                                         displayValue: true, // Show the text below the barcode
                                         fontSize: 11
                                     });

                                     // Wait for barcode to render
                                     setTimeout(() => {
                                         const svgHTML = Barcode.outerHTML; // Get generated SVG HTML
                                            htmlFragments.push(`
                                               <div class="Main">
                                               <div class="Description_sec">
                                               <div class="DescriptionText">
                                                                                       ${description}
                                               </div>
                                               </div>
                                               <div class="Barcode_sec">
                                                                                      ${svgHTML}</br>
                                               </div>
                                               <div class="slplable">
                                               <small class=""> S.(${QRSalesEmp2})</small>
                                               </div>
                                               </div>
                                            `);
                                         resolve();
                                     }, 100);
                                 })
                             );
                         }
                         Promise.all(BarcodePromises).then(() => {
                             document.body.removeChild(tempContainer);
                                const printhtml = `

                                   <style type="text/css">
                                                             @@page {
                                                                 size: 50mm 25mm;
                                                                 margin: 0;
                                                             }
                                                             @@media print {
                                                                 body {
                                                                     margin: 0;
                                                                     padding: 0;
                                                                     width: 50mm;
                                                                     height: 25mm;
                                                                     font-family: Arial, sans-serif;
                                                                 }
                                                                 .Main {
                                                                     display: flex;
                                                                     flex-direction: column;

                                                                     width: 100%;
                                                                     height: 100%;
                                                                     box-sizing: border-box;
                                                                     padding: 5px;
                                                                     margin: 0;
                                                                 }
                                                                 .Barcode_sec {
                                                                     width: 100%;
                                                                     text-align: center;
                                                                      padding: 0;
                                                                      margin: 0;

                                                                 }
                                                                 .Description_sec {
                                                                     width: 100%;
                                                                     text-align: center;
                                                                     font-size: 8px;
                                                                 }
                                                                 .DescriptionText {
                                                                     font-size: 8px!important;
                                                                     font-weight:bolder;
                                                                 }
                                                                 .slplable {
                                                                     font-size:9px!important;
                                                                     font-weight:bolder;
                                                                     text-align:center
                                                                 }
                                                             }
                                   </style>

                                                         ${htmlFragments.join('')}

                                 `;

                             const printWindow = window.open("", "", "width=1000,height=1000");
                             printWindow.document.open();
                             printWindow.document.write(printhtml);
                             printWindow.document.close();
                             printWindow.print();
                             printWindow.close();
                             var data = [
                                 {
                                 ItemCode: barcodeData,
                                 DisCription: QRItemName1,
                                 PRINTQTY: Copies, // Use jQuery to find the input element
                                 GRPOQTY: "0",
                                 DocEntry: "0",
                                 DocNum: "0",
                                 UserId: sessionStorage.getItem("UserID"),
                                 SaleEmpId: QRSalesEmp2,
                                 SaleEmpName: QRSalesEmpName2,
                              }];
                                 printWindow.addEventListener("unload", () => {
                                 $.ajax({
                                      type: "POST",
                                      url: '@Url.Action("ADDBARCODEPRINTLOG","Inventory")',
                                      contentType: "application/json; charset=utf-8",
                                      data: JSON.stringify(data),
                                      cache: true,
                                      success: function (data) {

                                      },
                                      error: function (xhr, status, error) {
                                          // handle error here
                                          var errorMessage = xhr.responseJSON.error;
                                          $("#error").text(errorMessage);
                                      }
                                  });
                             });
                         }).catch((error) => {
                             console.error("Error generating barcodes:", error);
                         });
               });
             }


        function lineBreakAfter2UnderscoreAndSpace(text, maxLength = 17) {
            text = text.replace(/_/g, ' ');
            const words = text.split(' ');
            let result = '';
            let line = '';

            for (let word of words) {
                if ((line + ' ' + word).trim().length <= maxLength) {
                    line += (line ? ' ' : '') + word;
                } else {
                    result += line + '\n';
                    line = word;
                }
            }

            if (line) {
                result += line;
            }

            return result.trim();
        }






    });
    </script>
}