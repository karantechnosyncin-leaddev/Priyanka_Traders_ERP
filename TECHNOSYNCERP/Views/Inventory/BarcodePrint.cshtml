@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<!-- QR Code CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b> <i class="bi bi-upc-scan me-2"></i>BarCode Printing</b></h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <!-- Left Section (Details) -->
                    <div class="col-12 col-md-7 mb-3">

                    </div>
                    <!-- Right Section (Buttons) -->
                    <div class="col-12 col-md-5 text-end justify-content-md-end justify-content-start flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-2 me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary w-100" role="alert">
                                No actions available
                            </div>
                        }
                    </div>
                    <div class="container-fluid">
                        <div class="app-card">
                            <div class="p-3 p-sm-">
                                <!-- Tabs -->
                                <ul class="nav nav-tabs" id="modeTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="grpo-tab" data-bs-toggle="tab" data-bs-target="#grpo" type="button" role="tab">GRPO Wise</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="item-tab" data-bs-toggle="tab" data-bs-target="#item" type="button" role="tab">ITEM Wise</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="box-tab" data-bs-toggle="tab" data-bs-target="#box" type="button" role="tab">BOX Wise</button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3">
                                    <!-- GRPO -->
                                    <div class="tab-pane fade show active" id="grpo" role="tabpanel">
                                        <div class="row align-items-center mb-3">
                                            <div class="col-md-5 col-sm-12 mb-2">
                                                <label class="form-label">GRPO Number :</label>
                                                <input class="form-control" id="grpoNumber" placeholder="Enter GRPO number">
                                            </div>
                                            <div class="col-md-3 col-sm-12 text-md-center mb-2">
                                                <button class="btn btn-danger generate-btn mt-4">Generate QR Code</button>
                                            </div>
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width:40px"><input type="checkbox" id="selectAll"></th>
                                                        <th>Item Code</th>
                                                        <th>Item Name</th>
                                                        <th>Group Qty</th>
                                                        <th>Sales Employee</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="grpoTbody">
                                                    <!-- sample empty row -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ITEM -->
                                    <div class="tab-pane fade" id="item" role="tabpanel">
                                        <form class="row g-3 align-items-end">
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Item Code :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item code" id="txtItemCode">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label">Item Name :</label>
                                                <input class="form-control item-name-input" placeholder="Enter item name" id="txtItemName">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label" for="itemSalesEmployee">Sales Employee :</label>
                                                <select class="form-select" id="itemSalesEmployee"><option>-No Sales Employee-</option></select>
                                            </div>
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Copies :</label>
                                                <input class="form-control" id="itemCopies" value="1">
                                            </div>
                                            <div class="col-md-2 col-sm-12 text-end">
                                                <button type="button" class="btn btn-primary mt-2" id="generateItemQR">Generate QR Code</button>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- BOX -->
                                    <div class="tab-pane fade" id="box" role="tabpanel">
                                        <form class="row g-3 align-items-end">
                                            <div class="col-md-2 col-sm-6">
                                                <label class="form-label">Item Code :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item code" id="boxTabCode">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label">Item Name :</label>
                                                <input class="form-control item-code-input" placeholder="Enter item name" id="boxTabName">
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <label class="form-label">Sales Employee :</label>
                                                <select class="form-select" id="boxSalesEmployee"><option>-No Sales Employee-</option></select>
                                            </div>
                                            <div class="col-md-1 col-sm-6">
                                                <label class="form-label">Copies :</label>
                                                <input class="form-control" id="boxCopies" value="1">
                                            </div>
                                            <div class="col-md-1 col-sm-6">
                                                <label class="form-label">Quantity :</label>
                                                <input class="form-control" id="boxQuantity" value="1">
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <button type="button" class="btn btn-primary mt-2" id="generateBoxBarcode">Generate Barcode</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Print Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">QR Codes for Printing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qrCodeContainer" class="qr-code-container">
                    <!-- QR codes will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printQRCodes">Print</button>
            </div>
        </div>
    </div>
</div>

<style>
    .suggestions-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
    }

    .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

    .item-code, .grpo-number {
        color: #007bff;
    }

    .text-muted {
        color: #6c757d !important;
    }

    /* QR Code Styles */
    .qr-code-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        padding: 20px;
    }

    .qr-code-item {
        width: 90mm;
        height: 25mm;
        border: 1px solid #ddd;
        padding: 5px;
        text-align: center;
        page-break-inside: avoid;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .qr-code-image {
        max-width: 100%;
        max-height: 70%;
        object-fit: contain;
    }

    .qr-code-text {
        font-size: 10px;
        margin-top: 2px;
        word-break: break-all;
        text-align: center;
    }

    /* Print Styles */
    @@media print {
        body * {
            visibility: hidden;
        }

        .qr-code-container, .qr-code-container * {
            visibility: visible;
        }

        .qr-code-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        .modal-footer, .modal-header {
            display: none !important;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    $(document).ready(function () {

        var GRPOWise = [];
        var ItemData = [];
        var GrpoData = []; // Store GRPO data

        // Function to load GRPOWise
        function loadDocNum(id) {
            // AJAX call to get GRPOWise
            $.ajax({
                url: '@Url.Action("GETGRPONUM", "Inventory")',
                method: 'GET',
                data:{id:id},
                success: function (response) {
                    if(response[0].Success=="true"){
                        $("#Docnum").val(response[0].Message)
                    }else{
                           Notify('error', response[0].Message,'');
                    }
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }

        function loadItemMasterTable() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GETITEMLIST", "Master")',
                contentType: "application/json; charset=utf-8",
                cache: false,
                success: function(data) {
                    ItemData = data || [];
                },
                error: function(xhr) {
                    Notify('error', 'Error', xhr.responseText || 'Error loading items');
                }
            });
        }

        function loadGrpoData() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("FINDMODE", "Purchase")',
                contentType: "application/json; charset=utf-8",
                cache: false,
                success: function(data) {
                    GrpoData = data || [];
                },
                error: function(xhr) {
                    console.error("Error loading GRPO data:", xhr);
                    Notify('error', 'Error', xhr.responseText || 'Error loading GRPO data');
                }
            });
        }

        // Initialize on page load
        loadItemMasterTable();
        loadGrpoData();

        // ==================== GRPO NUMBER AUTOCOMPLETE ====================
        $(document).on('input', "#grpoNumber", function () {
            var $input = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Unique container ID for GRPO Number
            var suggestionContainerId = 'GrpoNumberSuggestions';
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty();

            if (Array.isArray(GrpoData) && GrpoData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    suggestions = GrpoData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            // Adjust these property names based on your actual GRPO data structure
                            var grpoNumber = (data.GRPONumber || data.DocNum || data.Number || data.DocEntry || '').toString().toLowerCase();
                            var vendor = (data.VendorName || data.CardName || data.SupplierName || '').toString().toLowerCase();
                            var allTokens = grpoNumber.split(/\s+|[_-]+/).concat(vendor.split(/\s+|[_-]+/));

                            return searchTokens.every(function (token) {
                                return allTokens.some(function (grpoToken) {
                                    return grpoToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        // Sort by GRPO number or date - adjust based on your data structure
                        var aNum = a.GRPONumber || a.DocNum || a.DocEntry || '';
                        var bNum = b.GRPONumber || b.DocNum || b.DocEntry || '';
                        return bNum.toString().localeCompare(aNum.toString());
                    }).slice(0, 50);
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        // Adjust these property names based on your actual GRPO data structure
                        var grpoNumber = data.GRPONumber || data.DocNum || data.Number || data.DocEntry || 'N/A';
                        var vendor = data.VendorName || data.CardName || data.SupplierName || 'N/A';
                        var date = data.DocDate || data.Date || data.CreateDate || '';
                        var grpoId = data.GRPOId || data.DocEntry || data.Id || '';

                        $suggestionContainer.append(
                            `<div class="suggestion-item grpo-number-set"
                                  data-grponumber="${grpoNumber}"
                                  data-vendor="${vendor}"
                                  data-date="${date}"
                                  data-grpoid="${grpoId}">
                                 <span class="grpo-number"><b>GRPO: ${grpoNumber}</b></span><br/>
                                 <small class="text-muted">Vendor: ${vendor}</small>
                                 ${date ? `<br/><small class="text-muted">Date: ${formatDate(date)}</small>` : ''}
                             </div>`
                        );
                    });

                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                        "max-height": "300px",
                        "overflow-y": "auto"
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                $suggestionContainer.hide();
            }
        });

        // GRPO Number Click handler - Load GRPO items
        $(document).on('click', '.grpo-number-set', function () {
            var grpoNumber = $(this).data('grponumber');
            var vendor = $(this).data('vendor');
            var grpoId = $(this).data('grpoid');

            // Set the GRPO number
            $("#grpoNumber").val(grpoNumber);
            $("#grpoNumber").attr("data-grpo-id", grpoId);

            // Hide suggestions
            $("#GrpoNumberSuggestions").hide();

            // Load GRPO items
            loadGrpoItems(grpoId, grpoNumber);
        });

        // Hide GRPO suggestions when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.suggestions-container, #grpoNumber').length) {
                $('#GrpoNumberSuggestions').hide();
            }
        });

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString();
            } catch (e) {
                return dateString;
            }
        }

        // ==================== ITEM WISE TAB - SEPARATED AUTOCOMPLETE ====================
        var $activeInput = null;
        $(document).on('input', "#txtItemCode,#txtItemName", function () {
            var $input = $(this);
            $activeInput = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Unique container ID for ITEM Wise tab
            var suggestionContainerId = 'ItemWiseSuggestions';
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty();

            if (Array.isArray(ItemData) && ItemData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    suggestions = ItemData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ItemCode || '').toLowerCase();
                            var name = (data.ItemName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.ItemName.localeCompare(b.ItemName);
                    }).slice(0, 50);
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item item-wise-set" data-code="${data.ItemCode || ''}" data-id="${data.ItemID || ''}" data-name="${data.ItemName || ''}">
                                 <span class="item-code"><b>${data.ItemCode || ''}</b></span> -
                                 <span class="item-name"><b>${data.ItemName || ''}</b></span>
                             </div>`
                        );
                    });

                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("Item Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });

        // ITEM Wise Tab - Click handler
        $(document).on('click', '.item-wise-set', function () {
            var selectedCode = $(this).data('code');
            var selectedName = $(this).data('name');
            var id = $(this).data('id');

            // Only update ITEM Wise tab fields
            $("#txtItemCode").val(selectedCode);
            $("#txtItemName").val(selectedName);
            $("#txtItemCode").attr("data-id", id);
            $("#DocumentEntry").val(id);

            // Hide only ITEM Wise suggestions
            $("#ItemWiseSuggestions").hide();
        });

        // ==================== BOX WISE TAB - SEPARATED AUTOCOMPLETE ====================
        var $activeInputbox = null;
        $(document).on('input', "#boxTabCode,#boxTabName", function () {
            var $input = $(this);
            $activeInputbox = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Unique container ID for BOX Wise tab
            var suggestionContainerId = 'BoxWiseSuggestions';
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty();

            if (Array.isArray(ItemData) && ItemData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    suggestions = ItemData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ItemCode || '').toLowerCase();
                            var name = (data.ItemName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.ItemName.localeCompare(b.ItemName);
                    }).slice(0, 50);
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item box-wise-set" data-code="${data.ItemCode || ''}" data-id="${data.ItemID || ''}" data-name="${data.ItemName || ''}">
                                 <span class="item-code"><b>${data.ItemCode || ''}</b></span> -
                                 <span class="item-name"><b>${data.ItemName || ''}</b></span>
                             </div>`
                        );
                    });

                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("Item Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });

        // BOX Wise Tab - Click handler
        $(document).on('click', '.box-wise-set', function () {
            var selectedCode = $(this).data('code');
            var selectedName = $(this).data('name');
            var id = $(this).data('id');

            // Only update BOX Wise tab fields
            $("#boxTabCode").val(selectedCode);
            $("#boxTabName").val(selectedName);
            $("#boxTabCode").attr("data-id", id);
            $("#DocumentEntry").val(id);

            // Hide only BOX Wise suggestions
            $("#BoxWiseSuggestions").hide();
        });

        // Hide suggestions when clicking outside - Updated to handle all containers
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.suggestions-container, #txtItemCode, #txtItemName, #boxTabCode, #boxTabName, #grpoNumber').length) {
                $('#ItemWiseSuggestions, #BoxWiseSuggestions, #GrpoNumberSuggestions').hide();
            }
        });

        // Select All functionality
        $('#selectAll').on('change', function () {
            $('.row-checkbox').prop('checked', this.checked);
        });

        // ----------------------- ON TAB SHOW -----------------------
        $('#modeTabs button').on('shown.bs.tab', function (e) {
            if (e.target.id === "grpo-tab") {

            }
        });

        // ----------------------- RESET FUNCTIONALITY -----------------------
        $("#btnReset").on("click", function () {
            let activeTab = $(".tab-pane.active").attr("id");

            switch (activeTab) {
                case "grpo":
                    $("#grpoNumber").val("");
                    $("#grpoTbody").empty();
                    Notify('success', 'Reset', 'GRPO tab has been reset');
                    break;
                case "item":
                    $('#txtItemCode').val("");
                    $('#txtItemName').val("");
                    $('#itemSalesEmployee').prop("selectedIndex", 0);
                    $('#itemCopies').val("1");
                    Notify('success', 'Reset', 'ITEM tab has been reset');
                    break;
                case "box":
                    $('#boxTabCode').val("");
                    $('#boxTabName').val("");
                    $('#boxSalesEmployee').prop("selectedIndex", 0);
                    $('#boxCopies').val("1");
                    $('#boxQuantity').val("1");
                    Notify('success', 'Reset', 'BOX tab has been reset');
                    break;
            }
        });

        // ==================== QR CODE GENERATION FUNCTIONS ====================

        // Generate QR Code for GRPO
        $('.generate-btn').on('click', function () {
            const grpoNumber = $('#grpoNumber').val();
            if (!grpoNumber) {
                Notify('warning', 'Warning', 'Please enter GRPO number');
                return;
            }

            const selectedRows = $('#grpoTbody .row-checkbox:checked');
            if (selectedRows.length === 0) {
                Notify('warning', 'Warning', 'Please select at least one item');
                return;
            }

            // Collect selected items data
            const itemsToPrint = [];
            selectedRows.each(function() {
                const $row = $(this).closest('tr');
                const itemCode = $row.find('.item-code-input').val();
                const itemName = $row.find('.item-name-input').val();
                const groupQty = parseInt($row.find('.group-qty-input').val()) || 1;
                const salesEmployee = $row.find('.sales-employee-input').val();

                itemsToPrint.push({
                    itemCode: itemCode,
                    itemName: itemName,
                    groupQty: groupQty,
                    salesEmployee: salesEmployee,
                    grpoNumber: grpoNumber
                });
            });

            // Generate QR codes and show modal
            generateQRCodes(itemsToPrint, 'GRPO');
        });

        // Generate QR Code for ITEM tab
        $('#generateItemQR').on('click', function () {
            const itemCode = $('#txtItemCode').val();
            const itemName = $('#txtItemName').val();
            const copies = parseInt($('#itemCopies').val()) || 1;
            const salesEmployee = $('#itemSalesEmployee').val();

            if (!itemCode && !itemName) {
                Notify('warning', 'Warning', 'Please enter either Item Code or Item Name');
                return;
            }

            const itemsToPrint = [];
            for (let i = 0; i < copies; i++) {
                itemsToPrint.push({
                    itemCode: itemCode,
                    itemName: itemName,
                    salesEmployee: salesEmployee,
                    type: 'ITEM'
                });
            }

            generateQRCodes(itemsToPrint, 'ITEM');
        });

        // Generate Barcode for BOX tab
        $('#generateBoxBarcode').on('click', function () {
            const itemCode = $('#boxTabCode').val();
            const itemName = $('#boxTabName').val();
            const copies = parseInt($('#boxCopies').val()) || 1;
            const quantity = parseInt($('#boxQuantity').val()) || 1;
            const salesEmployee = $('#boxSalesEmployee').val();

            if (!itemCode && !itemName) {
                Notify('warning', 'Warning', 'Please enter either Item Code or Item Name');
                return;
            }

            const itemsToPrint = [];
            for (let i = 0; i < copies; i++) {
                itemsToPrint.push({
                    itemCode: itemCode,
                    itemName: itemName,
                    quantity: quantity,
                    salesEmployee: salesEmployee,
                    type: 'BOX'
                });
            }

            generateQRCodes(itemsToPrint, 'BOX');
        });

        // Function to generate QR codes
        function generateQRCodes(items, type) {
            const qrCodeContainer = $('#qrCodeContainer');
            qrCodeContainer.empty();

            items.forEach((item, index) => {
                // Create QR code data string
                let qrData = '';
                if (type === 'GRPO') {
                    qrData = `GRPO: ${item.grpoNumber}\nItem: ${item.itemCode}\nName: ${item.itemName}\nQty: ${item.groupQty}\nSales: ${item.salesEmployee || 'N/A'}`;
                } else if (type === 'ITEM') {
                    qrData = `ITEM: ${item.itemCode}\nName: ${item.itemName}\nSales: ${item.salesEmployee || 'N/A'}`;
                } else if (type === 'BOX') {
                    qrData = `BOX: ${item.itemCode}\nName: ${item.itemName}\nQty: ${item.quantity}\nSales: ${item.salesEmployee || 'N/A'}`;
                }

                // Create QR code element
                const qrItem = $('<div class="qr-code-item"></div>');

                // Create canvas for QR code
                const canvas = document.createElement('canvas');
                qrItem.append(canvas);

                // Create text element
                const textElement = $(`<div class="qr-code-text">${item.itemCode} - ${item.itemName}</div>`);
                qrItem.append(textElement);

                qrCodeContainer.append(qrItem);

                // Generate QR code
                QRCode.toCanvas(canvas, qrData, {
                    width: 800,
                    height: 800,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        Notify('error', 'QR Code Error', 'Failed to generate QR code');
                    }
                });
            });

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
            modal.show();
        }

        // Print QR Codes
        $('#printQRCodes').on('click', function () {
            window.print();
        });

        // Load GRPO items when GRPO number changes
        $("#grpoNumber").change(function () {
            LoadGrpoNumber($(this).val());
        });

        function LoadGrpoNumber(DocNum) {
            $.ajax({
                url: '@Url.Action("GETGRPOITEM", "Inventory")',
                method: 'GET',
                data: { DocNum: DocNum },
                success: function (response) {
                    console.log(response);
                    $("#grpoTbody").empty();

                    if (response && response.length > 0) {
                        // Populate table with GRPO items
                        response.forEach(function (item, index) {
                            var row = `
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" class="row-checkbox">
                                </td>
                                <td>
                                    <input class="form-control form-control-sm item-code-input"
                                           value="${item.ItemCode || ''}"
                                           placeholder="Item code" readonly>
                                </td>
                                <td>
                                    <input class="form-control form-control-sm item-name-input"
                                           value="${item.ItemName || ''}"
                                           placeholder="Item name" readonly>
                                </td>
                                <td>
                                    <input class="form-control form-control-sm group-qty-input"
                                           type="number"
                                           value="${item.Quantity || 1}"
                                           min="1">
                                </td>
                                <td>
                                    <input class="form-control form-control-sm sales-employee-input"
                                           value=""
                                           placeholder="Enter sales employee">
                                </td>
                            </tr>`;
                            $("#grpoTbody").append(row);
                        });

                        Notify('success', 'Success', `Loaded ${response.length} items from GRPO: ${DocNum}`);
                    } else {
                        // If no data returned, show empty table
                        $("#grpoTbody").html('<tr><td colspan="5" class="text-center">No items found for this GRPO</td></tr>');
                        Notify('warning', 'No Data', `No items found for GRPO: ${DocNum}`);
                    }
                },
                error: function(xhr) {
                    console.error("Error loading GRPO items:", xhr);
                    Notify('error', 'Error', xhr.responseText || 'Error loading GRPO items');
                }
            });
        }

    });
</script>