<style>
</style>
<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b>Payment</b></h3>
                    </div>
                    <div class="col-md-6 d-flex justify-content-end align-items-center flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {

                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();
                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Find":
                                            <button id="btnFind" data-bs-toggle="modal" data-bs-target="#receiptListModal" class="btn @ColorClass mb-1  me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Attachments":
                                            <button id="Attachments" data-bs-toggle="modal" data-bs-target="#Attachment" class="btn @ColorClass mb-1   me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Export":
                                            <button id="btnPdf" class="btn btn-outline-danger me-2 mb-1">
                                                <i class="bi bi-file-pdf me-1"></i> PDF
                                            </button>
                                            <button id="btnExcel" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> EXCEL
                                            </button>
                                            <button id="btnCSV" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> CSV
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-end flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Save":
                                            <button id="openpaymentmean" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i>Add
                                            </button>
                                            break;
                                        @*    case "Update":
                                <button id="btnUpdate" data-action="update" class="btn @ColorClass mb-1  me-2" disabled>
                                    <i class="@icon"></i> @btnName
                                </button>
                                break; *@
                                        case "Park":
                                            <button id="btnPark" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Resume":
                                            <button id="btnResume" data-bs-toggle="modal" data-bs-target="#ResumeModal" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Print":
                                            <button id="btnPrint" data-bs-toggle="modal" data-bs-target="#PrintModal" class="btn @ColorClass mb-1   me-2" disabled>
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Delete":
                                            <button id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>

                <!-- Header Information -->
                <div class="row g-3">
                    <!-- Hidden Inputs -->
                    <div class="col-12 d-none">
                        <input id="DocumentEntry" hidden class="form-control" type="text" readonly />
                        <input data-obj="" id="BaseEntry" hidden class="form-control" type="text" readonly />
                        <input id="doctype" type="text" hidden value="PAY" class="form-control" />
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="Docnum" class="form-label">Document Number</label>
                        <input id="Docnum" class="form-control" type="text" readonly />
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="DocStatus" class="form-label">Status</label>
                        <select id="DocStatus" class="form-select" disabled>
                            <option value="O">Open</option>
                            <option value="C">Close</option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="DocumentDate" class="form-label">Document Date</label>
                        <input id="DocumentDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-2 col-6 mb-2">
                        <label for="DueDate" class="form-label">Due Date</label>
                        <input id="DueDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="PostingDate" class="form-label">Posting Date</label>
                        <input id="PostingDate" class="form-control datepicker" type="date" />
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="FYearId" class="form-label">Fiscal Year</label>
                        <select id="FYearId" class="form-select">
                            <option value="">Select Fiscal Year</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>



                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="LedgerType" class="form-label">Type</label>
                        <select id="LedgerType" class="form-select">
                            <option value="B">Business Partner</option>
                            <option value="L">Ledgers</option>
                        </select>
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="LedgerCode" class="form-label">Ledger</label>
                        <div class="input-group">
                            <input id="LedgerCode" class="form-control" type="text" data-id="" data-name="" data-code="" data-type="" />
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ledgerListModal">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-md-4 col-lg-2 Gldiv" style="display:none">
                        <label for="Amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <input id="Amount" class="form-control" type="number" data-id="" data-code="" />
                            <button class="btn btn-primary" id="AddAccLine">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="RefNo" class="form-label">Reference No</label>
                        <input id="RefNo" class="form-control" type="text" />
                    </div>
                    <div class="col-12 col-sm-12 col-md-6 col-lg-4">
                        <label for="Remarks" class="form-label">Remarks</label>
                        <textarea id="Remarks" class="form-control" rows="1"></textarea>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="row mt-4">
                    <div class="col-12 col-md-3">
                        <label>Search</label>
                        <input type="text" id="tableSearch" class="form-control form-control-sm mb-2 " placeholder="Search...">
                    </div>
                    <div class="col-12 col-md-9">

                    </div>
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table  table-hover" id="mainitemtable">
                                <thead class="table-light">
                                    <tr>
                                        <th nowrap>Sr No</th>
                                        <th nowrap>Delete</th>
                                        <th nowrap class="text-center"><input type="checkbox" class="ItemCheckAll" /></th>
                                        <th nowrap>Remark</th>
                                        <th nowrap>Document Name</th>
                                        <th nowrap>Document Number</th>
                                        <th nowrap>Document Date</th>
                                        <th hidden nowrap>GL Account</th>
                                        <th nowrap>Balance Due</th>
                                        <th nowrap>Total Payment</th>
                                        <th hidden nowrap>BaseDocEntry</th>
                                        <th hidden nowrap>BaseObjType</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <!-- ERP-Style Footer Summary - Optimized -->
                <div class="container-fluid mt-4 border-top pt-3 small">
                    <div class="row g-2">
                        <div class="col-md-2  col-lg-4 col-xl-7">

                        </div>
                        <!-- Tax Summary with Modal Trigger -->
                        <div class="col-md-10 col-lg-8 col-xl-5">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small">
                                        <i class="bi bi-currency-rupee text-success"></i>
                                        Pay On Account
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <!-- Checkbox -->
                                        <div class="input-group-text  p-1">
                                            <input id="PayOnAccAmtCheck" style="height:100%;width:25px;" type="checkbox" class="form-check-input mt-0">
                                        </div>
                                        <!-- Textbox -->
                                        <input id="PayOnAccAmt" type="text"
                                               class="form-control fw-bold text-end bg-info bg-opacity-0 text-white"
                                               readonly value="0.00">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small">
                                        <i class="bi bi-currency-rupee text-success"></i>  Open Balance
                                    </label>
                                    <input id="OpenBalance" class="form-control form-control-sm fw-bold text-end bg-danger bg-opacity-0 text-white" type="text" readonly value="0.00">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small">
                                        <i class="bi bi-currency-rupee text-success"></i>  Total Amount 
                                    </label>
                                    <input id="NETTotal" class="form-control form-control-sm fw-bold text-end bg-success bg-opacity-0 text-white" type="text" readonly value="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals -->
<!-- Ledger Search Modal -->
<div class="modal fade" id="ledgerListModal" tabindex="-1" aria-labelledby="ledgerListLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ledgerListModalLabel">Customer Search</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive ">
                    <table class="table table-bordered table-striped table-hover w-100" id="ledegerSearchTable">
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Find Mode Modal -->
<div class="modal fade" id="receiptListModal" tabindex="-1" aria-labelledby="receiptListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptListModalLabel">Find </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-3  mb-2">
                        <label for="fdocid" class="form-label">Document Number</label>
                        <input id="fdocid" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="frefno" class="form-label">Ref Number</label>
                        <input id="frefno" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ffromdate" class="form-label ">From Date</label>
                        <input id="ffromdate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ftodate" class="form-label">To Date</label>
                        <input id="ftodate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-12  mb-2 text-end   mt-3 ">
                        <button class="btn btn-outline-primary me-2" id="FindBtnSearch"><i class="bi bi-search me-2"></i>Find</button>
                        <button class="btn btn-outline-secondary me-2" id="FindBtnReset"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped w-100 display nowrap" id="receiptListTable">
                        <thead>
                            <tr>
                                <th>Doc Num</th>
                                <th>Action</th>
                                <th>Business Partner</th>
                                <th>Posting Date</th>
                                <th>Ref No</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Created By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="Paymentreceiptmodal" tabindex="-1" aria-labelledby="PaymentLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content shadow-lg rounded-3">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-cash-coin"></i> Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Body -->
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <h6 class="fw-bold mb-2">Ledger Balance</h6>
                        <input type="number" class="form-control text-end fw-bold bg-success text-white" id="LedgerBalance" readonly placeholder="0.00" value="0.00" />
                    </div>
                    <div class="col-12 col-md-4">
                        <h6 class="fw-bold mb-2">Total Amount Due</h6>
                        <input type="number" class="form-control text-end fw-bold bg-info text-white" id="TotalDue" readonly placeholder="0.00" />
                    </div>
                    <div class="col-12 col-md-4">
                        <h6 class="fw-bold mb-2">Remaining</h6>
                        <input type="number" class="form-control text-end text-danger fw-bold bg-danger text-white" id="Remain" readonly placeholder="0.00" value="0.00" />
                    </div>
                </div>
                <hr />
                <div class="row mt-4">
                    <!-- Payment Methods -->
                    <div class="col-12 col-md-4 border-end mb-4 mb-md-0">
                        <h6 class="fw-bold mb-3">Select Payment Mode</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary active" id="CashBtn"><i class="bi bi-cash-stack"></i> Cash</button>
                            <button class="btn btn-outline-secondary" id="BankTransBtn"><i class="bi bi-bank"></i> Bank Transfer</button>
                            <button class="btn btn-outline-success " id="ChequeBtn"><i class="bi bi-cash"></i> Cheque</button>
                        </div>
                    </div>
                    <!-- Invoice Summary -->
                    <div class="col-12 col-md-8">
                        <div class="row">
                            <h6 class="fw-bold mb-3 text-info Cash">Cash</h6>
                            <div class="col-md-6 mb-4 Cash">
                                <h6 class="fw-bold mb-2">Ledger Account</h6>
                                <select class="form-control" id="CashLedger">
                                    <option value="">Select</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4 Cash">
                                <h6 class="fw-bold mb-2">Cash Amount</h6>
                                <input type="number" class="form-control text-end text-primary fw-bold" id="CashAmt" placeholder="0.00" />
                            </div>
                            <h6 class="fw-bold mb-3 text-info Bank" style="display:none">Bank</h6>
                            <hr class="Bank" style="display:none" />
                            <div class="col-md-6 mb-4 Bank" style="display:none">
                                <h6 class="fw-bold mb-2">Bank Ledger</h6>
                                <select class="form-control" id="BankLedger">
                                    <option value="">Select</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4 Bank" style="display:none">
                                <h6 class="fw-bold mb-2">Bank Amount</h6>
                                <input type="number" class="form-control text-end text-primary fw-bold" id="BankAmt" placeholder="0.00" />
                            </div>
                            <h6 class="fw-bold mb-3 text-info Cheque" style="display:none">Cheque</h6>
                            <hr class="Cheque" style="display:none" />
                            <div class="col-md-6 mb-3 Cheque" style="display:none">
                                <h6 class="fw-bold mb-2">Cheque Bank</h6>
                                <select class="form-control" id="ChequeBank">
                                    <option value="">Select</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3 Cheque" style="display:none">
                                <h6 class="fw-bold mb-2">Cheque Date</h6>
                                <input type="date" class="form-control fw-bold" id="ChequeDate" />
                            </div>
                            <div class="col-md-6 mb-3 Cheque" style="display:none">
                                <h6 class="fw-bold mb-2">Cheque Number</h6>
                                <input type="number" class="form-control fw-bold" id="ChequeNo" />
                            </div>
                            <div class="col-6  Cheque" style="display:none">
                                <h6 class="fw-bold mb-2">Cheque Amount</h6>
                                <input type="number" class="form-control text-end text-primary fw-bold" id="ChequeAmt" placeholder="0.00" />
                            </div>
                            <div class=" col-12 mb-4">
                                <h6 class="fw-bold mb-2">Remark</h6>
                                <textarea class="form-control" id="PayRemark"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer bg-light">
                        <div class="container-fluid">
                            <div class="row align-items-center">
                                <div class="col-12 col-md text-start mb-2 mb-md-0">
                                </div>
                                <div class="col-12 col-md text-end">
                                    <button class="btn btn-success me-2" id="btnSave"><i class="bi bi-check-circle"></i> Accept</button>
                                    <button class="btn btn-danger" id="PaymentCancel" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
    </div>
</div>
</div>
<script>
    $(document).ready(function () {
        $(document).on("shown.bs.tab", "#paymentTabs a", function () {
            // Remove the shadow class from all tabs
            $("#paymentTabs a").removeClass("PayTabcolor text-white");
            // Add the shadow class to the active tab
            $(this).addClass("PayTabcolor text-white");
        });
        // Initialize variables
        let selectedRowIndex = null;
        $('.datepicker').val(new Date().toISOString().split('T')[0]);
        loadFiscalYears();
        // Add new line item
        $('#AddAccLine').click(function() {
            addNewLineItem();
        });
        // Save document
        $('#openpaymentmean').click(function () {
            MakeSum()
            if ($("#NETTotal").val() > 0) {
                $("#TotalDue").val($("#NETTotal").val())
                $("#Paymentreceiptmodal").modal("show")
            } else {
                Notify('info', 'Please Check Net Amount.', 'And Try Again..!');
            }
        });
        $('#btnSave').click(function () {
            savedocument("S");
        });
        // Save document
        $('#btnPark').click(function () {
            savedocument("P");
        });
        // Update document
        $('#btnUpdate').click(function() {
            savedocument();
        });
        // Reset form
        $('#btnReset').click(function() {
            resetForm();
        });
        $('#btnDelete').click(function() {
            deleteDoc();
        });
        //Payment Mean
        {
             $.ajax({
                  url: '@Url.Action("GETCASHLEDGER", "Accounts")',
                 method: 'GET',
                 success: function (response) {
                     const select = $('#CashLedger');
                     select.empty();
                     select.append(`<option value="">Select</option>`)
                     response.forEach(function(data) {
                         select.append(`<option value="${data.ID}">${data.GroupName}</option>`);
                     });
                 },
                 error: function(xhr) {
                             Notify('error', 'Error', xhr.responseText );
                 }
             });
             $.ajax({
                url: '@Url.Action("GETBANKLEDGER", "Accounts")',
                method: 'GET',
                success: function (response) {
                    const select = $('#BankLedger');
                    select.empty();
                    select.append(`<option value="">Select</option>`)
                    response.forEach(function(data) {
                        select.append(`<option value="${data.ID}">${data.GroupName}</option>`);
                    });
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
             });
             $.ajax({
                url: '@Url.Action("GETBANKS", "Accounts")',
                method: 'GET',
                success: function (response) {
                    const select = $('#ChequeBank');
                    select.empty();
                    select.append(`<option value="">Select</option>`)
                    response.forEach(function(data) {
                        select.append(`<option value="${data.BankID}">${data.BankName}</option>`);
                    });
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
            $("#CashBtn").click(function () {

                $(this).toggleClass("active");
                if ($(this).hasClass("active")) {
                    $(".Cash").show();
                } else {
                    $(".Cash").hide();
                    $("#CashLedger").val("")
                    $("#CashAmt").val("0.00")
                }
            })
            $("#BankTransBtn").click(function () {
                $(this).toggleClass("active");
                if ($(this).hasClass("active")) {
                    $(".Bank").show();
                } else {
                    $(".Bank").hide();
                    $("#BankLedger").val("")
                    $("#BankAmt").val("0.00")
                }
            })
            $("#ChequeBtn").click(function () {
                $(this).toggleClass("active");
                if ($(this).hasClass("active")) {
                    $(".Cheque").show();
                } else {
                    $(".Cheque").hide();
                    $("#ChequeBank").val("")
                    $("#ChequeDate").val("")
                    $("#ChequeNo").val("")
                    $("#ChequeAmt").val("0.00")
                }
            })
            $("#PaymentCancel").click(function () {
                $("#CashBtn").addClass("active");
                $(".Cash").show();
                $("#CashLedger").val("")
                $("#CashAmt").val("0.00")

                $("#BankTransBtn").removeClass("active");
                $(".Bank").hide();
                $("#BankLedger").val("")
                $("#BankAmt").val("0.00")

                $(".Cheque").hide();
                $("#ChequeBtn").removeClass("active");
                $("#ChequeBank").val("")
                $("#ChequeDate").val("")
                $("#ChequeAmt").val("0.00")

            })
            $(document).on("input", "#CashAmt ,#BankAmt,#ChequeAmt", function () {
                MakeSum()
            })
            function MakeSum() {
                var CashAmt = parseFloat($("#CashAmt").val()) || 0;
                var BankAmt = parseFloat($("#BankAmt").val()) || 0;
                var ChequeAmt = parseFloat($("#ChequeAmt").val()) || 0;
                var NETTotal = parseFloat($("#NETTotal").val()) || 0;

                var remain = NETTotal-(CashAmt + BankAmt + ChequeAmt);
                $("#Remain").val(remain);
            }
        }
       function deleteDoc(){
          var id = $('#DocumentEntry').val();
            if(!id){
                Notify('error', 'Document Entry is required for deletion','');
                return;
            }
             Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const headerData = getHeaderData();
                    const lineItems = getLineItems();
                    const data = {
                        header: headerData,
                        lines: lineItems,
                    };
                    $.ajax({
                        url: '@Url.Action("DELETEPAYMENT", "Accounts")',
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'Document deleted successfully!');
                                 resetForm();
                            } else {
                                Notify('warning', 'Warning', response.message || 'Document deleted successfully!');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Document';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        }
        // Function to add new line item
        function addNewLineItem() {
            var Amount = $("#Amount").val();
            var Name = $("#LedgerCode").attr("data-name");
            var ID = $("#LedgerCode").attr("data-id");
            let today = new Date();
            let dd = String(today.getDate()).padStart(2, '0');
            let mm = String(today.getMonth() + 1).padStart(2, '0'); // January = 0
            let yyyy = today.getFullYear();
            if (Name.trim() == "" || ID == "") {
                Notify('error', 'Please Select Ledger.', '');
                return; // Stop execution if the previous row's ItemCode is empty
            }
            let formattedDate = dd + '-' + mm + '-' + yyyy;
            const table = $('#mainitemtable tbody');
            const lastRow = table.find('tr').last();
            const rowCount = table.find('tr').length;
            const newRow = `
                        <tr data-id='' class="line-item">
                            <td>${rowCount + 1}</td>
                             <td class="text-center">
                                 <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                     <i class="bi bi-trash"></i>
                                 </button>
                             </td>
                            <td hidden class="text-center">
                                 <input style="height: 20px; width:20px;" type="checkbox" class="ItemCheck mt-1" />
                             </td>

                            <td><textarea style='height:9px;' type="text" class="form-control form-control-sm text-end Remarks" value=""></textarea></td>
                            <td hidden class="text-center DocName"></td>
                            <td hidden class="text-center DocNum"></td>
                            <td class="text-center DocumentDate">${formattedDate.trim()}</td>
                            <td class="text-center DueDate">${formattedDate.trim()}</td>
                            <td class="text-end GLAccount" data-id="${ID}">${Name}</td>
                            <td hidden class="text-end BalanceDue"></td>
                            <td><input type="number" class="form-control form-control-sm text-end TotalPayment" value="${Amount}" min="0" step="1"></td>
                            <td hidden><input style='width:100px!important;' type="text" value='' class="form-control form-control-sm text-end BaseDocEntry" readonly></td>
                            <td hidden><input style='width:200px!important;' type="text" value='' class="form-control form-control-sm text-end BaseObjType" readonly></td>
                        </tr>

            `;
            table.append(newRow);
            const newRowElement = table.find('tr').last();
            newRowElement.find('.Remarks').focus();
            calculateHeaderTotals()
            $("#Amount").val("");
            $("#LedgerCode").val("");
            $('#LedgerCode').attr('data-id', ' ');
            $('#LedgerCode').attr('data-name', ' ');
            $('#LedgerCode').attr('data-code', ' ');
            $('#LedgerCode').attr('data-type', ' ');
        }
        function formatheader(flag) {
            const table = $('#mainitemtable thead');
            if (flag == "L") {
                $(".Gldiv").show();
                var header = `
                    <tr>
                        <th nowrap>Sr No</th>
                        <th nowrap>Delete</th>
                        <th hidden nowrap class="text-center"><input type="checkbox" class="ItemCheckAll" /></th>
                        <th nowrap>Remark</th>
                        <th hidden nowrap>Document Name</th>
                        <th hidden nowrap>Document Number</th>
                        <th nowrap>Document Date</th>
                        <th nowrap>Due Date</th>
                        <th nowrap>GL Account</th>
                        <th hidden nowrap>Balance Due</th>
                        <th nowrap>Total Payment</th>
                        <th hidden nowrap>BaseDocEntry</th>
                        <th hidden nowrap>BaseObjType</th>
                    </tr>
                    `;
                table.html(header)
            } else {
                $(".Gldiv").hide();
                var header = `
                      <tr>
                          <th nowrap>Sr No</th>
                          <th nowrap>Delete</th>
                          <th nowrap class="text-center"><input type="checkbox" class="ItemCheckAll" /></th>
                          <th nowrap>Remark</th>
                          <th nowrap>Document Name</th>
                          <th nowrap>Document Number</th>
                          <th nowrap>Document Date</th>
                          <th nowrap>Due Date</th>
                          <th hidden nowrap>GL Account</th>
                          <th nowrap>Balance Due</th>
                          <th nowrap>Total Payment</th>
                          <th hidden nowrap>BaseDocEntry</th>
                          <th hidden nowrap>BaseObjType</th>
                      </tr>
                    `;
                table.html(header)
            }

        }
        $(document).on("click","#PayOnAccAmtCheck", function () {
            if ($(this).is(":checked")) {
                $("#PayOnAccAmt").val("0.00").prop("readonly", false)
            } else {
                $("#PayOnAccAmt").val("0.00").prop("readonly", true)
            }
            calculateHeaderTotals()
        })
        // Function to calculate header totals
        $(document).on("click", ".ItemCheck", function () {
            calculateHeaderTotals();
        });

        $(document).on("click", ".ItemCheckAll", function () {
            $("#mainitemtable tbody").find(".ItemCheck").prop("checked", $(this).is(":checked"));
            calculateHeaderTotals();
        });

        // Function to calculate header totals
        function calculateHeaderTotals() {
            const ledgerType = $("#LedgerType").val();
            const payOnAccAmt = parseFloat($("#PayOnAccAmt").val()) || 0;

            let totalPayment = 0;

            $('#mainitemtable tbody tr').each(function () {
                const paymentValue = parseFloat($(this).find('.TotalPayment').val()) || 0;
                const isChecked = $(this).find('.ItemCheck').is(":checked");

                // Add payment value based on conditions
                if (ledgerType !== "B" || isChecked) {
                    totalPayment += paymentValue;
                }
            });

            $('#NETTotal').val((totalPayment + payOnAccAmt).toFixed(2));
        }
        $(document).on('input', '.TotalPayment,#PayOnAccAmt', function () {
            calculateHeaderTotals();
        });
        function loadFiscalYears() {
            $.ajax({
                 url: '@Url.Action("GETOPENFYEAR", "Inventory")',
                method: 'GET',
                success: function(response) {
                    const select = $('#FYearId');
                    select.empty();

                    response.forEach(function(year) {
                        select.append(`<option value="${year.FYearId}">${year.FYear}</option>`);
                    });
                    loadDocNum($("#FYearId").val())
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        $("#FYearId").change(function(){
           loadDocNum($(this).val())
        })
        // Function to load warehouses
        function loadDocNum(id) {
            $.ajax({
                url: '@Url.Action("GETPAYMENTDOCNUM", "Accounts")',
                method: 'GET',
                data:{id:id},
                success: function(response) {
                    if(response[0].Success=="true"){
                        $("#Docnum").val(response[0].Message)
                    }else{
                           Notify('error', response[0].Message,'');
                    }
                },
                error: function(xhr) {
                    Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        function savedocument(flag) {
            const headerData = getHeaderData();
            const lineItems = getLineItems();
            if (flag == "S") {
                if (!validateForm(headerData, lineItems)) {
                    return;
                }
            }
            const data = {
                header: headerData,
                lines: lineItems,
            };
            // AJAX call to save
            $.ajax({
                url: '@Url.Action("CREATEPAYMENT", "Accounts")' + '?flag=' + flag + '&doctype=' + $("#doctype").val(),
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    } else {
                        $('#btnPark').prop('disabled', true).html('<i class="bi bi-p-circle"></i> Processing...');
                    }
                },
                success: function(response) {
                    if(response.success){
                       Notify('success', response.message,'');
                       currentDocEntry = response.docEntry;
                       //$('#btnUpdate').prop('disabled', false);
                       $('#btnDelete').prop('disabled', false);
                       $('#btnCancel').prop('disabled', false);
                       $('#DocumentEntry').val(response.docEntry);
                       $('#addFilesButton').click();
                     //  $("#btnReset").click();
                        if (flag == "S") {
                            loadFindRow(currentDocEntry, $("#doctype").val(),"")
                        } else {
                            $("#btnReset").click();
                        }
                        resetForm()
                    }else{
                       Notify('error','Faild To Create ', response.message);
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseText || 'Error loading ITEM GROUP';
                    Notify('error', 'Error', errorMessage);
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }

                },complete: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }
                }
            });
        }
        function removeempty(){
            var tablerow= $('#mainitemtable tbody tr').length;
            if(tablerow >1){
                $('#mainitemtable tbody tr').each(function(){
                     var row = $(this).closest("tr");
                    if (row.length && !row.find('.ItemCode').val().trim()) {
                        row.remove();
                        return; // Stop execution if the previous row's ItemCode is empty
                    }
                });
            }
        }
        function getHeaderData() {
            return {
                DocEntry: $('#DocumentEntry').val() || null,
                Docnum: $('#Docnum').val(),
                DocStatus: $('#DocStatus').val(),
                PostingDate: $('#PostingDate').val(),
                DocumentDate: $('#DocumentDate').val(),
                DueDate: $('#DueDate').val(),
                LedgerType: $('#LedgerType').val(),
                FYearId: $('#FYearId').val(),
                NETTotal: parseFloat($('#NETTotal').val()) || 0,
                LedgerID: $('#LedgerCode').attr("data-id").toString().trim() || null,
                LedgerName: $('#LedgerCode').attr("data-name"),
                LedgerCode: $('#LedgerCode').attr("data-code"),
                RefNo: $('#RefNo').val(),
                OpenBalance: parseFloat($('#OpenBalance').val()) || 0,
                PayOnAccAmt: parseFloat($('#PayOnAccAmt').val()) || 0,
                PayOnAccCheck: $("#PayOnAccAmtCheck").is(":checked") ? "Y" : "N",
                Remarks: $('#Remarks').val(),

                LedgerBalance: parseFloat($('#LedgerBalance').val()) || 0,
                IsCash: $('#CashBtn').hasClass("active") ? "Y" : "N",
                CashLedgerId: $('#CashLedger').val(),
                CashAmt: parseFloat($('#CashAmt').val()) || 0,

                IsBank: $('#BankTransBtn').hasClass("active") ? "Y" : "N",
                BankLedgerId: $('#BankLedger').val(),
                BankAmt: parseFloat($('#BankAmt').val()) || 0,

                IsCheque: $('#ChequeBtn').hasClass("active") ? "Y" : "N",
                ChequeBankId: $('#ChequeBank').val(),
                ChequeDate: $('#ChequeDate').val(),
                ChequeNo: $('#ChequeNo').val(),

                ChequeAmt: parseFloat($('#ChequeAmt').val()) || 0,
                PayRemarks: $('#PayRemark').val()
            };
        }
        function getLineItems() {
            function formatDate(str) {
                const [day, month, year] = str.split("-");
                return `${year}-${month}-${day}`;
            }
            const lineItems = [];
            $('#mainitemtable tbody tr').each(function (index) {
                const row = $(this);
                if (row.find('.ItemCheck').is(":checked") && $("#LedgerType").val() == "B") {
                    lineItems.push({
                        ID: row.data('id').toString() || null,
                        DocEntry: null,
                        DocName: row.find('.DocName').text() || "",
                        DocNum: row.find('.DocNum').text() || "",
                        DocumentDate: formatDate(row.find('.DocumentDate').text()) || "",
                        DueDate: formatDate(row.find('.DueDate').text()) || "",
                        TotalPayment: parseFloat(row.find('.TotalPayment').val()) || 0,
                        BalanceDue: parseFloat(row.find('.BalanceDue').text()) || 0,
                        LedgerID: row.find('.GLAccount').attr("data-id"),
                        LedgerName: row.find('.GLAccount').text(),
                        BaseDocEntry: row.find('.BaseDocEntry').val(),
                        BaseObjType: row.find('.BaseObjType').val(),
                        Remarks: row.find('.Remarks').val()
                    });
                } else if (!row.find('.ItemCheck').is(":checked") && $("#LedgerType").val() == "L") {
                    lineItems.push({
                        ID: row.data('id').toString() || null,
                        DocEntry: null,
                        DocName: row.find('.DocName').text() || "",
                        DocNum: row.find('.DocNum').text() || "",
                        DocumentDate: formatDate(row.find('.DocumentDate').text()) || "",
                        DueDate: formatDate(row.find('.DueDate').text()) || "",
                        TotalPayment: parseFloat(row.find('.TotalPayment').val()) || 0,
                        BalanceDue: parseFloat(row.find('.BalanceDue').text()) || 0,
                        LedgerID: row.find('.GLAccount').attr("data-id"),
                        LedgerName: row.find('.GLAccount').text(),
                        BaseDocEntry: row.find('.BaseDocEntry').val(),
                        BaseObjType: row.find('.BaseObjType').val(),
                        Remarks: row.find('.Remarks').val()
                    });
                }
            });
            return lineItems;
        }
        function validateForm(header, lines) {
            if (!header.PostingDate) {
                Notify('error', 'Posting date is required', '');
                return false;
            }
            if (!header.DocumentDate) {
                Notify('error', 'Document date is required', '');
                return false;
            }
            if (!header.DueDate) {
                Notify('error', 'Due Date is required', '');
                return false;
            }
            if (!header.FYearId) {
                Notify('error', 'Fiscal year is required', '');
                return false;
            }
            if (!header.LedgerCode && $("#LedgerType").val == "B") {
                Notify('error', 'Ledger is required', '');
                return false;
            }

            if (header.IsCash == 'Y' && header.CashAmt > 0) {
                if (header.CashLedgerId == "" || header.CashLedgerId == null) {
                    Notify('error', 'Cash Ledger Is required', '');
                    return false;
                }
            }
            if (header.IsBank == 'Y' && header.BankAmt > 0) {
                if (header.BankLedgerId == "" || header.BankLedgerId == null) {
                    Notify('error', 'Bank Ledger Is required', '');
                    return false;
                }
            }

            if (header.IsCheque == 'Y' && header.ChequeAmt > 0) {
                if (header.ChequeBankId == "" || header.ChequeBankId == null) {
                    Notify('error', 'Cheque Bank Is required', '');
                    return false;
                }
                if (header.ChequeDate == "" || header.ChequeDate == null) {
                    Notify('error', 'Cheque Date Is required', '');
                    return false;
                }
                if (header.ChequeNo == "" || header.ChequeNo == null) {
                    Notify('error', 'Cheque Number Is required', '');
                    return false;
                }
            }
            var nettotal = header.CashAmt + header.BankAmt + header.ChequeAmt;
            if (nettotal < header.NETTotal || nettotal > header.NETTotal) {
                Notify('error', 'Please Check Payment Details.', 'The Remaining Amount Must Be Zero!');
                return false;
            }
            if (header.PayOnAccCheck !== "Y") {
                if (lines.length === 0) {
                    Notify('error', 'At least one item is required', '');
                    return false;
                }
            }

            var index = 1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line.TotalPayment || line.TotalPayment <= 0 || line.TotalPayment == "NaN") {
                    Notify('error', `Valid Total Payment Amount is required for line ${index}`, '');
                    return false;
                }
                index++;
            }
            return true;
        }
        function resetForm() {
                currentDocEntry = null;
                isEditMode = false;

                // Reset header fields
                $('#DocumentEntry').val('');
                $('#Docnum').val('');
                $('#DocStatus').val('O');
                $('#PostingDate').val(new Date().toISOString().split('T')[0]);
                $('#DocumentDate').val(new Date().toISOString().split('T')[0]);
                $('#DeliveryDate').val(new Date().toISOString().split('T')[0]);
                $('#DueDate').val(new Date().toISOString().split('T')[0]);
                $('#FYearId').val('');
                $('#LedgerCode').val('');
                $('#LedgerCode').attr('data-id', ' ');
                $('#LedgerCode').attr('data-name', ' ');
                $('#LedgerCode').attr('data-code', ' ');
                $('#LedgerCode').attr('data-type', ' ');
                $('#RefNo').val('');
                $('#BaseEntry').val('');
                $('#Remarks').val('');
                $('#PayOnAccAmtCheck').prop("checked", false);
                $('#PayOnAccAmt').val('0.00');
                $('#NETTotal').val('0.00');
                $('#OpenBalance').val('0.00');
                $('#mainitemtable tbody').empty();

                $('#btnSave').prop('disabled', false);
                $('#btnPark').prop('disabled', false);
                $('#btnPrint').prop('disabled', true);
                $('#btnDelete').prop('disabled', true);
                $('#btnCopyFrom').prop('disabled', true);
               $('#btnCopyTo').prop('disabled', true);

               $('#PaymentCancel').prop('disabled', false);
               $("#PayOnAccAmtCheck").prop("disabled", false);
                $('#LedgerType').prop('disabled', false);
                $('#LedgerType').val('B');
                $('#LedgerType').trigger("change");
              
                $("#CashBtn").addClass("active");
                $(".Cash").show();
                $("#CashLedger").val("")
                $("#CashAmt").val("0.00")

                $("#BankTransBtn").removeClass("active");
                $(".Bank").hide();
                $("#BankLedger").val("")
                $("#BankAmt").val("0.00")

                $(".Cheque").hide();
                $("#ChequeBtn").removeClass("active");
                $("#ChequeBank").val("")
                $("#ChequeDate").val("")
                $("#ChequeAmt").val("0.00")
                $('#ResetFreight').click();
                $('#mainitemtable tbody').empty();
                // Reload fiscal years and document number
                loadFiscalYears();
            formatheader("B")
            $("#resetcustomerform").click();

        }
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
        // Modify the remove-line click handler
        $(document).on('click', '.remove-line', function() {
            const row = $(this).closest('tr');
            const table = $('#mainitemtable tbody');
            const rowCount = table.find('tr').length;
            if (rowCount > 1) {
                row.remove();
                // Update row numbers
                table.find('tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                });
                // Disable remove button if only one row left
                if (table.find('tr').length === 1) {
                    table.find('tr').first().find('.remove-line').prop('disabled', true);
                }
                // Recalculate totals after deletion
                calculateHeaderTotals();
            } else {
                Notify('warning', 'At least one item is required');
            }
        });
        //Busness Partner
        {
               var BPPartnerData = null;
                formatheader("B")
            $("#LedgerType").on("change", function () {
                   $("#resetcustomerform").click();
                    $('#LedgerCode').attr('data-id', ' ');
                    $('#LedgerCode').attr('data-name', ' ');
                    $('#LedgerCode').attr('data-code', ' ');
                    $('#LedgerCode').attr('data-type', ' ');
                    $('#mainitemtable tbody').empty();
                    formatheader($(this).val())
                    if ($(this).val() == "L") {
                        $("#PayOnAccAmtCheck").prop("cheked", false);
                        $("#PayOnAccAmtCheck").prop("disabled", true);
                    } else {
                        $("#PayOnAccAmtCheck").prop("disabled", false);
                    }
                    loadBPPartnerTable($(this).val())
                });
            function loadBPPartnerTable(type) {
                    $.ajax({
                        type: "GET",
                        url: '@Url.Action("GETLEDGERS", "Accounts")',
                        contentType: "application/json; charset=utf-8",
                        data: { type: type },
                        cache: false,
                        success: function (data) {
                            BPPartnerData = [];
                            BPPartnerData = data;
                            applyBPPartnerDatatable(data);
                        },
                        error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error loading BP Partners');
                        }
                    });
                }
                loadBPPartnerTable("B")
                function applyBPPartnerDatatable(jsonData) {

                    const tableId = '#ledegerSearchTable';
                    if ($.fn.DataTable.isDataTable(tableId)) {
                        $(tableId).DataTable().destroy();
                        $(tableId).empty(); // Clear the table
                    }
                    $(tableId).DataTable({
                        data: jsonData,
                        responsive: {
                            details: {
                                display: $.fn.dataTable.Responsive.display.modal({
                                    header: function(row) {
                                        return 'Details for ' + row.data().GroupName;
                                    }
                                }),
                                renderer: $.fn.dataTable.Responsive.renderer.tableAll({
                                    tableClass: 'table'
                                })
                            }
                        },
                        dom: 'lrtip', // Simpler controls
                        initComplete: function() {
                            // Adjust modal height after table initialization
                            $('.modal').css('max-height', $(window).height() * 0.9);
                            $('.modal-body').css('overflow-y', 'auto');
                        },
                        columns: [
                            {
                                data: null,
                                title: "Sr No",
                                render: function(data, type, row, meta) {
                                    return meta.row + 1;
                                },
                                className: "text-center",
                                orderable: false
                            },
                            {
                                data: null,
                                title: "Action",
                                className: "text-center nowrap",
                                orderable: false,
                                render: function(data, type, row) {
                                    return `
                                    <div class="d-flex justify-content-center gap-1">
                                        <button class="btn btn-sm btn-primary bp-edit" title="Edit" data-id="${row.ID}" data-type="${row.LedgerType}"  data-code="${row.Code}" data-name="${row.GroupName}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>`;
                                }
                            },
                            { data: "Code", title: "Ledger Code" },
                            { data: "GroupName", title: "Group Name" },
                        ],
                        responsive: true,
                        dom: '<"top"lf>rt<"bottom"ip><"clear">',
                        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                        language: {
                            lengthMenu: "Show _MENU_ entries",
                            info: "Showing _START_ to _END_ of _TOTAL_ entries",
                            infoEmpty: "Showing 0 to 0 of 0 entries",
                            infoFiltered: "(filtered from _MAX_ total entries)"
                        },
                        createdRow: function(row, data, dataIndex) {
                            $(row).attr('data-id', data.ID);
                        }
                    });
                }
                $(document).on("click",".bp-edit",function(){
                      var id = $(this).data("id");
                      var code = $(this).data("code");
                      var type = $(this).data("type");
                      var name = $(this).data("name");
                      $("#LedgerCode").val(name)
                      $("#LedgerCode").attr("data-id",id)
                      $("#LedgerCode").attr("data-name", name)
                      $("#LedgerCode").attr("data-type", type)
                      $("#LedgerCode").attr("data-code",code)
                    $("#ledgerListModal").modal("hide")
                    if (type == "C" || type == "S") {
                        formatheader("B")
                        LoadLedgerDocs(id)
                        Loadbp(id)
                    } else {
                        formatheader("L")
                    }
                })

                // LedgerCode Search
                var $activeInput = null;
                $(document).on('input', "#LedgerCode", function() {
                    var $input = $(this);
                    $activeInput = $(this);
                    var value = $input.val().toLowerCase().replace(/_/g, ' ');
                    var suggestions = [];

                    // Check if the suggestion container already exists, if not, create it
                    var suggestionContainerId = 'BPSuggestions-' + $input.closest('tr').index();
                    if (!$('#' + suggestionContainerId).length) {
                        $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
                    }

                    // Get the container element
                    var $suggestionContainer = $('#' + suggestionContainerId);
                    $suggestionContainer.empty(); // Clear previous suggestions

                    // Check if BPPartnerData exists and is an array
                    if (Array.isArray(BPPartnerData) && BPPartnerData.length > 0) {
                        if (value.length > 0) {
                            var searchTokens = value.split(/\s+/);
                            // Filter suggestions based on universal search (match all tokens)
                            suggestions = BPPartnerData.filter(function(data) {
                                if (data && typeof data === 'object') {
                                    var code = (data.Code || '').toLowerCase();
                                    var name = (data.GroupName || '').toLowerCase();
                                    var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                                    return searchTokens.every(function(token) {
                                        return allTokens.some(function(itemToken) {
                                            return itemToken.includes(token);
                                        });
                                    });
                                }
                                return false;
                            }).sort(function(a, b) {
                                return a.GroupName.localeCompare(b.GroupName);
                            }).slice(0, 50); // Limit to 50 results
                        }
                        // Show suggestions if any
                        if (suggestions.length > 0) {
                            suggestions.forEach(function(data) {
                                $suggestionContainer.append(
                                    `<div class="suggestion-item bpset" data-code="${data.Code || ''}" data-id="${data.ID || ''}" data-type="${data.LedgerType}" data-name="${data.GroupName || ''}">
                                        <span class="ledger-code"><b>${data.Code || ''}</b></span>
                                        <span class="group-name"><b>${data.GroupName || ''}</b></span>
                                    </div>`
                                );
                            });

                            // Calculate the offset of the input field and position the suggestion box below it
                            var offset = $input.offset();
                            $suggestionContainer.css({
                                top: offset.top + $input.outerHeight(),
                                left: offset.left,
                                width: $input.outerWidth(),
                                position: 'absolute',
                                "z-index": 1000,
                            }).show();
                        } else {
                            $suggestionContainer.hide();
                        }
                    } else {
                        console.error("Ledger Data is not defined or is empty");
                        $suggestionContainer.hide();
                    }
                });
            // handle mouse click
            $(document).on('click', '.bpset', function () {
                selectSuggestion($(this));
            });
            // handle keyboard navigation
            $(document).on('keydown', function (e) {
                if (!$activeInput) return;
                var $suggestionContainer = $('.suggestions-container:visible');
                if (!$suggestionContainer.length) return;

                var $items = $suggestionContainer.find('.suggestion-item');
                var $current = $items.filter('.suggestion-item-active');
                var idx = $items.index($current);

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if (idx < $items.length - 1) {
                        $current.removeClass('suggestion-item-active');
                        $items.eq(idx + 1).addClass('suggestion-item-active');
                    }
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if (idx > 0) {
                        $current.removeClass('suggestion-item-active');
                        $items.eq(idx - 1).addClass('suggestion-item-active');
                    }
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if ($current.length) {
                        selectSuggestion($current);
                    }
                }
            });
            function selectSuggestion($item) {
                var id = $item.data('id');
                var name = $item.data('name');
                var code = $item.data('code');
                var type = $item.data('type');
                $("#LedgerCode").val(name)
                $("#LedgerCode").attr("data-id", id)
                $("#LedgerCode").attr("data-name", name)
                $("#LedgerCode").attr("data-code", code)
                $("#LedgerCode").attr("data-type", type)
                if (type == "C" || type == "S") {
                    formatheader("B")
                    LoadLedgerDocs(id)
                    Loadbp(id)
                } else {
                    formatheader("L")
                }
                $('.suggestions-container').hide();
            }
            // close on outside click
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.suggestions-container, .LedgerID').length) {
                    $('.suggestions-container').hide();
                }
            });
            function LoadLedgerDocs(id) {
                    $.ajax({
                        url: '@Url.Action("GETLEDGERPAYMENTDETAILS", "Accounts")',
                        data: { Id: id, type: $("#doctype").val(), flag: $("#LedgerCode").attr("data-type")},
                        method: 'GET',
                        success: function (response) {
                            if (response.length <=0) {
                                Notify('error', 'Not Data Found', "");
                            }
                               $('#mainitemtable tbody').empty();
                                const table = $('#mainitemtable tbody');
                                const lastRow = table.find('tr').last();
                                var rowCount = 1;
                            for (var i = 0; i < response.length; i++) {
                                var item = response[i];
                                const newRow = `
                                   <tr data-id='' class="line-item">
                                       <td>${rowCount}</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-danger remove-line" >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                       <td  class="text-center">
                                            <input style="height: 15px; width:15px;" type="checkbox" class="ItemCheck mt-1" />
                                        </td>

                                       <td><textarea style='height:9px;' type="text" class="form-control form-control-sm text-end Remarks" value=""></textarea></td>
                                       <td  class="text-center DocName">${item.DocName}</td>
                                       <td  class="text-center DocNum">${item.Docnum}</td>
                                       <td class="text-center DocumentDate">${item.DocumentDate}</td>
                                       <td class="text-center DueDate">${item.DueDate}</td>
                                       <td hidden class="text-end GLAccount" data-id="${item.LedgerID}" data-code="${item.LedgerCode}">${item.LedgerName}</td>
                                       <td  class="text-end BalanceDue">${parseFloat(item.BalanceDue).toFixed(2) }</td>
                                       <td><input type="number" class="form-control form-control-sm text-end TotalPayment" value="${parseFloat(item.BalanceDue).toFixed(2)}" min="0" step="1"></td>
                                       <td hidden><input style='width:100px!important;' type="text" value='${item.DocEntry}' class="form-control form-control-sm text-end BaseDocEntry" readonly></td>
                                       <td hidden><input style='width:200px!important;' type="text" value='${item.OBJType}' class="form-control form-control-sm text-end BaseObjType" readonly></td>
                                   </tr>

                               `;
                                table.append(newRow);
                                rowCount++;
                            }
                        },
                        error: function(xhr) {
                                    Notify('error', 'Error', xhr.responseText );
                        }
                    });
                }
        }
        //Find Mode
        {
            $("#btnFind").click(function () {
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
                Findmode()
            })
            $("#FindBtnSearch").click(function () {
                Findmode()
            })
            $("#FindBtnReset").click(function () {
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
            })
            function Findmode() {
                var obj = {
                    doctype: $("#doctype").val() || '',
                    docid: $("#fdocid").val() || '',
                    refno: $("#frefno").val() || '',
                    fromdate: $("#ffromdate").val() || '',
                    todate: $("#ftodate").val() || '',
                    docEntry: '',
                };
                $.ajax({
                    url: '@Url.Action("FINDMODE", "Sales")',
                    method: 'GET',
                    data: obj,
                    success: function (response) {
                        const tableBody = $('#receiptListTable tbody');
                        if ($.fn.DataTable.isDataTable('#receiptListTable')) {
                            $('#receiptListTable').DataTable().destroy();
                        }
                        tableBody.empty();
                        response.header.forEach(function (receipt) {
                            const row = `
                                <tr data-docentry='${receipt.DocEntry}'>
                                    <td>${receipt.Docnum}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                            <i class="bi bi-check"></i> Select
                                        </button>
                                    </td>
                                    <td>${receipt.LedgerName}</td>
                                    <td>${receipt.For_PostingDate}</td>
                                    <td>${receipt.RefNo || ''}</td>
                                    <td>${receipt.For_DocStatus}</td>
                                    <td>${receipt.Remarks || ''}</td>
                                    <td>${receipt.CretedByUName}</td>
                                </tr>
                            `;
                            tableBody.append(row);
                        });

                        // ✅ Reinitialize DataTable
                        $('#receiptListTable').DataTable({
                            dom: '<"top"lf>rt<"bottom"ip>',
                            pageLength: 10,
                            lengthMenu: [5, 10, 25, 50, 100],
                            responsive: true,
                            columnDefs: [
                                { orderable: false, targets: [6] }
                            ]
                        });

                        // ✅ Attach event handler (only once if possible, or inside a separate setup)
                        $('#receiptListTable').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                            const docEntry = $(this).data('docentry');
                            loadFindRow(docEntry, $("#doctype").val(), "");
                            $('#receiptListModal').modal('hide');
                        });
                    },
                    error: function (xhr, status, error) {
                        Notify('error', 'Failed to load receipt list', '');
                    }
                });
            }
        }
        async function loadFindRow(docEntry, doctype, flag) {
            try {
                const response = await $.ajax({
                    url: '@Url.Action("FINDMODE", "Sales")',
                    method: 'GET',
                    data: { doctype, docEntry }
                });
                if (!response || !response.header?.length) {
                    Notify('error', 'Find Row Not found');
                    return;
                }

                const header = response.header[0];
                let rows = response.row || [];
                const today = new Date().toISOString().split('T')[0];

                // ✅ safer date formatter
                const formatDateForInput = (dateStr) => {
                    if (!dateStr) return today;
                    const parts = dateStr.split("-");
                    if (parts.length !== 3) return today;
                    const [day, month, year] = parts;
                    return `${year}-${month}-${day}`;
                };
                // ✅ safer number formatter
                const fmtNum = (val, digits = 2) =>
                    isNaN(parseFloat(val)) ? "0.00" : parseFloat(val).toFixed(digits);
                // ✅ bulk header mapping
                const headerMapping = {
                    '#DocumentEntry': header.DocEntry,
                    '#Docnum': header.Docnum,
                    '#DocStatus': header.DocStatus,
                    '#PostingDate': formatDateForInput(header.For_PostingDate),
                    '#DocumentDate': formatDateForInput(header.For_DocumentDate),
                    '#DueDate': formatDateForInput(header.For_DueDate),
                    '#FYearId': header.FYearId,
                    '#LedgerCode': header.LedgerName,
                    '#LedgerType': header.LedgerType,
                    '#RefNo': header.RefNo,
                    '#Remarks': header.Remarks,
                    '#NETTotal': fmtNum(header.NETTotal),
                    '#OpenBalance': fmtNum(header.OpenBalance),
                    '#PayOnAccAmt': fmtNum(header.PayOnAccAmt),
                    '#LedgerBalance': fmtNum(header.LedgerBalance),
                    '#CashLedger': header.CashLedgerId,
                    '#CashAmt': fmtNum(header.CashAmt),
                    '#BankLedger': header.BankLedgerId,
                    '#BankAmt': fmtNum(header.BankAmt),
                    '#ChequeBank': header.ChequeBankId,
                    '#ChequeDate': formatDateForInput(header.For_ChequeDate),
                    '#ChequeNo': header.ChequeNo,
                    '#ChequeAmt': fmtNum(header.ChequeAmt),
                    '#PayRemark': header.PayRemarks,
                };
                if (header.PayOnAccCheck=="N") {
                    $("#PayOnAccAmtCheck").prop("checked", false)
                } else {
                    $("#PayOnAccAmtCheck").prop("checked", true)
                }
                if (header.IsCash == "Y") {
                    $("#CashBtn").addClass("active")
                    $(".Cash").show();
                } else {
                    $("#CashBtn").removeClass("active")
                    $(".Cash").hide();
                }
                if (header.IsBank == "Y") {
                    $("#BankTransBtn").addClass("active")
                    $(".Bank").show();
                } else {
                    $("#BankTransBtn").removeClass("active")
                    $(".Bank").hide();
                }
                if (header.IsCheque == "Y") {
                    $("#ChequeBtn").addClass("active")
                    $(".Cheque").show();
                } else {
                    $(".Cheque").hide();
                    $("#ChequeBtn").removeClass("active")
                }
                loadBPPartnerTable(header.LedgerType)
                formatheader(header.LedgerType)
                for (const [selector, value] of Object.entries(headerMapping)) {
                    $(selector).val(value ?? "");
                }
                if (header.LedgerType == "B") {
                    $('#LedgerCode')
                        .attr('data-id', header.LedgerID)
                        .attr('data-name', header.LedgerName)
                        .attr('data-code', header.LedgerCode)
                        .attr('data-type', header.LedgerType);
                    $('#LedgerCode').val(header.LedgerName);
                    $("#PayOnAccAmtCheck").prop('disabled', false);
                } else {
                    $("#PayOnAccAmtCheck").prop('disabled', true);
                }

                $('#mainitemtable tbody').empty();
                let glitemhide = '';
                let ledgeritemhide = '';
                if (header.LedgerType === 'B') {
                    ledgeritemhide = '';
                    glitemhide = 'hidden';
                } else {
                    ledgeritemhide = 'hidden';
                    glitemhide = '';
                }
                rows.forEach((line, idx) => {
                    const row = `
                        <tr data-id='${line.ID}' class="line-item">
                            <td>${idx + 1}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                            <td ${ledgeritemhide} class="text-center">
                                <input style="height: 20px; width:20px;" type="checkbox" checked class="ItemCheck mt-1" />
                            </td>
                            <td>
                                <textarea style='height:20px;' class="form-control form-control-sm Remarks text-end">${line.Remarks ?? ''}</textarea>
                            </td>
                            <td ${ledgeritemhide} class="text-center DocName">${line.DocName ?? ''}</td>
                            <td ${ledgeritemhide} class="text-center DocNum">${line.DocNum ?? ''}</td>
                            <td class="text-center DocumentDate">${line.For_DocumentDate}</td>
                            <td class="text-center DueDate">${line.For_DueDate}</td>
                            <td ${glitemhide} class="text-end GLAccount" data-id="${line.LedgerID}">${line.LedgerName ?? ''}</td>
                            <td ${ledgeritemhide} class="text-end BalanceDue">${fmtNum(line.BalanceDue)}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm text-end TotalPayment"
                                    value="${fmtNum(line.TotalPayment)}" min="0" step="1">
                            </td>
                            <td hidden>
                                <input style='width:100px!important;' type="text" value='${line.BaseDocEntry ?? ''}'
                                    class="form-control form-control-sm text-end BaseDocEntry" readonly>
                            </td>
                            <td hidden>
                                <input style='width:200px!important;' type="text" value='${line.BaseObjType ?? ''}'
                                    class="form-control form-control-sm text-end BaseObjType" readonly>
                            </td>
                        </tr>`;

                    $('#mainitemtable tbody').append(row);
                });

                if (header.DocStatus === "C") {
                    $('#mainitemtable .remove-line').prop('disabled', true).attr("title", "Cannot remove - Document is closed");
                }

                // ✅ buttons state
                $('#btnSave').prop('disabled', header.DocStatus === "C");
                $('#btnPark').prop('disabled', true);
                $('#btnPrint').prop('disabled', false);
                $('#btnDelete').prop('disabled', false);
                $('#PaymentCancel').prop('disabled', true);

                $('#btnCopyTo').prop('disabled', header.DocStatus === "C");
                $('#btnCopyFrom').prop('disabled', header.DocStatus === "C");

                if (flag === "C") {
                    $('#btnSave, #btnPark').prop('disabled', true);
                }

            } catch (error) {
                console.error('Error loading receipt:', error);
                Notify('error', 'Failed to load receipt', '');
            }
        }
        //Resume
        {
           loadUsers()
           function loadUsers() {
               $.ajax({
                   type: "GET",
                   url: '@Url.Action("GETUSERS", "Auth")',
                   contentType: "application/json; charset=utf-8",
                   cache: true,
                   success: function (data) {
                       if(data.length) {
                           const $select = $('#rUserid');
                           $select.empty();
                           $select.append('<option value="">Select User</option>');
                           data.forEach(user => {
                               $select.append(`<option value="${user.UserID}">${user.Username}</option>`);
                           });
                       }
                   },
                   error: function (xhr) {
                       const errorMessage = xhr.responseJSON?.error || 'Error loading users';
                       Notify('error', 'Error', errorMessage);
                   }
               });
           }
           $("#btnResume").click(function(){
               $("#fdocid").val("")
               $("#frefno,#rrefno").val("")
               $('.datepicker').val(new Date().toISOString().split('T')[0]);
               Resume()
           })
           $("#ResumeBtnSearch").click(function(){
               Resume()
           })
           $("#ResumeBtnReset").click(function(){
               $("#rrefno").val("")
               $('.datepicker').val(new Date().toISOString().split('T')[0]);
           })
            function Resume() {
               var obj = {
                   doctype: $("#doctype").val() || '',
                   refno: $("#rrefno").val() || '',
                   fromdate: $("#rfromdate").val() || '',
                   todate: $("#rtodate").val() || '',
                   Userid: $("#rUserid").val() || '',
                   docEntry:'',
               };
               $.ajax({
                   url: '@Url.Action("RESUMEPARK", "Inventory")',
                   method: 'GET',
                   data: obj,
                   success: function (response) {
                       if (response.length >0) {
                           const tableBody = $('#ResumeModaltbl tbody');
                           if ($.fn.DataTable.isDataTable('#ResumeModaltbl')) {
                               $('#ResumeModaltbl').DataTable().destroy();
                           }
                           var payload = JSON.parse(response[0].Payload);
                           tableBody.empty();
                           var index = 1;
                           response.forEach(function (receipt) {
                               const row = `
                                   <tr data-docentry='${receipt.DocEntry}'>
                                       <td>${index}</td>
                                       <td>
                                           <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                               <i class="bi bi-check"></i> Select
                                           </button>
                                       </td>
                                       <td>${receipt.CreatedDate}</td>
                                       <td>${receipt.RefNo || ''}</td>
                                       <td>${receipt.CretedByUName}</td>
                                       <td hidden class='Payload'>${receipt.Payload}</td>
                                   </tr>
                               `;
                               tableBody.append(row);
                               index++;
                           });

                           // ✅ Reinitialize DataTable
                           $('#ResumeModaltbl').DataTable({
                               dom: '<"top"lf>rt<"bottom"ip>',
                               pageLength: 10,
                               lengthMenu: [5, 10, 25, 50, 100],
                               responsive: true,
                               columnDefs: [
                                   { orderable: false, targets: [] }
                               ]
                           });

                           // ✅ Attach event handler (only once if possible, or inside a separate setup)
                           $('#ResumeModaltbl').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                               const docEntry = $(this).data('docentry');
                               const row = $(this).closest("tr");
                               var data = row.find(".Payload").text();
                               loadresume(JSON.parse(data), docEntry);
                               $('#ResumeModal').modal('hide');
                           });
                       }
                   },
                   error: function(xhr, status, error) {
                       Notify('error', 'Failed to load receipt list', '');
                   }
               });
                async  function loadresume(response, docEntry) {
                    try {
                          isEditMode = true;
                          const header = response.header;
                          const rows = response.lines || [];

                        if (!response || !response.lines?.length) {
                             Notify('error', 'Resume Row Not found');
                             return;
                         }
                         const today = new Date().toISOString().split('T')[0];
                         // ✅ safer date formatter
                         const formatDateForInput = (dateStr) => {
                             if (!dateStr) return today;
                             const parts = dateStr.split("-");
                             if (parts.length !== 3) return today;
                             const [day, month, year] = parts;
                             return `${year}-${month}-${day}`;
                         };
                         // ✅ safer number formatter
                         const fmtNum = (val, digits = 2) =>
                             isNaN(parseFloat(val)) ? "0.00" : parseFloat(val).toFixed(digits);

                         // ✅ bulk header mapping
                         const headerMapping = {
                             '#DocumentEntry': header.DocEntry,
                             '#Docnum': header.Docnum,
                             '#DocStatus': header.DocStatus,
                             '#PostingDate': formatDateForInput(header.For_PostingDate),
                             '#DocumentDate': formatDateForInput(header.For_DocumentDate),
                             '#DueDate': formatDateForInput(header.For_DueDate),
                             '#FYearId': header.FYearId,
                             '#LedgerType': header.LedgerType,
                             '#RefNo': header.RefNo,
                             '#Remarks': header.Remarks,
                             '#NETTotal': fmtNum(header.NETTotal),
                             '#OpenBalance': fmtNum(header.OpenBalance),
                             '#PayOnAccAmt': fmtNum(header.PayOnAccAmt),
                             '#LedgerBalance': fmtNum(header.LedgerBalance),
                             '#CashLedger': header.CashLedgerId,
                             '#CashAmt': fmtNum(header.CashAmt),
                             '#BankLedger': header.BankLedgerId,
                             '#BankAmt': fmtNum(header.BankAmt),
                             '#ChequeBank': header.ChequeBankId,
                             '#ChequeDate': formatDateForInput(header.For_ChequeDate),
                             '#ChequeNo': header.ChequeNo,
                             '#ChequeAmt': fmtNum(header.ChequeAmt),
                             '#PayRemark': header.PayRemarks,
                         };
                         if (header.PayOnAccCheck=="N") {
                             $("#PayOnAccAmtCheck").prop("checked", false)
                         } else {
                             $("#PayOnAccAmtCheck").prop("checked", true)
                         }

                        if (header.IsCash == "Y") {
                            $("#CashBtn").addClass("active")
                            $(".Cash").show();
                        } else {
                            $("#CashBtn").removeClass("active")
                            $(".Cash").hide();
                        }
                        if (header.IsBank == "Y") {
                            $("#BankTransBtn").addClass("active")
                            $(".Bank").show();
                        } else {
                            $("#BankTransBtn").removeClass("active")
                            $(".Bank").hide();
                        }
                        if (header.IsCheque == "Y") {
                            $("#ChequeBtn").addClass("active")
                            $(".Cheque").show();
                        } else {
                            $(".Cheque").hide();
                            $("#ChequeBtn").removeClass("active")
                        }
                        loadBPPartnerTable(header.LedgerType)
                        formatheader(header.LedgerType)
                         for (const [selector, value] of Object.entries(headerMapping)) {
                             $(selector).val(value ?? "");
                         }
                        $('#LedgerCode')
                            .attr('data-id', header.LedgerID)
                            .attr('data-name', header.LedgerName)
                            .attr('data-code', header.LedgerCode)
                            .attr('data-type', header.LedgerType);
                        $('#LedgerCode')
                            .attr('data-id', header.LedgerID)
                         $('#mainitemtable tbody').empty();
                         let glitemhide = '';
                         let ledgeritemhide = '';
                         if (header.LedgerType === 'B') {
                             ledgeritemhide = '';
                             glitemhide = 'hidden';
                         } else {
                             ledgeritemhide = 'hidden';
                             glitemhide = '';
                         }
                         rows.forEach((line, idx) => {
                             const row = `
                                 <tr data-id='${line.ID}' class="line-item">
                                     <td>${idx + 1}</td>
                                     <td class="text-center">
                                         <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                             <i class="bi bi-trash"></i>
                                         </button>
                                     </td>
                                     <td ${ledgeritemhide} class="text-center">
                                         <input style="height: 20px; width:20px;" type="checkbox" checked class="ItemCheck mt-1" />
                                     </td>
                                     <td>
                                         <textarea style='height:20px;' class="form-control form-control-sm Remarks text-end">${line.Remarks ?? ''}</textarea>
                                     </td>
                                     <td ${ledgeritemhide} class="text-center DocName">${line.DocName ?? ''}</td>
                                     <td ${ledgeritemhide} class="text-center DocNum">${line.DocNum ?? ''}</td>
                                     <td class="text-center DocumentDate">${formatDateForInput(line.For_DocumentDate)}</td>
                                     <td class="text-center DueDate">${formatDateForInput(line.For_DueDate)}</td>
                                     <td ${glitemhide} class="text-end GLAccount" data-id="${line.LedgerID}">${line.LedgerName ?? ''}</td>
                                     <td ${ledgeritemhide} class="text-end BalanceDue">${fmtNum(line.BalanceDue)}</td>
                                     <td>
                                         <input type="number" class="form-control form-control-sm text-end TotalPayment"
                                             value="${fmtNum(line.TotalPayment)}" min="0" step="1">
                                     </td>
                                     <td hidden>
                                         <input style='width:100px!important;' type="text" value='${line.BaseDocEntry ?? ''}'
                                             class="form-control form-control-sm text-end BaseDocEntry" readonly>
                                     </td>
                                     <td hidden>
                                         <input style='width:200px!important;' type="text" value='${line.BaseObjType ?? ''}'
                                             class="form-control form-control-sm text-end BaseObjType" readonly>
                                     </td>
                                 </tr>`;

                             $('#mainitemtable tbody').append(row);
                         });
                         // ✅ buttons state
                         $('#btnSave').prop('disabled', false);
                         $('#btnDelete').prop('disabled', false);
                         $('#btnPark').prop('disabled', false)
                         $('#btnPrint').prop('disabled', true)
                          $.ajax({
                                url: '@Url.Action("DELETEPARKDOC", "Inventory")',
                                method: 'GET',
                                data: { id: docEntry },
                                success: function (response) {
                                    Resume()
                                },
                                error: function(xhr, status, error) {
                                    Notify('error', 'Failed to load receipt list', '');
                                }
                            });
                     } catch (error) {
                         console.error('Error loading receipt:', error);
                         Notify('error', 'Failed to load receipt', '');
                     }
               }
           }
        }
        async function GETFREIGHT() {
              $.ajax({
                  type: "GET",
                  url: '@Url.Action("GETACTIVEFREIGHT", "Master")',
                  contentType: "application/json; charset=utf-8",
                  cache: false,
                  success: async function (data) {
                      if (Array.isArray(data) && data.length > 0) {
                          let index = 1;
                          $("#FreightTable tbody").empty();
                          $("#FreightTable tfoot").empty();

                          for (let i = 0; i < data.length; i++) {
                              let item = data[i];
                              let row = $(`
                                  <tr data-id=''>
                                      <td>${index}</td>
                                      <td nowrap data-freid='${item.FreID}' class='FreigthName'>${item.Name}</td>
                                      <td><input style="min-width:180px" value="0" class="form-control form-control-sm FNetAmt"></td>
                                      <td hidden>
                                          <select style="min-width:180px"  class="form-control form-control-sm FTaxId">
                                              <option value="">Select</option>
                                          </select>
                                      </td>
                                      <td hidden class="FTaxAmt">0.00</td>
                                      <td hidden class="FTaxtotal">0.00</td>
                                      <td><textarea style="min-width:180px;height:30px;" class="form-control form-control-sm FRemark"></textarea></td>
                                      <td hidden class="FCGST">0.00</td>
                                      <td hidden class="FCGSTRATE">0</td>
                                      <td hidden class="FSGST">0.00</td>
                                      <td hidden class="FSGSTRATE">0</td>
                                      <td hidden class="FIGST">0.00</td>
                                      <td hidden class="FIGSTRATE">0</td>
                                      <td hidden class="FUTGST">0.00</td>
                                      <td hidden class="FUTGSTRATE">0</td>
                                  </tr>
                              `);

                              $("#FreightTable tbody").append(row);
                              // Load tax codes for this row
                              await GETFREIGHTTAX("", row, row.find(".FTaxId"));
                              // bind events
                              row.find(".FNetAmt, .FTaxId").on("input change", function () {
                                  calculatefreightRow(row);
                                  calculateTotal();
                              });
                              index++;
                          }
                          // Append total footer once
                          $("#FreightTable tfoot").append(`
                              <tr hidden>
                                  <td hidden colspan="4">Total</td>
                                  <td hidden nowrap class="FTaxTot">0.00</td>
                                  <td hidden nowrap class="FNetTot">0.00</td>
                                  <td hidden nowrap class="FSGSTot">0.00</td>
                                  <td hidden nowrap class="FCGSTot">0.00</td>
                                  <td hidden nowrap class="FIGSTTot">0.00</td>
                                  <td hidden nowrap class="FUTGSTTot">0.00</td>
                                  <td hidden colspan="13"></td>
                              </tr>
                          `);
                      }
                  },
                  error: function (xhr) {
                      Notify("error", "Error", xhr.responseText || "Error loading items");
                  }
              });
          }
        // FREIGHT
        {
              function GETFREIGHTTAX(id, row, dropdown) {
                  return new Promise((resolve, reject) => {
                      $.ajax({
                          url: '@Url.Action("GETFREIGHTTAXCODE", "Master")',
                          method: "GET",
                          success: function (response) {
                              response.forEach(function (tax) {
                                  dropdown.append(`
                                      <option value="${tax.TaxCodeId}"
                                          data-rate="${tax.TaxCalRate}"
                                          data-cgst="${tax.CGST}"
                                          data-sgst="${tax.SGST}"
                                          data-igst="${tax.IGST}"
                                          data-utgst="${tax.UTGST}">
                                          ${tax.TaxCode}
                                      </option>
                                  `);
                              });
                              if (id !== "") {
                                  dropdown.val(id).trigger("change");
                              }
                              resolve();
                          },
                          error: function (xhr) {
                              Notify("error", "Error", xhr.responseText);
                              reject();
                          }
                      });
                  });
              }
              function calculatefreightRow(row) {
                  let netAmt = parseFloat(row.find(".FNetAmt").val()) || 0;   // base amount
                  let ddl = row.find(".FTaxId option:selected");
                  let TextTax = ddl.text().trim();
                  let taxCodeVal = ddl.val();

                  // Default rates
                  let cgstRate = 0, sgstRate = 0, igstRate = 0, utgstRate = 0, taxRate = 0;

                  if (taxCodeVal && taxCodeVal !== "") {
                      // Check for UTGST pattern (e.g., "UTGST5%", "UTGST", "UTGST@@5%")
                      const utgstMatch = TextTax.match(/^UTGST\D*(\d+)?%?$/i);
                      if (utgstMatch) {
                          utgstRate = parseFloat(utgstMatch[1]) || 0;
                          taxRate = utgstRate;
                      }
                      // Check for IGST pattern (e.g., "IGST5%", "IGST", "IGST 18%")
                      else if (/^IGST/i.test(TextTax)) {
                          const igstMatch = TextTax.match(/^IGST\D*(\d+)?%?$/i);
                          igstRate = parseFloat(igstMatch?.[1]) || 0;
                          taxRate = igstRate;
                      }
                      // Check for GST pattern (e.g., "GST18%", "GST")
                      else if (/^GST/i.test(TextTax)) {
                          const gstMatch = TextTax.match(/^GST\D*(\d+)?%?$/i);
                          const gstRate = parseFloat(gstMatch?.[1]) || 0;
                          cgstRate = gstRate / 2;  // Split GST rate equally between CGST and SGST
                          sgstRate = gstRate / 2;
                          taxRate = gstRate;
                      }
                      // Fallback for other cases
                      else {
                          taxRate = parseFloat(taxCode.data('rate')) || 0;
                          cgstRate = parseFloat(taxCode.data('cgst')) || 0;
                          sgstRate = parseFloat(taxCode.data('sgst')) || 0;
                          igstRate = parseFloat(taxCode.data('igst')) || 0;
                          utgstRate = parseFloat(taxCode.data('utgst')) || 0;
                      }
                  }

                  // Calculate tax amounts
                  let cgstAmt = (netAmt * cgstRate) / 100;
                  let sgstAmt = (netAmt * sgstRate) / 100;
                  let igstAmt = (netAmt * igstRate) / 100;
                  let utgstAmt = (netAmt * utgstRate) / 100;
                  let taxAmt = cgstAmt + sgstAmt + igstAmt + utgstAmt;
                  let totalAmt = netAmt + taxAmt;

                  // Update row fields (text or input based on your HTML)
                  row.find(".FCGST").text(cgstAmt.toFixed(2));
                  row.find(".FCGSTRATE").text(cgstRate.toFixed(2));


                  row.find(".FSGST").text(sgstAmt.toFixed(2));
                  row.find(".FSGSTRATE").text(sgstRate.toFixed(2));

                  row.find(".FIGST").text(igstAmt.toFixed(2));
                  row.find(".FIGSTRATE").text(igstRate.toFixed(2));

                  row.find(".FUTGST").text(utgstAmt.toFixed(2));
                  row.find(".FUTGSTRATE").text(utgstRate.toFixed(2));

                  row.find(".FTaxtotal").text(totalAmt.toFixed(2));
                  row.find(".FTaxAmt").text(taxAmt.toFixed(2));
              }
            function calculateTotal() {
                  let total = 0;
                  let freataxtotal = 0;
                  let cgsttot = 0;
                  let sgsttot = 0;
                  let igsttot = 0;
                  let utgsttot = 0;

                  $("#FreightTable tbody tr").each(function () {
                      let rowTotal = parseFloat($(this).find(".FTaxtotal").text()) || 0;
                      let taxtotal = parseFloat($(this).find(".FTaxAmt").text()) || 0;
                      let cgst = parseFloat($(this).find(".FCGST").text()) || 0;
                      let sgst = parseFloat($(this).find(".FSGST").text()) || 0;
                      let igst = parseFloat($(this).find(".FIGST").text()) || 0;
                      let utgst = parseFloat($(this).find(".FUTGST").text()) || 0;

                      total += rowTotal;
                      freataxtotal += taxtotal;
                      cgsttot += cgst;
                      sgsttot += sgst;
                      igsttot += igst;
                      utgsttot += utgst;
                  });
                  $(".FNetTot").text(total.toFixed(2));
                  $(".FTaxTot").text(freataxtotal.toFixed(2));
                  $(".FCGSTot").text(cgsttot.toFixed(2));
                  $(".FSGSTot").text(sgsttot.toFixed(2));
                  $(".FIGSTTot").text(igsttot.toFixed(2));
                  $(".FUTGSTTot").text(utgsttot.toFixed(2));
              }

              $("#ResetFreight").click(function () {
                  GETFREIGHT();
              })
              $("#AddFreight").click(function () {
                  var Net_Total = parseFloat($(".FNetTot").text()).toFixed(2)
                  var Freigh_Tax = parseFloat($(".FTaxTot").text()).toFixed(2)
                  var FreighCGSTot_Tax = parseFloat($(".FCGSTot").text()).toFixed(2)
                  var FreighSGSTot_Tax = parseFloat($(".FSGSTot").text()).toFixed(2)
                  var FreighIGSTot_Tax = parseFloat($(".FIGSTTot").text()).toFixed(2)
                  var FreighUTGSTot_Tax = parseFloat($(".FUTGSTTot").text()).toFixed(2)
                  var Net_Amt = Net_Total - Freigh_Tax

                  $("#FreightTotal").val(parseFloat(Net_Amt).toFixed(2))
                  $("#FreightTax").val(parseFloat(Freigh_Tax).toFixed(2))
                  $("#FreightCGSTTax").val(parseFloat(FreighCGSTot_Tax).toFixed(2))
                  $("#FreightSGSTTax").val(parseFloat(FreighSGSTot_Tax).toFixed(2))
                  $("#FreightIGSTTax").val(parseFloat(FreighIGSTot_Tax).toFixed(2))
                  $("#FreightUTGSTTax").val(parseFloat(FreighUTGSTot_Tax).toFixed(2))
                  calculateHeaderTotals();
              })
              $("#ResetFreightCalc").click(function () {
                  $("#FreightTotal").val(0)
                  $("#FreightTax").val(0)
                  $("#FreightCGSTTax").val(0)
                  $("#FreightSGSTTax").val(0)
                  $("#FreightIGSTTax").val(0)
                  $("#FreightUTGSTTax").val(0)
                  calculateHeaderTotals();
              })
          }
        //Copy To
        {
            $(".copytobtn").click(function () {
                var objtype = $(this).attr("data-flag");
                var docentry = $("#DocumentEntry").val();
                if (docentry !== "" && objtype !== "") {
                    sessionStorage.setItem("CopyTodData", `{"objtype":"${$("#doctype").val()}","docentry":"${docentry}"}`)
                    switch (objtype) {
                        case "SD":
                            window.location.href = '@Url.Action("DeliveryNote", "Sales")';
                            break;
                        case "SI":
                             window.location.href = '@Url.Action("SalesInvoice", "Sales")';
                            break;
                        case "MI":
                             window.location.href = '@Url.Action("MaterialIn", "Inventory")';
                            break;
                        case "MO":
                             window.location.href = '@Url.Action("MaterialOut", "Inventory")';
                          break;
                        default:
                    }
                } else {
                    Notify('error', 'Error To Copy','Please select the valid document.');
                }
            });
        }
        //Copy From
        {
              $(".copyfrombtn").click(function () {
                  var objtype1 = $(this).attr('data-flag');
                  var LedgerCode = $("#LedgerCode").attr('data-id');

                  if (!LedgerCode) {
                      Notify('error', 'Please Select Business Partner', '');
                      return;
                  }

                  if (objtype1) {
                      $("#CopyFromModal").modal("show");

                      var obj = {
                          doctype: objtype1,
                          docid: '',
                          refno: '',
                          fromdate: '',
                          todate: '',
                          docEntry: '',
                          status: "O",
                          ledgercode: LedgerCode,
                      };

                      $.ajax({
                          url: '@Url.Action("COPYFROM", "Purchase")',
                          method: 'GET',
                          data: obj,
                          success: function (response) {
                              // ✅ Destroy previous table
                              if ($.fn.DataTable.isDataTable('#copyfromtbl')) {
                                  $('#copyfromtbl').DataTable().destroy();
                              }

                              // ✅ Initialize DataTable with data
                              var mainTable = $('#copyfromtbl').DataTable({
                                  data: response.header,
                                  className: "text-center",
                                  columns: [
                                      {
                                          data: "DocEntry",
                                          render: function (data, type, row) {
                                              return `
                                                  <button class="btn btn-sm btn-success toggle-rows rounded w-50 h-50" data-docentry="${data}">
                                                      <i class="bi bi-plus"></i>
                                                  </button>
                                              `;
                                          },
                                          orderable: false
                                      },
                                      { data: "Docnum" },
                                      { data: "LedgerName" },
                                      { data: "For_PostingDate" },
                                      { data: "RefNo", defaultContent: "" },
                                      { data: "For_DocStatus" },
                                      { data: "Remarks", defaultContent: "" },
                                      { data: "CretedByUName" },
                                  ],
                                  dom: '<"top"lf>rt<"bottom"ip>',
                                  pageLength: 10,
                                  lengthMenu: [5, 10, 25, 50, 100],
                                  responsive: true
                              });

                              // ✅ Handle expand/collapse for nested table
                              $('#copyfromtbl tbody').off('click', '.toggle-rows').on('click', '.toggle-rows', function () {
                                  var tr = $(this).closest('tr');
                                  var row = mainTable.row(tr);
                                  var docEntry = $(this).data('docentry');
                                  if (row.child.isShown()) {
                                      row.child.hide();
                                      $(this).find('i').removeClass('bi-dash').addClass('bi-plus');
                                  } else {
                                       $.ajax({
                                           url: '@Url.Action("COPYFROM", "Purchase")',
                                           method: 'GET',
                                           data: { doctype: objtype1, docEntry: docEntry },
                                           success: async function (response) {
                                               if (!response || !response.header?.length) {
                                                   Notify('error', 'Document not found');
                                                   return;
                                               }
                                               const header = response.header[0];
                                               var rows = response.row || [];
                                               var freight = response.freight || [];
                                               var childRows = response.row.filter(r => r.DocEntry == docEntry);
                                               if (childRows.length > 0) {
                                                   var childTableHtml = `
                                                          <table data-headobj='${JSON.stringify(header)}' data-freight='${JSON.stringify(freight)}' class="table  table-hover table-sm mb-0 nested-table">
                                                              <thead>
                                                                  <tr>
                                                                      <th><input type="checkbox" class="seleccopyfromtall" /></th>
                                                                      <th>ItemCode</th>
                                                                      <th>ItemName</th>
                                                                      <th>Qty</th>
                                                                      <th>Price</th>
                                                                      <th>Tax Code</th>
                                                                      <th>Tax Amt</th>
                                                                      <th hidden>rowobj</th>
                                                                      <th hidden>headobj</th>

                                                                  </tr>
                                                              </thead>
                                                              <tbody>
                                                                  ${childRows.map(r => `
                                                                      <tr>
                                                                          <td>
                                                                              <input type="checkbox" class="select-findrow"
                                                                                  data-docentry="${r.DocEntry}"
                                                                                  data-lineid="${r.LineId}" />
                                                                          </td>
                                                                          <td>${r.ItemCode}</td>
                                                                          <td>${r.ItemName}</td>
                                                                          <td>${parseFloat(r.Quantity).toFixed(2)}</td>
                                                                          <td>${parseFloat(r.UnitePrice).toFixed(2)}</td>
                                                                          <td>${r.TaxCode}</td>
                                                                          <td>${parseFloat(r.TaxAmount).toFixed(2)}</td>
                                                                          <td hidden class='rowobj'>${JSON.stringify(r)}</td>
                                                                      </tr>
                                                                  `).join("")}
                                                              </tbody>
                                                          </table>
                                                      `;
                                                   row.child(childTableHtml).show();
                                                   $(this).find('i').removeClass('bi-plus').addClass('bi-dash');
                                               }

                                           },
                                           error: function (xhr, status, error) {
                                               console.error('Error loading receipt:', error);
                                               Notify('error', 'Failed to load receipt', '');
                                           }
                                       });

                                  }
                              });
                              // ✅ Select all checkbox (per nested table)
                              $(document).on("click", ".seleccopyfromtall", function () {
                                  var isChecked = $(this).is(":checked");
                                  $(this).closest("table").find(".select-findrow").prop("checked", isChecked);
                              });
                          },
                          error: function () {
                              Notify('error', 'Failed to copy from ', '');
                          }
                      });

                  }
              });

              // ✅ Select & Copy rows
              $("#SelectCopyFrom").click(async function () {
                  var rowdata = [];
                  var head = JSON.parse($(".nested-table").attr("data-headobj"))
                  var freightdata = JSON.parse($(".nested-table").attr("data-freight"))

                  $(".nested-table tbody tr").each(function () {
                      var row = $(this);

                      var ischecked = row.find(".select-findrow").is(":checked");
                      if (ischecked) {
                          rowdata.push(JSON.parse(row.find(".rowobj").text()));
                      }

                  });


                  if (rowdata.length === 0) {
                      Notify('warning', 'Please select at least one row', '');
                      return;
                  }

                  const header = head;
                  var rows = rowdata || [];
                  const freight = freightdata || [];
                  const today = new Date().toISOString().split('T')[0];
                  const fmtNum = (val, digits = 2) =>
                      isNaN(parseFloat(val)) ? "0.00" : parseFloat(val).toFixed(digits);
                  const formatDateForInput = (dateStr) => {
                      if (!dateStr) return today;
                      const parts = dateStr.split("-");
                      if (parts.length !== 3) return today;
                      const [day, month, year] = parts;
                      return `${year}-${month}-${day}`;
                  };
                  // ✅ Populate header fields
                  const headerMapping = {
                      '#BaseEntry': header.DocEntry,
                      '#Docnum': header.Docnum,
                      '#DocStatus': header.DocStatus,
                      '#PostingDate': formatDateForInput(header.For_PostingDate),
                      '#DocumentDate': formatDateForInput(header.For_DocumentDate),
                      '#DeliveryDate': formatDateForInput(header.For_DeliveryDate),
                      '#DueDate': formatDateForInput(header.For_DueDate),
                      '#FYearId': header.FYearId,
                      '#LedgerCode': header.LedgerCode,
                      '#RefNo': header.RefNo,
                      '#Remarks': header.Remarks,
                      '#PONo': header.PONo,
                      '#VehicleNo': header.VehicleNo,
                      '#VendorCode': header.VendorCode,
                      '#TransMode': header.TransMode,
                      '#TotalWeight': header.TotalWeight,
                      '#GrossTotal': header.GrossTotal,
                      '#TotalDiscount': parseFloat(header.DisPer).toFixed(2),
                      '#TotalDiscountAmt': parseFloat(header.DisAmount).toFixed(2),
                      '#FreightTotal': parseFloat(header.FreightTotal).toFixed(2),
                      '#aftBillDisc': header.TotalAftBillDisc,
                      '#GSTTotal': header.GSTTotal,
                      '#NETTotal': header.NETTotal,
                      '#Rounding': header.Rounding
                  };

                  for (const [selector, value] of Object.entries(headerMapping)) {
                      $(selector).val(value);
                  }


                  var BaseObj = '';
                  $("#DocumentEntry").val("")
                  $("#Docnum").val("")
                  $("#DocStatus").val("O")
                  $("#DocumentDate").val(new Date().toISOString().split('T')[0])
                  $("#DueDate").val(new Date().toISOString().split('T')[0])
                  $("#PostingDate").val(new Date().toISOString().split('T')[0])
                  $("#DeliveryDate").val(new Date().toISOString().split('T')[0])
                  $("#FYearId").trigger("change")
                  rows = rows.filter(row => row.Status === "O");
                  sessionStorage.removeItem("CopyTodData");
                  BaseObj = header.OBJType

                  $('#LedgerCode')
                      .attr('data-id', header.LedgerID)
                      .attr('data-name', header.LedgerName)
                      .attr('data-code', header.LedgerCode);


                  // ✅ render freight rows
                  $('#FreightTable tbody').empty();
                  for (let i = 0; i < freight.length; i++) {
                      const item = freight[i];
                      const row = $(`
                          <tr data-id='${item.ID}'>
                              <td>${i + 1}</td>
                              <td nowrap data-freid='${item.FreID}' class='FreigthName'>${item.Name}</td>
                              <td><input style="min-width:180px" value="${fmtNum(item.NetAmt)}" class="form-control form-control-sm FNetAmt"></td>
                              <td hidden>
                                  <select style="min-width:180px" class="form-control form-control-sm FTaxId">
                                      <option value="">Select</option>
                                  </select>
                              </td>
                              <td hidden class="FTaxAmt">${fmtNum(item.TaxAmount)}</td>
                              <td hidden class="FTaxtotal">${fmtNum(+item.NetAmt + +item.TaxAmount)}</td>
                              <td><textarea style="min-width:180px;height:30px;" class="form-control form-control-sm FRemark">${item.Remark ?? ''}</textarea></td>
                              <td hidden class="FCGST">${fmtNum(item.CGSTAmt)}</td>
                              <td hidden class="FCGSTRATE">${fmtNum(item.CGSTRate)}</td>
                              <td hidden class="FSGST">${fmtNum(item.SGSTAmt)}</td>
                              <td hidden class="FSGSTRATE">${fmtNum(item.SGSTRate)}</td>
                              <td hidden class="FIGST">${fmtNum(item.IGSTAmt)}</td>
                              <td hidden class="FIGSTRATE">${fmtNum(item.IGSTRate)}</td>
                              <td hidden class="FUTGST">${fmtNum(item.UTGSTAmt)}</td>
                              <td hidden class="FUTGSTRATE">${fmtNum(item.UTGSTRate)}</td>
                          </tr>
                      `);

                      $("#FreightTable tbody").append(row);

                      await GETFREIGHTTAX("1", row, row.find(".FTaxId"));

                      row.find(".FNetAmt, .FTaxId").on("input change", () => {
                          calculatefreightRow(row);
                          calculateTotal();
                      });
                  }
                  calculateTotal();
                  // ✅ freight totals
                  $("#FreightTax").val(fmtNum($(".FTaxTot").text()));
                  $("#FreightCGSTTax").val(fmtNum($(".FCGSTot").text()));
                  $("#FreightSGSTTax").val(fmtNum($(".FSGSTot").text()));
                  $("#FreightIGSTTax").val(fmtNum($(".FIGSTTot").text()));
                  $("#FreightUTGSTTax").val(fmtNum($(".FUTGSTTot").text()));
                  // ✅ Clear rows
                  $('#mainitemtable tbody').empty();
                  // ✅ Process rows
                  const rowPromises = rows.map(async (line, index) => {
                      addNewLineItem();
                      const $row = $('#mainitemtable tbody tr').last();

                      $row.find('.ItemCode').val(line.ItemCode).attr('data-id', line.ItemID);
                      $row.find('.ItemName').val(line.ItemName);
                      $row.find('.ItemHSN').val(line.HSNCode).attr('data-id', line.HSNID);
                      $row.find('.ItemEan').val(line.EanCode);

                          $row.find('.Quantity').val(parseFloat(line.OpenQuantity).toFixed(2));
                          $row.find('.OpenQuantity').val(parseFloat(line.OpenQuantity).toFixed(2));
                          $row.find('.BaseQuantity').val(parseFloat(line.Quantity).toFixed(2));
                          $row.find('.BaseLine').val(line.ID);
                          $row.find('.BaseDocEntry').val(line.DocEntry);
                          $row.find('.BaseObjType').val(BaseObj);


                      $row.find('.Price').val(parseFloat(line.UnitePrice).toFixed(2));
                      $row.find('.DisPer').val(parseFloat(line.DisPer).toFixed(2));
                      $row.find('.Weight1').val(parseFloat(line.Weight1).toFixed(2));
                      $row.find('.Remarks').val(line.Remarks);
                      $row.find('.AcctCode').val(line.AcctCode);

                      await LoadUOM(line.ItemID, $row, "F");
                      $row.find('.ItemUOM').val(line.UOMID);

                      await loadWarehouses(line.ItemID, $row, "F");
                      $row.find('.WhsCode').val(line.WHSID);
                      $row.find('.StockInWhs').val(parseFloat(line.StockInWhs).toFixed(2));

                      await loadTaxCodes("1", $row, $row.find('.TaxCode'));
                      $row.find('.TaxCode').val("1");

                      calculateRowAmounts($row);

                      if (header.DocStatus == "C" || line.Status == 'C') {
                          $row.addClass("table-info")
                              .attr("data-doc-status", "closed");
                          $row.find(".remove-line").prop('disabled', true)
                          $row.find(".openmodal").prop('disabled', true)
                          $row.find("input,textarea").prop('readonly', true)
                          $row.find("select").prop('disabled', true)
                      }
                  });
                  await Promise.all(rowPromises);
                  // ✅ Button state handling
                  if (header.DocStatus == "C") {
                      $('#mainitemtable .remove-line')
                          .prop('disabled', true)
                          .attr("title", "Cannot remove - Document is closed");
                  }

                  $('#btnPrint').prop('disabled', false);
                  $('#btnDelete').prop('disabled', false);
                  $('#btnCopyFrom').prop('disabled', false);
                  $('#btnSave').prop('disabled', false);
                  $('#btnPark').prop('disabled', false);
                  if (header.DocStatus == "C") {
                      $('#btnSave').prop('disabled', true);
                      $('#btnPark').prop('disabled', true);
                      $('#btnCopyFrom').prop('disabled', true);
                  }
              });
        }
    });

</script>