<style>
</style>
<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b>Ledger Opening Balance</b></h3>
                    </div>
                    <div class="col-md-6 d-flex justify-content-end align-items-center flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();
                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        @*   case "Bulk Upload":
                                            <button id="btnBulkUpload" data-bs-toggle="modal" data-bs-target="#bulkUploadModal" class="btn @ColorClass mb-1  me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break; *@
                                        case "Find":
                                            <button id="btnFind" data-bs-toggle="modal" data-bs-target="#receiptListModal" class="btn @ColorClass mb-1  me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Attachments":
                                            <button id="Attachments" data-bs-toggle="modal" data-bs-target="#Attachment" class="btn @ColorClass mb-1   me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Export":
                                            <button id="btnPdf" class="btn btn-outline-danger me-2 mb-1">
                                                <i class="bi bi-file-pdf me-1"></i> PDF
                                            </button>
                                            <button id="btnExcel" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> EXCEL
                                            </button>
                                            <button id="btnCSV" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> CSV
                                            </button>
                                            break;
                                        @* case "Copy From":
                                                <button id="btnCopyFrom" class="btn @ColorClass mb-1  me-2 mb-1">
                                                    <i class="@icon"></i> @btnName
                                                </button>
                                                break;
                                            case "Copy To":
                                                <button id="btnCopyFrom" class="btn @ColorClass mb-1  me-2 mb-1">
                                                    <i class="@icon"></i> @btnName
                                                </button>
                                                break; *@
                                        default:

                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }

                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-end flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Save":
                                            <button id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                
                                        case "Park":
                                            <button id="btnPark" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Resume":
                                            <button id="btnResume" data-bs-toggle="modal" data-bs-target="#ResumeModal" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Print":
                                            <button id="btnPrint" data-bs-toggle="modal" data-bs-target="#PrintModal" class="btn @ColorClass mb-1   me-2" disabled>
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Delete":
                                            <button id="btnDelete" data-action="delete" class="btn @ColorClass mb-1 me-2" disabled>
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>

                <!-- Header Information -->
                <div class="row">
                    <div class="col-md-3 col-6 mb-2" hidden>
                        <input id="DocumentEntry" hidden class="form-control" type="text" readonly />
                        <input id="doctype" type="text" hidden value="LOB" class="form-control" />
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="Docnum" class="form-label">Document Number</label>
                        <input id="Docnum" class="form-control" type="text" readonly />
                    </div>

                    <div class="col-md-3 col-6 mb-2">
                        <label for="DocumentDate" class="form-label">Document Date</label>
                        <input id="DocumentDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="DueDate" class="form-label">Due Date</label>
                        <input id="DueDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="PostingDate" class="form-label">Posting Date</label>
                        <input id="PostingDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="LedgerId" class="form-label">Opening Balance Account</label>
                        <select class="form-control " id="LedgerId">
                        </select>
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="FYearId" class="form-label">Fiscal Year</label>
                        <select id="FYearId" class="form-select">
                            <option value="">Select Fiscal Year</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <label for="RefNo" class="form-label">Reference No</label>
                        <input id="RefNo" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3 col-12 mb-2">
                        <label for="Remarks" class="form-label">Remarks</label>
                        <textarea id="Remarks" class="form-control" rows="1"></textarea>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table  table-hover" id="mainitemtable">
                                <thead class="table-light">
                                    <tr>
                                        <th nowrap>Sr No</th>
                                        <th nowrap>Delete</th>
                                        <th nowrap hidden>Due Date</th>
                                        <th nowrap>Ledger</th>
                                        <th nowrap>Debit</th>
                                        <th nowrap>Credit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-id='' class="line-item rawrow">
                                        <td colspan="5" class="text-center text-secondary">Please Select Opening Balance Account </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="obrow">
                                        <th colspan="3" class="text-end"><span class="SelectedLedger"></span>:</th>
                                        <th class="text-end obdebit"></th>
                                        <th class="text-end obcredite"></th>
                                    </tr>
                                    <tr>
                                        <th colspan="3" class="text-end">Total:</th>
                                        <th class="text-end debittotal"></th>
                                        <th class="text-end credittotal"></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="col-12 text-end mt-2">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Add New Line":
                                            <button class="btn @ColorClass mb-1 " id="btnAddLine"><i class="@icon"></i> @btnName</button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Receipt List Modal -->
<div class="modal fade" id="receiptListModal" tabindex="-1" aria-labelledby="receiptListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptListModalLabel">Find </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-3  mb-2">
                        <label for="fdocid" class="form-label">Document Number</label>
                        <input id="fdocid" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="frefno" class="form-label">Ref Number</label>
                        <input id="frefno" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ffromdate" class="form-label ">From Date</label>
                        <input id="ffromdate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ftodate" class="form-label">To Date</label>
                        <input id="ftodate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-12  mb-2 text-end   mt-3 ">
                        <button class="btn btn-outline-primary me-2" id="FindBtnSearch"><i class="bi bi-search me-2"></i>Find</button>
                        <button class="btn btn-outline-secondary me-2" id="FindBtnReset"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped w-100 display nowrap" id="receiptListTable">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Doc Num</th>
                                <th>Document Date</th>
                                <th>Posting Date</th>
                                <th>Ref No</th>
                                <th>Remarks</th>
                                <th>Created By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Item Search Modal -->
<div class="modal fade" id="itemSearchModal" tabindex="-1" aria-labelledby="itemSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemSearchModalLabel">Item Search</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="col-md-12 text-end mb-3">
                    <button class="btn btn-primary refreshitems">Refresh Items</button>
                </div>
                <div class="table-responsive ">
                    <table class="table table-bordered table-striped table-hover w-100" id="itemSearchTable">
                        <thead>
                            <tr>
                                <th width="5%">Select</th>
                                <th width="15%">Item Code</th>
                                <th width="15%">EAN Code</th>
                                <th width="30%">Item Name</th>
                                <th width="15%">UOM</th>
                                <th width="15%">HSN</th>
                                <th width="20%">Group</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        // Initialize variables
        let currentDocEntry = null;
        let isEditMode = false;
        let selectedRowIndex = null;
        let selectedItemId = null;
        $('.datepicker').val(new Date().toISOString().split('T')[0]);
        loadFiscalYears();
        // Add new line item
        $('#btnAddLine').click(function() {
            addNewLineItem();
        });
        // Save document
        $('#btnSave').click(function() {
            savedocument("S");
        });
        // Save document
        $('#btnPark').click(function () {
            savedocument("P");
        });
        // Update document
        $('#btnUpdate').click(function() {
            savedocument();
        });
        // Delete document
        $('#btnDelete').click(function () {
            deleteDoc()
        });
         function deleteDoc(){
               var id = $('#DocumentEntry').val();
                 if(!id){
                     Notify('error', 'Document Entry is required for deletion','');
                     return;
                 }
                  Swal.fire({
                     title: 'Are you sure?',
                     text: "You won't be able to revert this!",
                     icon: 'warning',
                     showCancelButton: true,
                     confirmButtonColor: '#d33',
                     cancelButtonColor: '#3085d6',
                     confirmButtonText: 'Yes, delete it!'
                 }).then((result) => {
                     if (result.isConfirmed) {
                         $.ajax({
                             url: '@Url.Action("DELETELEDGEROPNING", "Accounts")',
                             type: 'POST',
                             data: { id: $("#DocumentEntry").val() },
                             beforeSend: function() {
                                 $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                             },
                             success: function(response) {
                                 if (response && response.success) {
                                     Notify('success', 'Success', response.message || 'Document deleted successfully!');
                                      resetForm();
                                 } else {
                                     Notify('warning', 'Warning', response.message || 'Document deleted successfully!');
                                 }
                             },
                             error: function(xhr, status, error) {
                                 const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Document';
                                 Notify('error', 'Error', errorMessage);
                             },
                             complete: function() {
                                 $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                             }
                         });
                     }
                 });
             }
        // Reset form
        $('#btnReset').click(function() {
            resetForm();
        });
        // Function to add new line item
        function addNewLineItem() {
            const table = $('#mainitemtable tbody');
            const lastRow = table.find('tr').last();
            // Check if there is at least one row and its ItemCode is empty
            if (!$('#LedgerId').val()) {
                $('#LedgerId').focus();
                return; // Stop execution if the previous row's ItemCode is empty
            }
            table.find(".rawrow").remove();
            const rowCount = table.find('tr').length;
            const newRow = `
                <tr data-id='' class="line-item">
                    <td>${rowCount + 1}</td>
                     <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger remove-line">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td hidden><input   type="date" class="form-control form-control-sm DueDate " value="${new Date().toISOString().split('T')[0]}"></td>
                    <td><input  type="text"  class="form-control form-control-sm LedgerId"></td>
                    <td><input  type="number" class="form-control form-control-sm text-end Debit" min="0" value="" step="1"></td>
                    <td><input  type="number" class="form-control form-control-sm text-end Credit" min="0" value="" step="1"></td>
                </tr>
            `;
            table.append(newRow);
            const newRowElement = table.find('tr').last();
            newRowElement.find('.LedgerId').focus();
            if (rowCount > 0) {
                table.find('tr').each(function () {
                    $(this).find('.remove-line').prop('disabled', false);
                });
            }
        }
        //Total Calculation
        {
            $(document).on("input", ".Credit", function () {
                var row = $(this).closest("tr");
                row.find(".Debit").val("")
                calculatetotal();
            });
            $(document).on("input", ".Debit", function () {
                var row = $(this).closest("tr");
                row.find(".Credit").val("")
                calculatetotal();
            });
            function calculatetotal() {
                let totalcredit = 0;
                let totaldebit = 0;

                // Reset displayed totals
                $(".obcredite, .obdebit, .credittotal, .debittotal").text("0.00");

                $("#mainitemtable tbody tr").each(function () {
                    let row = $(this);

                    // Get values safely and convert to numbers
                    let credit = parseFloat(row.find(".Credit").val()) || 0;
                    let debit = parseFloat(row.find(".Debit").val()) || 0;

                    totalcredit += credit;
                    totaldebit += debit;
                });

                // Calculate balance
                let total = totaldebit - totalcredit;

                if (total > 0) {
                    // Debit is greater → opening credit balance
                    $(".obcredite").text(total.toFixed(2));
                    $(".credittotal").text((totalcredit + total).toFixed(2));
                    $(".debittotal").text(totaldebit.toFixed(2));
                } else {
                    // Credit is greater → opening debit balance
                    $(".obdebit").text(Math.abs(total).toFixed(2));
                    $(".debittotal").text((totaldebit + total*(-1)).toFixed(2));
                    $(".credittotal").text(totalcredit.toFixed(2));
                }
            }


        }
        // Function to load fiscal years
        function loadFiscalYears() {
            // AJAX call to get fiscal years
            $.ajax({
                 url: '@Url.Action("GETOPENFYEAR", "Inventory")',
                method: 'GET',
                success: function(response) {
                    const select = $('#FYearId');
                    select.empty();

                    response.forEach(function(year) {
                        select.append(`<option value="${year.FYearId}">${year.FYear}</option>`);
                    });
                    loadDocNum($("#FYearId").val())
                    loadLedgerMasterTable();
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        $("#FYearId").change(function(){
           loadDocNum($(this).val())
        })
        // Function to load warehouses
        function loadDocNum(id) {
            // AJAX call to get warehouses
            $.ajax({
                url: '@Url.Action("GETLOBDOCNUM", "Accounts")',
                method: 'GET',
                data:{id:id},
                success: function(response) {
                    if(response[0].Success=="true"){
                        $("#Docnum").val(response[0].Message)
                    }else{
                           Notify('error', response[0].Message,'');
                    }
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }


        function savedocument(flag) {
           // removeempty()
            const headerData = getHeaderData();
            const lineItems = getLineItems();
            var url = "";
            if (flag == "S") {
                if (!validateForm(headerData, lineItems)) {
                    return;
                }
            }
            const data = {
                header: headerData,
                lines: lineItems
            };
            // AJAX call to save
          $.ajax({
                url: '@Url.Action("CREATEOPNINGBALANCE", "Accounts")' + '?flag=' + flag + '&doctype=' + $("#doctype").val(),
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data), // Only the object for the [FromBody] parameter
                beforeSend: function () {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    } else {
                        $('#btnPark').prop('disabled', true).html('<i class="bi bi-p-circle"></i> Processing...');
                    }
                },
                success: function (response) {
                    if(response.success){
                        Notify('success', response.message,'');
                        currentDocEntry = response.docEntry;
                        $('#btnDelete').prop('disabled', false);
                        $('#btnCancel').prop('disabled', false);
                        $('#btnPark').prop('disabled', true);
                        $('#DocumentEntry').val(response.docEntry);
                        $('#addFilesButton').click();

                    }else{
                        Notify('error','Faild To Create ', response.message);
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseText || 'Error To Save Document    ';
                    Notify('error', 'Error', errorMessage);
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }
                },
                complete: function () {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }
                }
            });
        }
        function removeempty(){
            var tablerow= $('#mainitemtable tbody tr').length;
            if(tablerow >1){
                $('#mainitemtable tbody tr').each(function(){
                     var row = $(this).closest("tr");
                    if (row.length && !row.find('.LedgerId').val().trim()) {
                        row.remove();
                        return; // Stop execution if the previous row's ItemCode is empty
                    }
                });
            }
        }
        function getHeaderData() {
            return {
                DocEntry: $('#DocumentEntry').val() || null,
                Docnum: $('#Docnum').val(),
                DocumentDate: $('#DocumentDate').val(),
                DueDate: $('#DueDate').val(),
                PostingDate: $('#PostingDate').val(),
                FYearId: $('#FYearId').val(),
                RefNo: $('#RefNo').val(),
                Remarks: $('#Remarks').val(),
                LedgerId: $('#LedgerId').val(),
                LedgerName: $("#LedgerId option:selected").text(),
            };
        }
        function getLineItems() {
            const lineItems = [];
            $('#mainitemtable tbody tr').each(function(index) {
                const row = $(this);
                lineItems.push({
                    ID: row.data('id').toString() || null,
                    DocEntry: null,
                    LedgerId: row.find('.LedgerId').attr("data-id") || null,
                    LedgerName: row.find('.LedgerId').val() ||'',
                    DueDate: row.find('.DueDate').val() ||'',
                    Debit: parseFloat(row.find('.Debit').val()) ||0,
                    Credit: parseFloat(row.find('.Credit').val()) ||0,
                });
            });
            lineItems.push({
                ID:  null,
                DocEntry: null,
                LedgerId: $("#LedgerId").val(),
                LedgerName: $("#LedgerId option:selected").text(),
                DueDate: $("#PostingDate").val(),
                Debit: parseFloat($('.obdebit').text()) || 0,
                Credit: parseFloat($('.obcredite').text()) || 0,
            });
            return lineItems;
        }
        function validateForm(header, lines) {
            if (!header.DocumentDate) {
                Notify('error', 'Document date is required','');
                return false;
            }
            if (!header.DueDate) {
                Notify('error', 'Due date is required','');
                return false;
            }
            if (!header.PostingDate) {
                Notify('error', 'PostingDate date is required','');
                return false;
            }
            if (!header.LedgerId || !header.LedgerName) {
                Notify('error', 'Opening Balance Account is required','');
                return false;
            }

            if (!header.FYearId) {
                Notify('error', 'Fiscal year is required','');
                return false;
            }

            if (lines.length === 0) {
                Notify('error', 'At least one item is required','');
                return false;
            }
            var index= 1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (!line.DueDate) {
                    Notify('error', `DueDate is required for line ${index }`,'');
                    return false;
                }

                if (!line.LedgerId || !line.LedgerName) {
                    Notify('error', `Ledger is required for line ${index}`,'');
                    return false;
                }
                index++;
            }
            return true;
        }
        function resetForm() {
            currentDocEntry = null;
            isEditMode = false;

            // Reset header fields
            $('#DocumentEntry').val('');
            $('#Docnum').val('');
            $('#DocStatus').val('C');
            $('#PostingDate').val(new Date().toISOString().split('T')[0]);
            $('#DocumentDate').val(new Date().toISOString().split('T')[0]);
            $('#DueDate').val(new Date().toISOString().split('T')[0]);
            $('#FYearId').val('');
            $('#RefNo').val('');
            $('#Remarks').val('');
            $('.debittotal,.credittotal').text('');
            $('#Remarks').val('');
            $('#btnPrint').prop('disabled', true)
            $('#btnPark').prop('disabled', false)
            $("#mainitemtable tbody").empty()
            addNewLineItem();
            loadFiscalYears()
            $('#btnSave').prop('disabled', false);
        }
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
        $(document).on('click', '.remove-line', function() {
            const row = $(this).closest('tr');
            const table = $('#mainitemtable tbody');
            const rowCount = table.find('tr').length;

            if (rowCount > 1) {
                row.remove();

                // Update row numbers
                table.find('tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                });

                // Disable remove button if only one row left
                if (table.find('tr').length === 1) {
                    table.find('tr').first().find('.remove-line').prop('disabled', true);
                }
            } else {
                Notify('warning', 'At least one item is required');
            }
        });
        $(document).on('click', '.openmodal', function() {
            selectedRowIndex = null;
            selectedItemId = null;
            const row = $(this).closest('tr');
            selectedRowIndex = row.index();
        });

        $(document).on('click', '.btnSelectItem', function() {
            const row = $(this).closest('tr');
            if (selectedRowIndex !== null) {
                const targetRow = $('#mainitemtable tbody tr').eq(selectedRowIndex);
                SetItem(row.data('item-id'), targetRow)
                $('#itemSearchModal').modal('hide');
            } else {
                Notify('warning', 'No target row selected','');
            }
        });
       // Item Search
       {
            $('.refreshitems').click(function() {
                loadLedgerMasterTable()
            });
            var Ledgerrowdata = [];
            var $activeInput = null;
            function loadLedgerMasterTable() {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GETLOBLEDGERS", "Accounts")',
                    contentType: "application/json; charset=utf-8",
                    data: { FYearId: $("#FYearId").val() },
                    cache: false,
                    success: function (data) {
                        Ledgerrowdata = [];
                        Ledgerrowdata = Array.isArray(data) ? data : [];
                    },
                    error: function (xhr) {
                        Notify('error', 'Error', xhr.responseText || 'Error loading items');
                    }
                });
            }
          
            // Function to create item suggestions based on input
            function CreateItemList(inputClass) {
                $(document).on('input', "#mainitemtable tbody tr td ." + inputClass, function () {
                    var $input = $(this);
                    $activeInput = $input;
                    var value = $input.val().toLowerCase().replace(/_/g, ' ');
                    var suggestions = [];
                    var suggestionContainerId = 'ItemNameSuggestions-' + $input.closest('tr').index();
                    if (!$('#' + suggestionContainerId).length) {
                        $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
                    }
                    var $suggestionContainer = $('#' + suggestionContainerId);
                    $suggestionContainer.empty();

                    if (Array.isArray(Ledgerrowdata) && Ledgerrowdata.length > 0) {
                        if (value.length > 0) {
                            var searchTokens = value.split(/\s+/);
                            suggestions = Ledgerrowdata.filter(function (data) {
                                if (data && typeof data === 'object') {
                                    var code = (data.GroupName || '').toLowerCase();
                                    var name = (data.GroupName || '').toLowerCase();
                                    var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                                    return searchTokens.every(function (token) {
                                        return allTokens.some(function (itemToken) {
                                            return itemToken.includes(token);
                                        });
                                    });
                                }
                                return false;
                            }).sort(function (a, b) {
                                return a.GroupName.localeCompare(b.GroupName);
                            }).slice(0, 20);
                        }

                        if (suggestions.length > 0) {
                            suggestions.forEach(function (data) {
                                $suggestionContainer.append(
                                    `<div class="suggestion-item MItemList" data-id="${data.ID || ''}" data-name="${data.GroupName || ''}">
                                        <span class="supplier-name">${data.GroupName || ''}</span>
                                     </div>`
                                );
                            });

                            var offset = $input.offset();
                            $suggestionContainer.css({
                                top: offset.top + $input.outerHeight(),
                                left: offset.left,
                                width: $input.outerWidth(),
                                position: 'absolute',
                                "z-index": 1000
                            }).show();
                        } else {
                            $suggestionContainer.hide();
                        }
                    } else {
                        console.error("ItemData is empty or not defined");
                        $suggestionContainer.hide();
                    }
                });
            }
            CreateItemList("LedgerId");
            $(document).on('click', '.MItemList', function () {
                var id = $(this).data('id');
                var name = $(this).data('name');
                if ($activeInput) {
                    $activeInput.attr("data-id",id)
                    $activeInput.val(name)
                }
                $('.suggestions-container').hide();
            });
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.suggestions-container, .ItemCode').length) {
                    $('.suggestions-container').hide();
                }
            });
            $(document).on("change",".ItemEan",function(){
              var row =$(this).closest("tr");
              var eancode =row.find(".ItemEan").val();
              SetItem(eancode,row)
            })
             $(document).on("change",".ItemCode",function(){
                var row =$(this).closest("tr");
                var ItemCode =row.find(".ItemCode").val();
                if(ItemCode !=="" && ItemCode !==null){
                SetItem(ItemCode.trim(),row)
                }
            })
            function SetItem(id, row) {
                if (id) {
                    $.ajax({
                        type: "GET",
                        url: '@Url.Action("GETACTIVEITEMSBYIDINVENTORY", "Inventory")',
                        data: { id: id },
                        contentType: "application/json; charset=utf-8",
                        cache: false,
                        success: function (data) {
                            if (data.length>0) {
                                var item = data[0];
                                if(validateduplicateitem(item.ItemID)){
                                    LoadUOM(item.ItemID,row)
                                    loadWarehouses(item.ItemID,row,"")
                                    row.find('.ItemCode').val(item.ItemCode);
                                    row.find('.ItemCode').attr("data-id",item.ItemID);
                                    row.find('.ItemName').val(item.ItemName);
                                    row.find('.ItemHSN').val(item.HSNCode);
                                    row.find('.ItemCost').val(item.ItemCost);
                                    row.find('.ItemHSN').attr("data-id",item.HSNID);
                                    row.find('.ItemUOM').val(item.UomCode);
                                    row.find('.ItemEan').val(item.EanCode);
                                    row.find('.AcctCode').val(item.AcctCode);
                                    row.find('.Status').val("O");
                                    row.find('.BaseLine').val("");
                                    row.find('.BaseDocEntry').val("");
                                    row.find('.BaseObjType').val("");
                                    row.find('.Price').val(item.Price ||0);
                                    $("#btnAddLine").click();
                                }

                            }else{
                                //Notify('info',"No Item Found.","Try Again..!")
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error loading item by ID');
                        }
                    });
                }
            }
            function validateduplicateitem(id) {
                 var index = 1;
                 var isDuplicate = false;
                 $('#mainitemtable tbody tr').each(function() {
                     var row = $(this);
                     // Corrected the data attribute access
                     var tablid = row.find(".ItemCode").attr('data-id'); // or .attr('data-id') depending on your HTML
                     if (id == tablid) {
                         Notify('error', 'Item Already Selected In Line No ' + index, '');
                         isDuplicate = true;
                         return false; // This breaks the each loop
                     }
                     index++;
                 });
                 return !isDuplicate; // Return true if no duplicate found
            }
        }
        // Ledger Search
        {
            function LoadLedgers() {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GETDEFALLOBLEDG", "Accounts")',
                    contentType: "application/json; charset=utf-8",
                    cache: false,
                    success: function (data) {
                        if (data.length>0) {
                            for (var i = 0; i < data.length; i++) {
                                $("#LedgerId").append(`<option value='${data[i].DefLedgerId}'>${data[i].DefLedgerName}</option>`);
                            }
                            addNewLineItem();
                            Selectledgerintable()
                        }
                    },
                    error: function (xhr) {
                        Notify('error', 'Error', xhr.responseText || 'Error loading items');
                    }
                });
            }
            $("#LedgerId").change(function () {
                Selectledgerintable();
            });

            function Selectledgerintable() {
                var SelectedLedger = $("#LedgerId option:selected").text();
                $(".SelectedLedger").text(SelectedLedger);
            }

            LoadLedgers();
        }
       //Find Mode
       {

            $("#btnFind").click(function(){
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
               $('.datepicker').val(new Date().toISOString().split('T')[0]);
               Findmode()
            })
            $("#FindBtnSearch").click(function(){
               Findmode()
            })
            $("#FindBtnReset").click(function(){
              $("#fdocid").val("")
              $("#frefno,#rrefno").val("")
              $('.datepicker').val(new Date().toISOString().split('T')[0]);
            })
            function Findmode() {
                var obj = {
                    doctype: $("#doctype").val() || '',
                    docid: $("#fdocid").val() || '',
                    refno: $("#frefno").val() || '',
                    fromdate: $("#ffromdate").val() || '',
                    todate: $("#ftodate").val() || '',
                    docEntry:'',
                };
               $.ajax({
                    url: '@Url.Action("FINDMODE", "Accounts")',
                    method: 'GET',
                    data: obj,
                    success: function (response) {
                        const tableBody = $('#receiptListTable tbody');
                        // Destroy existing DataTable if already initialized
                        if ($.fn.DataTable.isDataTable('#receiptListTable')) {
                            $('#receiptListTable').DataTable().clear().destroy();
                        }
                        tableBody.empty();
                        // Populate rows
                        response.header.forEach(function (receipt) {
                            const row = `
                                <tr data-docentry='${receipt.DocEntry}'>
                                    <td>
                                        <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                            <i class="bi bi-check"></i> Select
                                        </button>
                                    </td>
                                    <td>${receipt.Docnum}</td>
                                    <td>${receipt.For_DocumentDate}</td>
                                    <td>${receipt.For_PostingDate}</td>
                                   
                                    <td>${receipt.RefNo || ''}</td>
                                    <td>${receipt.Remarks || ''}</td>
                                    <td>${receipt.CretedByUName}</td>
                                </tr>
                            `;
                            tableBody.append(row);
                        });

                        // ✅ Reinitialize DataTable correctly
                        $('#receiptListTable').DataTable({
                            dom: '<"top"lf>rt<"bottom"ip>',
                            pageLength: 10,
                            responsive: true,
                            columnDefs: [
                                { orderable: false, targets: [0] } // Disable sorting only for "Action" column
                            ]
                        });

                        // ✅ Bind event safely
                        $('#receiptListTable').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                            const docEntry = $(this).data('docentry');
                            loadReceipt(docEntry);
                            $('#receiptListModal').modal('hide');
                        });
                    },
                    error: function (xhr, status, error) {
                        Notify('error', 'Failed to load receipt list', '');
                    }
                });

                function loadReceipt(docEntry) {
                    // AJAX call to get receipt details
                    $.ajax({
                        url: '@Url.Action("FINDMODE", "Accounts")',
                        method: 'GET',
                        data: { doctype: $("#doctype").val(), docEntry: docEntry },
                        success: function (response) {
                            currentDocEntry = response.header[0].docEntry;
                            isEditMode = true;

                            var item = response.header[0];
                            const today = new Date().toISOString().split('T')[0];
                            // ✅ safer date formatter
                            const formatDateForInput = (dateStr) => {
                                if (!dateStr) return today;
                                const parts = dateStr.split("-");
                                if (parts.length !== 3) return today;
                                const [day, month, year] = parts;
                                return `${year}-${month}-${day}`;
                            };
                            // Populate header fields
                            $('#DocumentEntry').val(item.DocEntry);
                            $('#Docnum').val(item.Docnum);
                            $('#DocStatus').val(item.DocStatus);
                            $('#DocumentDate').val(formatDateForInput(item.For_DocumentDate));
                            $('#PostingDate').val(formatDateForInput(item.For_PostingDate));
                            $('#DueDate').val(formatDateForInput(item.For_DueDate));
                            $('#LedgerId').val(item.LedgerId);
                            $('#FYearId').val(item.FYearId);
                            $('#RefNo').val(item.RefNo);
                            $('#Remarks').val(item.Remarks);

                            // Populate line items
                            $('#mainitemtable tbody').empty();

                            response.row.forEach(function (line, index) {
                                // Skip the last row
                                if (index === response.row.length - 1) return;

                                const row = `
                                    <tr data-id='${line.ID}' class="line-item">
                                        <td>${index + 1}</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-danger remove-line">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                        <td hidden><input type="date"  class="form-control form-control-sm DueDate" value="${formatDateToYMD(line.DueDate)}"></td>
                                        <td><input data-id="${line.LedgerId}"  type="text" class="form-control form-control-sm LedgerId" value="${line.LedgerName}"></td>
                                        <td><input type="number" class="form-control form-control-sm text-end Debit" min="0" value="${parseFloat(line.Debit).toFixed(2)}" step="1"></td>
                                        <td><input type="number" class="form-control form-control-sm text-end Credit" min="0" value="${parseFloat(line.Credit).toFixed(2)}" step="1"></td>
                                    </tr>
                                `;
                                $('#mainitemtable tbody').append(row);
                            });

                            function formatDateToYMD(dateStr) {
                                const [datePart] = dateStr.split(' ');
                                const [day, month, year] = datePart.split('-');
                                return `${year}-${month}-${day}`;
                            }
                            calculatetotal();

                            $('#btnPark').prop('disabled', true);
                            $('#btnDelete').prop('disabled', false);
                            $('#btnPrint').prop('disabled', false);
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading receipt:', error);
                            Notify('error', 'Failed to load receipt');
                        }
                    });
                }

            }
       }
       //Resume
        {
            loadUsers()
             function loadUsers() {
                 $.ajax({
                     type: "GET",
                     url: '@Url.Action("GETUSERS", "Auth")',
                     contentType: "application/json; charset=utf-8",
                     cache: true,
                     success: function (data) {
                         if(data.length) {
                             const $select = $('#rUserid');
                             $select.empty();
                             $select.append('<option value="">Select User</option>');
                             data.forEach(user => {
                                 $select.append(`<option value="${user.UserID}">${user.Username}</option>`);
                             });
                         }
                     },
                     error: function (xhr) {
                         const errorMessage = xhr.responseJSON?.error || 'Error loading users';
                         Notify('error', 'Error', errorMessage);
                     }
                 });
             }
            $("#btnResume").click(function(){
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
                Resume()
            })
            $("#ResumeBtnSearch").click(function(){
                Resume()
            })
            $("#ResumeBtnReset").click(function(){
                $("#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
            })
            function Resume() {
                var obj = {
                    doctype: $("#doctype").val() || '',
                    refno: $("#rrefno").val() || '',
                    fromdate: $("#rfromdate").val() || '',
                    todate: $("#rtodate").val() || '',
                    Userid: $("#rUserid").val() || '',
                    docEntry:'',
                };
                $.ajax({
                    url: '@Url.Action("RESUMEPARK", "Inventory")',
                    method: 'GET',
                    data: obj,
                    success: function (response) {
                        const tableBody = $('#ResumeModaltbl tbody');
                        if ($.fn.DataTable.isDataTable('#ResumeModaltbl')) {
                            $('#ResumeModaltbl').DataTable().destroy();
                        }
                        tableBody.empty();
                        // ✅ Check if response is valid and has data
                        if (!response || response.length === 0) {

                            return;
                        }
                        var payload = JSON.parse(response[0].Payload);
                        var index = 1;
                        response.forEach(function(receipt) {
                            const row = `
                                <tr data-docentry='${receipt.DocEntry}'>
                                     <td>${index}</td>
                                     <td>
                                        <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                            <i class="bi bi-check"></i> Select
                                        </button>
                                    </td>
                                    <td>${receipt.CreatedDate}</td>
                                    <td>${receipt.RefNo || ''}</td>
                                    <td>${receipt.CretedByUName}</td>
                                    <td hidden class='Payload'>${receipt.Payload}</td>
                                </tr>
                            `;
                            tableBody.append(row);
                            index++;
                        });

                        // ✅ Reinitialize DataTable
                        $('#ResumeModaltbl').DataTable({
                            dom: '<"top"lf>rt<"bottom"ip>',
                            pageLength: 10,
                            lengthMenu: [5, 10, 25, 50, 100],
                            responsive: true,
                            columnDefs: [
                                { orderable: false, targets: [] }
                            ]
                        });

                        // ✅ Attach event handler (only once if possible, or inside a separate setup)
                        $('#ResumeModaltbl').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                            const docEntry = $(this).data('docentry');
                            const row = $(this).closest("tr");
                            var data = row.find(".Payload").text();
                            loadresume(JSON.parse(data), docEntry);
                            $('#ResumeModal').modal('hide');
                        });
                    },
                    error: function(xhr, status, error) {
                        Notify('error', 'Failed to load Data', '');
                    }
                });
                function loadresume(response, docEntry) {
                    isEditMode = true;
                    var item =response.header;
                    // Populate header fields
                    $('#PostingDate').val(formatDateForInput(item.PostingDate));
                    $('#DocumentDate').val(formatDateForInput(item.DocumentDate));
                    $('#DueDate').val(formatDateForInput(item.DueDate));
                    $('#FYearId').val(item.FYearId).trigger("change");
                    $('#RefNo').val(item.RefNo);
                    $('#Remarks').val(item.Remarks);
                    $('#LedgerId').val(item.LedgerId);
                    // Populate line items
                    $('#mainitemtable tbody').empty();
                    response.lines.forEach(function (line, index) {
                        // Skip the last row
                      
                            if (index === response.lines.length - 1) return;

                        const row = `
                                      <tr data-id=' ' class="line-item">
                                          <td>${index + 1}</td>
                                          <td class="text-center">
                                              <button class="btn btn-sm btn-outline-danger remove-line">
                                                  <i class="bi bi-trash"></i>
                                              </button>
                                          </td>
                                          <td hidden><input type="date"  class="form-control form-control-sm DueDate" value="${line.DueDate}"></td>
                                          <td><input data-id="${line.LedgerId}"  type="text" class="form-control form-control-sm LedgerId" value="${line.LedgerName}"></td>
                                          <td><input type="number" class="form-control form-control-sm text-end Debit" min="0" value="${parseFloat(line.Debit).toFixed(2)}" step="1"></td>
                                          <td><input type="number" class="form-control form-control-sm text-end Credit" min="0" value="${parseFloat(line.Credit).toFixed(2)}" step="1"></td>
                                      </tr>
                                  `;
                        $('#mainitemtable tbody').append(row);
                    });

                    function formatDateToYMD(dateStr) {
                        const [datePart] = dateStr.split(' ');
                        const [day, month, year] = datePart.split('-');
                        return `${year}-${month}-${day}`;
                    }
                    calculatetotal();
                    $('#btnPark').prop('disabled', false)
                    $('#btnPrint').prop('disabled', true)
                    $.ajax({
                        url: '@Url.Action("DELETEPARKDOC", "Inventory")',
                        method: 'GET',
                        data: { id: docEntry },
                        success: function (response) {
                            Resume()
                        },
                        error: function(xhr, status, error) {
                            Notify('error', 'Failed to delete record', '');
                        }
                    });
                }
            }
        }
    });
</script>