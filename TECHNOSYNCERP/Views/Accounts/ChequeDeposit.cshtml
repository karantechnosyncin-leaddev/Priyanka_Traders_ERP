<style>
</style>
<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b>Cheque Deposit</b></h3>
                    </div>
                    <div class="col-md-6 d-flex justify-content-end align-items-center flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {

                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();
                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Find":
                                            <button id="btnFind" data-bs-toggle="modal" data-bs-target="#receiptListModal" class="btn @ColorClass mb-1  me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Attachments":
                                            <button id="Attachments" data-bs-toggle="modal" data-bs-target="#Attachment" class="btn @ColorClass mb-1   me-2 mb-1">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Export":
                                            <button id="btnPdf" class="btn btn-outline-danger me-2 mb-1">
                                                <i class="bi bi-file-pdf me-1"></i> PDF
                                            </button>
                                            <button id="btnExcel" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> EXCEL
                                            </button>
                                            <button id="btnCSV" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> CSV
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-end flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Save":
                                            <button id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i>Add
                                            </button>
                                            break;
                                        @*    case "Update":
                                            <button id="btnUpdate" data-action="update" class="btn @ColorClass mb-1  me-2" disabled>
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break; *@
                                        case "Park":
                                            <button id="btnPark" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Resume":
                                            <button id="btnResume" data-bs-toggle="modal" data-bs-target="#ResumeModal" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break;
                                        case "Print":
                                            <button id="btnPrint" data-bs-toggle="modal" data-bs-target="#PrintModal" class="btn @ColorClass mb-1   me-2" disabled>
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Delete":
                                            <button id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>

                <!-- Header Information -->
                <div class="row g-3">
                    <!-- Hidden Inputs -->
                    <div class="col-12 d-none">
                        <input id="DocumentEntry" hidden class="form-control" type="text" readonly />
                        <input data-obj="" id="BaseEntry" hidden class="form-control" type="text" readonly />
                        <input id="doctype" type="text" hidden value="ACD" class="form-control" />
                    </div>

                    <div class="col-12 col-sm-6 col-md-3 ">
                        <label for="Docnum" class="form-label">Document Number</label>
                        <input id="Docnum" class="form-control" type="text" readonly />
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 ">
                        <label for="DocumentDate" class="form-label">Document Date</label>
                        <input id="DocumentDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 ">
                        <label for="PostingDate" class="form-label">Posting Date</label>
                        <input id="PostingDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="RefNo" class="form-label">Reference No</label>
                        <input id="RefNo" class="form-control" type="text" />
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="LedgerId" class="form-label">Deposit Bank Name</label>
                        <select class="form-control " id="LedgerId">
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="Remarks" class="form-label">Remarks</label>
                        <textarea id="Remarks" class="form-control" rows="1"></textarea>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3 ">
                        <label for="FYearId" class="form-label">Fiscal Year</label>
                        <select id="FYearId" class="form-select">
                            <option value="">Select Fiscal Year</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>

                </div>

                <!-- Line Items -->
                <div class="row mt-4">
                    <div class="col-12 col-md-3">
                        <label>Search</label>
                        <input type="text" id="tableSearch" class="form-control form-control-sm mb-2 " placeholder="Search...">
                    </div>
                    <div class="col-12 col-md-9">

                    </div>
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table  table-hover" id="mainitemtable">
                                <thead class="table-light">
                                    <tr>
                                        <th nowrap>Sr No</th>
                                        <th nowrap>Delete</th>
                                        <th nowrap class="text-center"><input style="height: 20px; width:20px;" type="checkbox" id="ItemCheckAll" class="ItemCheckAll" /></th>
                                        <th nowrap>Party Name</th>
                                        <th nowrap>Document Number</th>
                                        <th nowrap>Document Date</th>
                                        <th nowrap>Cheque No</th>
                                        <th nowrap>Cheque Date</th>
                                        <th nowrap>Cheque Amount</th>
                                        <th nowrap>Cheque Bank</th>
                                        <th nowrap>Ref No</th>
                                        <th nowrap>Remark</th>
                                        <th hidden nowrap>BaseDocEntry</th>
                                        <th hidden nowrap>BaseObjType</th>
                                        <th hidden nowrap>ChequeLedgerId</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>

                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <!-- ERP-Style Footer Summary - Optimized -->
                <div class="container-fluid mt-4 border-top pt-3 small">
                    <div class="row g-2">
                        <div class="col-md-2  col-lg-4 col-xl-9">

                        </div>
                        <!-- Tax Summary with Modal Trigger -->
                        <div class="col-md-10 col-lg-8 col-xl-3">
                            <div class="row g-2">
                                <div class="col-md-12 text-end">
                                    <label class="form-label fw-bold text-dark small">
                                        <i class="bi bi-currency-rupee text-success"></i>  Total Amount
                                    </label>
                                    <input id="NETTotal" class="form-control form-control-sm fw-bold text-end bg-success bg-opacity-0 text-white" type="text" readonly value="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals -->
<!-- Ledger Search Modal -->
<div class="modal fade" id="ledgerListModal" tabindex="-1" aria-labelledby="ledgerListLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ledgerListModalLabel">Customer Search</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive ">
                    <table class="table table-bordered table-striped table-hover w-100" id="ledegerSearchTable">
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Find Mode Modal -->
<div class="modal fade" id="receiptListModal" tabindex="-1" aria-labelledby="receiptListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptListModalLabel">Find </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-3  mb-2">
                        <label for="fdocid" class="form-label">Document Number</label>
                        <input id="fdocid" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="frefno" class="form-label">Ref Number</label>
                        <input id="frefno" class="form-control" type="text" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ffromdate" class="form-label ">From Date</label>
                        <input id="ffromdate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-3  mb-2">
                        <label for="ftodate" class="form-label">To Date</label>
                        <input id="ftodate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-12  mb-2 text-end   mt-3 ">
                        <button class="btn btn-outline-primary me-2" id="FindBtnSearch"><i class="bi bi-search me-2"></i>Find</button>
                        <button class="btn btn-outline-secondary me-2" id="FindBtnReset"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped w-100 display nowrap" id="receiptListTable">
                        <thead>
                            <tr>
                                <th>Doc Num</th>
                                <th>Action</th>
                                <th>Business Partner</th>
                                <th>Posting Date</th>
                                <th>Ref No</th>
                                <th>Remarks</th>
                                <th>Created By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        // Initialize variables
        let selectedRowIndex = null;
        $('.datepicker').val(new Date().toISOString().split('T')[0]);
        loadFiscalYears();
        // Add new line item
        $('#AddAccLine').click(function() {
            addNewLineItem();
        });
        $('#btnSave').click(function () {
            savedocument("S");
        });
        // Save document
        $('#btnPark').click(function () {
            savedocument("P");
        });
        // Update document
        $('#btnUpdate').click(function() {
            savedocument();
        });
        // Reset form
        $('#btnReset').click(function() {
            resetForm();
        });
        $('#btnDelete').click(function() {
            deleteDoc();
        });
        // Function to add new line item
        function LoadRowData() {
            $.ajax({
                url: '@Url.Action("GETCHEQUEDEPOSITEROW", "Accounts")',
                method: 'GET',
                success: function (response) {

                    const table = $('#mainitemtable tbody');
                    table.empty()
                    if (response.length > 0) {
                        var rowCount = 1;
                        for (var i = 0; i < response.length; i++) {
                            var item = response[i];
                            const newRow = `
                                        <tr data-id='' class="line-item">
                                            <td>${rowCount}</td>
                                             <td class="">
                                                 <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                                     <i class="bi bi-trash"></i>
                                                 </button>
                                             </td>
                                            <td  class="text-center">
                                                 <input style="height: 20px; width:20px;" type="checkbox" class="ItemCheck mt-1" />
                                             </td>
                                            <td nowrap  class=" LedgerName" data-id='${item.LedgerID}'>${item.LedgerName}</td>
                                            <td nowrap  class=" DocNum">${item.Docnum}</td>
                                            <td nowrap  class=" DocumentDate">${item.DocumentDate.split(' ')[0]}</td>
                                            <td nowrap  class=" ChequeNo">${item.ChequeNo}</td>
                                            <td nowrap  class=" ChequeDate">${item.ChequeDate.split(' ')[0]}</td>
                                            <td nowrap  class="text-end ChequeAmt">${parseFloat(item.ChequeAmt).toFixed(2)}</td>
                                            <td nowrap  class=" ChequeBankId" data-id='${item.BankID}'>${item.BankName}</td>
                                            <td nowrap  class=" RefNo">${item.RefNo}</td>
                                            <td nowrap  class=" Remarks">${item.Remarks}</td>
                                            <td hidden><input style='width:100px!important;' type="text" value='${item.BaseDocEntry}' class="form-control form-control-sm text-end BaseDocEntry" readonly></td>
                                            <td hidden><input style='width:200px!important;' type="text" value='${item.BaseObjType}' class="form-control form-control-sm text-end BaseObjType" readonly></td>
                                            <td hidden><input style='width:200px!important;' type="text" value='${item.ChequeLedgerId}' class="form-control form-control-sm text-end ChequeLedgerId" readonly></td>
                                        </tr>

                            `;
                            table.append(newRow);
                            rowCount++;
                        }
                    }
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        LoadRowData()
        function deleteDoc(){
            var id = $('#DocumentEntry').val();
            if(!id){
                Notify('error', 'Document Entry is required for deletion','');
                return;
            }
             Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETEQUEDEPOSIT", "Accounts")',
                        type: 'POST',
                        data: { id: $("#DocumentEntry").val() },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'Document deleted successfully!');
                                 resetForm();
                            } else {
                                Notify('warning', 'Warning', response.message || 'Document deleted successfully!');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Document';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        }
      
        $(document).on("click","#PayOnAccAmtCheck", function () {
            if ($(this).is(":checked")) {
                $("#PayOnAccAmt").val("0.00").prop("readonly", false)
            } else {
                $("#PayOnAccAmt").val("0.00").prop("readonly", true)
            }
            calculateHeaderTotals()
        })
        // Function to calculate header totals
        $(document).on("click", ".ItemCheck", function () {
            calculateHeaderTotals();
        });
        $(document).on("click", ".ItemCheckAll", function () {
            $("#mainitemtable tbody").find(".ItemCheck").prop("checked", $(this).is(":checked"));
            calculateHeaderTotals();
        });
        // Function to calculate header totals
        function calculateHeaderTotals() {
            let totalPayment = 0;

            $('#mainitemtable tbody tr:visible').each(function () {   // ✅ only visible rows
                const paymentValue = parseFloat($(this).find('.ChequeAmt').text()) || 0;
                const isChecked = $(this).find('.ItemCheck').is(":checked");

                if (isChecked) {
                    totalPayment += paymentValue;
                }
            });

            $('#NETTotal').val(totalPayment.toFixed(2));
        }

        function loadFiscalYears() {
            $.ajax({
                 url: '@Url.Action("GETOPENFYEAR", "Inventory")',
                method: 'GET',
                success: function(response) {
                    const select = $('#FYearId');
                    select.empty();

                    response.forEach(function(year) {
                        select.append(`<option value="${year.FYearId}">${year.FYear}</option>`);
                    });
                    loadDocNum($("#FYearId").val())
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        $("#FYearId").change(function(){
           loadDocNum($(this).val())
        })
         function LoadDepositBank() {
            $.ajax({
                url: '@Url.Action("GETBANKSLEDGERS", "Accounts")',
                method: 'GET',
                success: function (response) {
                    const select = $('#LedgerId');
                    select.empty();
                    select.append('<option value="">Select</option>');
                    response.forEach(function(year) {
                        select.append(`<option value="${year.ID}">${year.GroupName }</option>`);
                    });
                },
                error: function(xhr) {
                            Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        LoadDepositBank()
        // Function to load warehouses
        function loadDocNum(id) {
            $.ajax({
                url: '@Url.Action("GETCHEQUEDEPOSITDOCNUM", "Accounts")',
                method: 'GET',
                data:{id:id},
                success: function(response) {
                    if(response[0].Success=="true"){
                        $("#Docnum").val(response[0].Message)
                    }else{
                           Notify('error', response[0].Message,'');
                    }
                },
                error: function(xhr) {
                    Notify('error', 'Error', xhr.responseText );
                }
            });
        }
        function savedocument(flag) {
            const headerData = getHeaderData();
            const lineItems = getLineItems();
            if (flag == "S") {
                if (!validateForm(headerData, lineItems)) {
                    return;
                }
            }
            const data = {
                header: headerData,
                lines: lineItems,
            };
            // AJAX call to save
            $.ajax({
                url: '@Url.Action("CEREATECHEQUEDEPOSIT", "Accounts")' + '?flag=' + flag + '&doctype=' + $("#doctype").val(),
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    } else {
                        $('#btnPark').prop('disabled', true).html('<i class="bi bi-p-circle"></i> Processing...');
                    }
                },
                success: function(response) {
                    if(response.success){
                       Notify('success', response.message,'');
                       currentDocEntry = response.docEntry;
                       $('#btnDelete').prop('disabled', false);
                       $('#btnCancel').prop('disabled', false);
                       $('#DocumentEntry').val(response.docEntry);
                       $('#addFilesButton').click();
                       loadFindRow(currentDocEntry, $("#doctype").val(),"")
                     
                    }else{
                       Notify('error','Faild To Create ', response.message);
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseText || 'Error loading ITEM GROUP';
                    Notify('error', 'Error', errorMessage);
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }

                },complete: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }
                }
            });
        }
        function removeempty(){
            var tablerow= $('#mainitemtable tbody tr').length;
            if(tablerow >1){
                $('#mainitemtable tbody tr').each(function(){
                     var row = $(this).closest("tr");
                    if (row.length && !row.find('.ItemCode').val().trim()) {
                        row.remove();
                        return; // Stop execution if the previous row's ItemCode is empty
                    }
                });
            }
        }
        function getHeaderData() {
            return {
                DocEntry: $('#DocumentEntry').val() || null,
                Docnum: $('#Docnum').val(),
                PostingDate: $('#PostingDate').val(),
                DocumentDate: $('#DocumentDate').val(),
                FYearId: $('#FYearId').val(),
                NETTotal: parseFloat($('#NETTotal').val()) || 0,
                LedgerID: $('#LedgerId').val() || null,
                LedgerName: $('#LedgerId option:selected').text(),
                RefNo: $('#RefNo').val(),
                Remarks: $('#Remarks').val(),
            };
        }
        function getLineItems() {
            function formatDate(str) {
                const [day, month, year] = str.split("-");
                return `${year}-${month}-${day}`;
            }
            const lineItems = [];
            $('#mainitemtable tbody tr').each(function (index) {
                const row = $(this);
                if (row.find('.ItemCheck').is(":checked")) {
                    lineItems.push({
                        ID: row.data('id').toString() || null,
                        DocEntry: null,
                        DocNum: row.find('.DocNum').text() || "",
                        DocumentDate: formatDate(row.find('.DocumentDate').text()) || "",
                        LedgerID: row.find('.LedgerName').attr("data-id"),
                        LedgerName: row.find('.LedgerName').text(),
                        BankId: row.find('.ChequeBankId').attr("data-id"),
                        BankName: row.find('.ChequeBankId').text(),
                        BaseDocEntry: row.find('.BaseDocEntry').val(),
                        BaseObjType: row.find('.BaseObjType').val(),
                        Remarks: row.find('.Remarks').text(),
                        RefNo: row.find('.RefNo').text(),
                        ChequeAmt: row.find('.ChequeAmt').text(),
                        ChequeNo: row.find('.ChequeNo').text(),
                        ChequeLedgerId: row.find('.ChequeLedgerId').val(),
                        ChequeDate: formatDate(row.find('.ChequeDate').text()),
                    });
                } else  {

                }
            });
            return lineItems;
        }
        function validateForm(header, lines) {
            if (!header.PostingDate) {
                Notify('error', 'Posting date is required', '');
                return false;
            }
            if (!header.DocumentDate) {
                Notify('error', 'Document date is required', '');
                return false;
            }
        
            if (!header.FYearId) {
                Notify('error', 'Fiscal year is required', '');
                return false;
            }
            if (!header.LedgerID ) {
                Notify('error', 'Deposit Bank Name is required', '');
                return false;
            }
            

          
            if (lines.length === 0) {
                Notify('error', 'At least one item is required', '');
                return false;
            }
            //var index = 1;
            //for (let i = 0; i < lines.length; i++) {
            //    const line = lines[i];
            //    if (!line.TotalPayment || line.TotalPayment <= 0 || line.TotalPayment == "NaN") {
            //        Notify('error', `Valid Total Payment Amount is required for line ${index}`, '');
            //        return false;
            //    }
            //    index++;
            //}
            return true;
        }
        function resetForm() {
                currentDocEntry = null;
                isEditMode = false;

                // Reset header fields
                $('#DocumentEntry').val('');
                $('#Docnum').val('');
                $('#DocStatus').val('O');
                $('#PostingDate').val(new Date().toISOString().split('T')[0]);
                $('#DocumentDate').val(new Date().toISOString().split('T')[0]);
                $('#DeliveryDate').val(new Date().toISOString().split('T')[0]);
                $('#DueDate').val(new Date().toISOString().split('T')[0]);
                $('#FYearId').val('');
                $('#LedgerId').val('');
                $('#RefNo').val('');
                $('#BaseEntry').val('');
                $('#Remarks').val('');
                $('#PayOnAccAmtCheck').prop("checked", false);
                $('#PayOnAccAmt').val('0.00');
                $('#NETTotal').val('0.00');
                $('#mainitemtable tbody').empty();

                $('#btnSave').prop('disabled', false);
                $('#btnPark').prop('disabled', false);
                $('#btnPrint').prop('disabled', true);
                $('#btnDelete').prop('disabled', true);
                $('#btnCopyFrom').prop('disabled', true);
                $('#btnCopyTo').prop('disabled', true);
                $('#ItemCheckAll').prop('disabled', false);

               $('#PaymentCancel').prop('disabled', false);
               $("#PayOnAccAmtCheck").prop("disabled", false);
                $('#LedgerType').prop('disabled', false);
                $('#LedgerType').val('B');
                $('#LedgerType').trigger("change");

            LoadRowData()
               
                $('#mainitemtable tbody').empty();
                // Reload fiscal years and document number
                loadFiscalYears();
            $("#resetcustomerform").click();

        }
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
        // Modify the remove-line click handler
        $(document).on('click', '.remove-line', function() {
            const row = $(this).closest('tr');
            const table = $('#mainitemtable tbody');
            const rowCount = table.find('tr').length;
            if (rowCount > 1) {
                row.remove();
                // Update row numbers
                table.find('tr').each(function(index) {
                    $(this).find('td:first').text(index + 1);
                });
                // Disable remove button if only one row left
                if (table.find('tr').length === 1) {
                    table.find('tr').first().find('.remove-line').prop('disabled', true);
                }
                // Recalculate totals after deletion
                calculateHeaderTotals();
            } else {
                Notify('warning', 'At least one item is required');
            }
        });
        //Find Mode
        {
            $("#btnFind").click(function () {
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
                Findmode()
            })
            $("#FindBtnSearch").click(function () {
                Findmode()
            })
            $("#FindBtnReset").click(function () {
                $("#fdocid").val("")
                $("#frefno,#rrefno").val("")
                $('.datepicker').val(new Date().toISOString().split('T')[0]);
            })
            function Findmode() {
                var obj = {
                    doctype: $("#doctype").val() || '',
                    docid: $("#fdocid").val() || '',
                    refno: $("#frefno").val() || '',
                    fromdate: $("#ffromdate").val() || '',
                    todate: $("#ftodate").val() || '',
                    docEntry: '',
                };
                $.ajax({
                    url: '@Url.Action("FINDMODE", "Sales")',
                    method: 'GET',
                    data: obj,
                    success: function (response) {
                        const tableBody = $('#receiptListTable tbody');
                        if ($.fn.DataTable.isDataTable('#receiptListTable')) {
                            $('#receiptListTable').DataTable().destroy();
                        }
                        tableBody.empty();
                        response.header.forEach(function (receipt) {
                            const row = `
                                <tr data-docentry='${receipt.DocEntry}'>
                                    <td>${receipt.Docnum}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                            <i class="bi bi-check"></i> Select
                                        </button>
                                    </td>
                                    <td>${receipt.LedgerName}</td>
                                    <td>${receipt.For_PostingDate}</td>
                                    <td>${receipt.RefNo || ''}</td>
                                    <td>${receipt.Remarks || ''}</td>
                                    <td>${receipt.CretedByUName}</td>
                                </tr>
                            `;
                            tableBody.append(row);
                        });

                        // ✅ Reinitialize DataTable
                        $('#receiptListTable').DataTable({
                            dom: '<"top"lf>rt<"bottom"ip>',
                            pageLength: 10,
                            lengthMenu: [5, 10, 25, 50, 100],
                            responsive: true,
                            columnDefs: [
                                { orderable: false, targets: [6] }
                            ]
                        });

                        // ✅ Attach event handler (only once if possible, or inside a separate setup)
                        $('#receiptListTable').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                            const docEntry = $(this).data('docentry');
                            loadFindRow(docEntry, $("#doctype").val(), "");
                            $('#receiptListModal').modal('hide');
                        });
                    },
                    error: function (xhr, status, error) {
                        Notify('error', 'Failed to load receipt list', '');
                    }
                });
            }
        }
        async function loadFindRow(docEntry, doctype, flag) {
            try {
                const response = await $.ajax({
                    url: '@Url.Action("FINDMODE", "Sales")',
                    method: 'GET',
                    data: { doctype, docEntry }
                });
                if (!response || !response.header?.length) {
                    Notify('error', 'Find Row Not found');
                    return;
                }
                const header = response.header[0];
                let rows = response.row || [];
                const today = new Date().toISOString().split('T')[0];

                // ✅ safer date formatter
                const formatDateForInput = (dateStr) => {
                    if (!dateStr) return today;
                    const parts = dateStr.split("-");
                    if (parts.length !== 3) return today;
                    const [day, month, year] = parts;
                    return `${year}-${month}-${day}`;
                };
                // ✅ safer number formatter
                const fmtNum = (val, digits = 2) =>
                    isNaN(parseFloat(val)) ? "0.00" : parseFloat(val).toFixed(digits);
                // ✅ bulk header mapping
                const headerMapping = {
                    '#DocumentEntry': header.DocEntry,
                    '#Docnum': header.Docnum,
                    '#DocStatus': header.DocStatus,
                    '#PostingDate': formatDateForInput(header.For_PostingDate),
                    '#DocumentDate': formatDateForInput(header.For_DocumentDate),
                    '#FYearId': header.FYearId,
                    '#LedgerCode': header.LedgerName,
                    '#RefNo': header.RefNo,
                    '#LedgerId': header.LedgerID,
                    '#Remarks': header.Remarks,
                    '#NETTotal': fmtNum(header.NETTotal),
                };
                for (const [selector, value] of Object.entries(headerMapping)) {
                    $(selector).val(value ?? "");
                }
                $('#mainitemtable tbody').empty();
                rows.forEach((item, idx) => {
                    const row = `
                         <tr data-id='' class="line-item">
                          <td>${idx}</td>
                           <td class="">
                               <button class="btn btn-sm btn-outline-danger remove-line"  disabled>
                                   <i class="bi bi-trash"></i>
                               </button>
                           </td>
                          <td  class="text-center">
                               <input style="height: 20px; width:20px;" type="checkbox" checked class="ItemCheck mt-1" />
                           </td>
                          <td nowrap  class=" LedgerName" data-id='${item.LedgerID}'>${item.LedgerName}</td>
                          <td nowrap  class=" DocNum">${item.DocNum}</td>
                          <td nowrap  class=" DocumentDate">${item.DocumentDate.split(' ')[0]}</td>
                          <td nowrap  class=" ChequeNo">${item.ChequeNo}</td>
                          <td nowrap  class=" ChequeDate">${item.ChequeDate.split(' ')[0]}</td>
                          <td nowrap  class="text-end ChequeAmt">${parseFloat(item.ChequeAmt).toFixed(2)}</td>
                          <td nowrap  class=" ChequeBankId" data-id='${item.BankId}'>${item.BankName}</td>
                          <td nowrap  class=" RefNo">${item.RefNo}</td>
                          <td nowrap  class=" Remarks">${item.Remarks}</td>
                          <td hidden><input style='width:100px!important;' type="text" value='${item.BaseDocEntry}' class="form-control form-control-sm text-end BaseDocEntry" readonly></td>
                          <td hidden><input style='width:200px!important;' type="text" value='${item.BaseObjType}' class="form-control form-control-sm text-end BaseObjType" readonly></td>
                      </tr>`;

                    $('#mainitemtable tbody').append(row);
                });

                if (header.DocStatus === "C") {
                    $('#mainitemtable .remove-line').prop('disabled', true).attr("title", "Cannot remove - Document is closed");
                }

                // ✅ buttons state
                $('#btnSave').prop('disabled', header.DocStatus === "C");
                $('#btnPark').prop('disabled', true);
                $('#btnPrint').prop('disabled', false);
                $('#btnDelete').prop('disabled', false);
                $('#PaymentCancel').prop('disabled', true);

                $('#btnCopyTo').prop('disabled', header.DocStatus === "C");
                $('#btnCopyFrom').prop('disabled', header.DocStatus === "C");

                if (flag === "C") {
                    $('#btnSave, #btnPark').prop('disabled', true);
                }

            } catch (error) {
                console.error('Error loading receipt:', error);
                Notify('error', 'Failed to load receipt', '');
            }
        }
        //Resume
        {
           loadUsers()
           function loadUsers() {
               $.ajax({
                   type: "GET",
                   url: '@Url.Action("GETUSERS", "Auth")',
                   contentType: "application/json; charset=utf-8",
                   cache: true,
                   success: function (data) {
                       if(data.length) {
                           const $select = $('#rUserid');
                           $select.empty();
                           $select.append('<option value="">Select User</option>');
                           data.forEach(user => {
                               $select.append(`<option value="${user.UserID}">${user.Username}</option>`);
                           });
                       }
                   },
                   error: function (xhr) {
                       const errorMessage = xhr.responseJSON?.error || 'Error loading users';
                       Notify('error', 'Error', errorMessage);
                   }
               });
           }
           $("#btnResume").click(function(){
               $("#fdocid").val("")
               $("#frefno,#rrefno").val("")
               $('.datepicker').val(new Date().toISOString().split('T')[0]);
               Resume()
           })
           $("#ResumeBtnSearch").click(function(){
               Resume()
           })
           $("#ResumeBtnReset").click(function(){
               $("#rrefno").val("")
               $('.datepicker').val(new Date().toISOString().split('T')[0]);
           })
            function Resume() {
               var obj = {
                   doctype: $("#doctype").val() || '',
                   refno: $("#rrefno").val() || '',
                   fromdate: $("#rfromdate").val() || '',
                   todate: $("#rtodate").val() || '',
                   Userid: $("#rUserid").val() || '',
                   docEntry:'',
               };
               $.ajax({
                   url: '@Url.Action("RESUMEPARK", "Inventory")',
                   method: 'GET',
                   data: obj,
                   success: function (response) {
                       if (response.length >0) {
                           const tableBody = $('#ResumeModaltbl tbody');
                           if ($.fn.DataTable.isDataTable('#ResumeModaltbl')) {
                               $('#ResumeModaltbl').DataTable().destroy();
                           }
                           var payload = JSON.parse(response[0].Payload);
                           tableBody.empty();
                           var index = 1;
                           response.forEach(function (receipt) {
                               const row = `
                                   <tr data-docentry='${receipt.DocEntry}'>
                                       <td>${index}</td>
                                       <td>
                                           <button class="btn btn-sm btn-primary select-findrow" data-docentry="${receipt.DocEntry}">
                                               <i class="bi bi-check"></i> Select
                                           </button>
                                       </td>
                                       <td>${receipt.CreatedDate}</td>
                                       <td>${receipt.RefNo || ''}</td>
                                       <td>${receipt.CretedByUName}</td>
                                       <td hidden class='Payload'>${receipt.Payload}</td>
                                   </tr>
                               `;
                               tableBody.append(row);
                               index++;
                           });

                           // ✅ Reinitialize DataTable
                           $('#ResumeModaltbl').DataTable({
                               dom: '<"top"lf>rt<"bottom"ip>',
                               pageLength: 10,
                               lengthMenu: [5, 10, 25, 50, 100],
                               responsive: true,
                               columnDefs: [
                                   { orderable: false, targets: [] }
                               ]
                           });

                           // ✅ Attach event handler (only once if possible, or inside a separate setup)
                           $('#ResumeModaltbl').off('click', '.select-findrow').on('click', '.select-findrow', function () {
                               const docEntry = $(this).data('docentry');
                               const row = $(this).closest("tr");
                               var data = row.find(".Payload").text();
                               loadresume(JSON.parse(data), docEntry);
                               $('#ResumeModal').modal('hide');
                           });
                       }
                   },
                   error: function(xhr, status, error) {
                       Notify('error', 'Failed to load receipt list', '');
                   }
               });
                async  function loadresume(response, docEntry) {
                    try {
                          isEditMode = true;
                          const header = response.header;
                          const rows = response.lines || [];

                        if (!response || !response.lines?.length) {
                             Notify('error', 'Resume Row Not found');
                             return;
                         }
                         const today = new Date().toISOString().split('T')[0];
                        // ✅ safer date formatter
                        const formatDateForInput = (dateStr) => {
                            if (!dateStr) return today;
                            const parts = dateStr.split("-");
                            if (parts.length !== 3) return today;
                            const [day, month, year] = parts;
                            return `${year}-${month}-${day}`;
                        };
                        // ✅ safer number formatter
                        const fmtNum = (val, digits = 2) =>
                            isNaN(parseFloat(val)) ? "0.00" : parseFloat(val).toFixed(digits);
                        // ✅ bulk header mapping
                        const headerMapping = {
                            '#DocumentEntry': header.DocEntry,
                            '#Docnum': header.Docnum,
                            '#DocStatus': header.DocStatus,
                            '#PostingDate': formatDateForInput(header.For_PostingDate),
                            '#DocumentDate': formatDateForInput(header.For_DocumentDate),
                            '#FYearId': header.FYearId,
                            '#LedgerCode': header.LedgerName,
                            '#RefNo': header.RefNo,
                            '#Remarks': header.Remarks,
                            '#LedgerId': header.LedgerID,
                            '#NETTotal': fmtNum(header.NETTotal),
                        };
                        for (const [selector, value] of Object.entries(headerMapping)) {
                            $(selector).val(value ?? "");
                        }
                        $('#mainitemtable tbody').empty();
                        rows.forEach((item, idx) => {
                            const row = `
                                <tr data-id='' class="line-item">
                                <td>${idx}</td>
                                <td class="">
                                    <button class="btn btn-sm btn-outline-danger remove-line"  disabled>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                                <td  class="text-center">
                                    <input style="height: 20px; width:20px;" type="checkbox" checked class="ItemCheck mt-1" />
                                </td>
                                <td nowrap  class=" LedgerName" data-id='${item.LedgerID}'>${item.LedgerName}</td>
                                <td nowrap  class=" DocNum">${item.DocNum}</td>
                                <td nowrap  class=" DocumentDate">${item.DocumentDate.split(' ')[0]}</td>
                                <td nowrap  class=" ChequeNo">${item.ChequeNo}</td>
                                <td nowrap  class=" ChequeDate">${item.ChequeDate.split(' ')[0]}</td>
                                <td nowrap  class="text-end ChequeAmt">${parseFloat(item.ChequeAmt).toFixed(2)}</td>
                                <td nowrap  class=" ChequeBankId" data-id='${item.BankId}'>${item.BankName}</td>
                                <td nowrap  class=" RefNo">${item.RefNo}</td>
                                <td nowrap  class=" Remarks">${item.Remarks}</td>
                                <td hidden><input style='width:100px!important;' type="text" value='${item.BaseDocEntry}' class="form-control form-control-sm text-end BaseDocEntry" readonly></td>
                                <td hidden><input style='width:200px!important;' type="text" value='${item.BaseObjType}' class="form-control form-control-sm text-end BaseObjType" readonly></td>
                            </tr>`;

                            $('#mainitemtable tbody').append(row);
                        });

                        if (header.DocStatus === "C") {
                            $('#mainitemtable .remove-line').prop('disabled', true).attr("title", "Cannot remove - Document is closed");
                        }

                        // ✅ buttons state
                        $('#btnSave').prop('disabled', header.DocStatus === "C");
                        $('#btnPark').prop('disabled', true);
                        $('#btnPrint').prop('disabled', false);
                        $('#btnDelete').prop('disabled', false);
                        $('#PaymentCancel').prop('disabled', true);

                        $('#btnCopyTo').prop('disabled', header.DocStatus === "C");
                        $('#btnCopyFrom').prop('disabled', header.DocStatus === "C");

                        if (flag === "C") {
                            $('#btnSave, #btnPark').prop('disabled', true);
                        }
                          $.ajax({
                                url: '@Url.Action("DELETEPARKDOC", "Inventory")',
                                method: 'GET',
                                data: { id: docEntry },
                                success: function (response) {
                                    Resume()
                                },
                                error: function(xhr, status, error) {
                                    Notify('error', 'Failed to load receipt list', '');
                                }
                            });
                     } catch (error) {
                         console.error('Error loading receipt:', error);
                         Notify('error', 'Failed to load receipt', '');
                     }
               }
           }
        }
    });

</script>