<!-- Freight Master Form Section -->
<section id="FreightMasterSection">
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">
                    <i class="bi bi-truck"></i> Freight Master
                </h3>
            </div>
            <div class="card-body">
                <form id="FreightMasterForm">
                    <input type="hidden" id="FreID" name="FreID">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="Name" class="form-label">Freight Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-box"></i></span>
                                <input type="text" class="form-control" id="Name" name="Name" required maxlength="100">
                                <div class="invalid-feedback">Please provide a freight name (2-100 characters).</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="Income" class="form-label">Income <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-cash-coin"></i></span>
                                <input type="text" data-id="" class="form-control" id="Income" name="Income" required>
                                <div class="invalid-feedback">Please provide a valid income amount.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="Expenses" class="form-label">Expenses <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
                                <input type="text" class="form-control" id="Expenses" data-id="" name="Expenses" required>
                                <div class="invalid-feedback">Please provide a valid expense amount.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="IsActive" class="form-label">Expenses <span class="text-danger">*</span></label>
                            <select class="form-control form-control-sm" id="IsActive">
                                <option value="A">Active</option>
                                <option value="I">InActive</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3 text-end">
                        <div class="col-md-12">
                            @if (ViewBag.BtnAuth != null)
                            {
                                <!-- Button Rendering Logic -->
                                @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                                {
                                    var btnName = item["BtnName"]?.ToString().Trim();
                                    var btnauth = item["Auth"]?.ToString();
                                    var icon = item["Icon"]?.ToString();
                                    var ColorClass = item["ColorClass"]?.ToString();

                                    if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                    {
                                        switch (btnName)
                                        {
                                            case "Save":
                                                <button type="button" id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                    <i class="@icon"></i>@btnName
                                                </button>
                                                break;
                                            case "Delete":
                                                <button type="button" id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                    <i class="@icon"></i>@btnName
                                                </button>
                                                break;
                                            case "Reset":
                                                <button type="reset" id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                    <i class="@icon"></i> Reset
                                                </button>
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                <div class="alert alert-primary" role="alert">

                                </div>
                            }
                        </div>
                    </div>
                </form>

                <div class="table-responsive mt-4">
                    <table id="freightMasterTable" class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- jQuery CRUD Operations -->
<script>
    $(document).ready(function() {

        // Validate form
        function validateForm() {
            let isValid = true;
            const name = $('#Name').val().trim();
            const income = $('#Income').val();
            const expenses = $('#Expenses').val();

            if (name.length < 2 || name.length > 100) {
                $('#Name').addClass('is-invalid'); isValid = false;
            } else { $('#Name').removeClass('is-invalid'); }

            if (!income || income < 0) {
                $('#Income').addClass('is-invalid'); isValid = false;
            } else { $('#Income').removeClass('is-invalid'); }

            if (!expenses || expenses < 0) {
                $('#Expenses').addClass('is-invalid'); isValid = false;
            } else { $('#Expenses').removeClass('is-invalid'); }

            return isValid;
        }
        function checkDuplicate() {
            const $nameInput = $('#Name');
            const name = $nameInput.val().trim().toLowerCase();
            if (!name) return false;

            let nameExists = false;

            $('#freightMasterTable tbody tr').each(function () {
                const rowName = $(this).find('td:eq(1)').text().trim().toLowerCase();
                if (rowName === name) {
                    nameExists = true;
                    return false;
                }
            });

            if (nameExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Freight Name',
                    text: 'This Freight Name already exists!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $nameInput.val('');
            }

            return nameExists;
        }

        $(document).on('change', '#Name', checkDuplicate);

        // Bind live check
            $(document).on('change', '#Name', checkDuplicate);
        // Load all freights
        function loadFreights() {
            $.ajax({
                url: '@Url.Action("GETFREIGHT", "Master")',
                type: 'GET',
                success: function(response) {
                    var tableBody = $('#freightMasterTable tbody');
                    tableBody.empty();

                    if (response && response.length > 0) {
                        $.each(response, function(index, freight) {
                            var row = `<tr data-id="${freight.FreID}">
                                <td>${freight.FreID}</td>
                                <td>${freight.Name}</td>
                                <td>${freight.IncLedgerName}</td>
                                <td>${freight.ExpsLedgerName}</td>
                                <td>${freight.CretedByUName || ''}</td>
                                <td>${freight.CreatedDate || ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary btn-edit" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        Notify('warning', 'No Data', 'No freight records found.');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Error loading freights';
                    Notify('error', 'Error', errorMessage);
                }
            });
        }

        // Initial load
        loadFreights();

        // Save or Update Freight
        $('#btnSave').click(function() {
            if (!validateForm()) {
                Notify('warning', 'Validation Error', 'Please correct the form errors before saving.');
                return;
            }

            var formData = {
                FreID: $('#FreID').val(),
                Name: $('#Name').val().trim(),
                ExpsLedgerName: $('#Expenses').val().trim(),
                IncLedgerName: $('#Income').val().trim(),
                IsActive: $("#IsActive").val(),
                Income: $('#Income').attr("data-id"),
                Expenses: $('#Expenses').attr("data-id"),
            };

            var isEdit = formData.FreID !== '';

            $.ajax({
                url: '@Url.Action("CREATEFREIGHT", "Master")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                beforeSend: function() {
                    $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                },
                success: function(response) {
                    if (response && response.success) {
                        Notify('success', 'Success', response.message || (isEdit ? 'Freight updated successfully!' : 'Freight created successfully!'));
                        loadFreights();
                        $('#FreightMasterForm')[0].reset();
                        $('#FreID').val('');
                        $('#btnDelete').prop('disabled', true);
                    } else {
                        Notify('warning', 'Warning', response.message || 'Operation completed but with warnings.');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Error saving freight';
                    Notify('error', 'Error', errorMessage);
                },
                complete: function() {
                    $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                }
            });
        });

        // Delete Freight
        $('#btnDelete').click(function() {
            var freightId = $('#FreID').val();
            if (!freightId) {
                Notify('warning', 'Warning', 'No freight selected to delete.');
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete the freight entry!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETEFREIGHT", "Master")',
                        type: 'POST',
                        data: { id: freightId },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Deleted', response.message || 'Freight deleted successfully!');
                                loadFreights();
                                $('#FreightMasterForm')[0].reset();
                                $('#FreID').val('');
                            } else {
                                Notify('warning', 'Warning', response.message || 'Freight could not be deleted.');
                            }
                        },
                        error: function(xhr) {
                            const errorMessage = xhr.responseJSON?.message || 'Error deleting freight';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        });

        // Edit Freight
        $(document).on('click', '.btn-edit', function() {
            var freightId = $(this).closest('tr').data('id');
            if (!freightId) {
                Notify('warning', 'Warning', 'No freight ID found for editing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("GETFREIGHTBYID", "Master")',
                data: { id: freightId },
                type: 'GET',
                success: function(response) {
                    if (response && response.length > 0) {
                        var freight = response[0];
                        $('#FreID').val(freight.FreID);
                        $('#Name').val(freight.Name);
                        $('#Income').val(freight.IncLedgerName);
                        $('#Income').attr(freight.Income);
                        $('#Expenses').val(freight.ExpsLedgerName);
                        $('#Expenses').attr(freight.Expenses);

                        $('#btnDelete').prop('disabled', false);
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                    } else {
                        Notify('warning', 'Warning', 'No data returned for this freight.');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Error loading freight data';
                    Notify('error', 'Error', errorMessage);
                }
            });
        });

        // Reset form
        $('#btnReset').click(function() {
            $('#FreID').val('');
            $('#btnDelete').prop('disabled', true);
            $('.is-invalid').removeClass('is-invalid');
        });

        // Real-time validation
        $('#Name, #Income, #Expenses').on('input change', function() {
            $(this).removeClass('is-invalid');
        });

        //Ledger Search
         var BPPartnerData=null;
     function loadBPPartnerTable() {
         $.ajax({
             type: "GET",
             url: '@Url.Action("GETLEDGERGROUP", "Purchase")',
             contentType: "application/json; charset=utf-8",
             data:{type:"A"},
             cache: false,
             success: function(data) {
                 BPPartnerData = [];
                 BPPartnerData = data;
             },
             error: function(xhr) {
                 Notify('error', 'Error', xhr.responseText || 'Error loading BP Partners');
             }
         });
     }
     loadBPPartnerTable();
        var $activeInput = null;
        $(document).on('input', "#Expenses", function () {
            var $input = $(this);
            $activeInput = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Check if the suggestion container already exists, if not, create it
            var suggestionContainerId = 'BPSuggestions-' + $input.closest('tr').index();
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            // Get the container element
            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty(); // Clear previous suggestions

            // Check if BPPartnerData exists and is an array
            if (Array.isArray(BPPartnerData) && BPPartnerData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    // Filter suggestions based on universal search (match all tokens)
                    suggestions = BPPartnerData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ID || '').toLowerCase();
                            var name = (data.GroupName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.GroupName.localeCompare(b.GroupName);
                    }).slice(0, 50); // Limit to 50 results
                }
                // Show suggestions if any
                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item ExpensesSet" data-code="${data.Code || ''}" data-id="${data.ID || ''}" data-name="${data.GroupName || ''}">
                          <span class="group-name"><b>${data.GroupName || ''}</b></span>
                      </div>`
                        );
                    });

                    // Calculate the offset of the input field and position the suggestion box below it
                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("BP Partner Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });
        $(document).on('click', '.ExpensesSet', function () {
            var ledgerCode = $(this).data('code');
            var groupName = $(this).data('name');
            var id = $(this).data('id');
            $("#Expenses").val(groupName)
            $("#Expenses").attr("data-id", id)
            $('.suggestions-container').hide();
        });
        $(document).on('input', "#Income", function () {
            var $input = $(this);
            $activeInput = $(this);
            var value = $input.val().toLowerCase().replace(/_/g, ' ');
            var suggestions = [];

            // Check if the suggestion container already exists, if not, create it
            var suggestionContainerId = 'BPSuggestions-' + $input.closest('tr').index();
            if (!$('#' + suggestionContainerId).length) {
                $('<div id="' + suggestionContainerId + '" class="suggestions-container"></div>').appendTo('body');
            }

            // Get the container element
            var $suggestionContainer = $('#' + suggestionContainerId);
            $suggestionContainer.empty(); // Clear previous suggestions

            // Check if BPPartnerData exists and is an array
            if (Array.isArray(BPPartnerData) && BPPartnerData.length > 0) {
                if (value.length > 0) {
                    var searchTokens = value.split(/\s+/);
                    // Filter suggestions based on universal search (match all tokens)
                    suggestions = BPPartnerData.filter(function (data) {
                        if (data && typeof data === 'object') {
                            var code = (data.ID || '').toLowerCase();
                            var name = (data.GroupName || '').toLowerCase();
                            var allTokens = code.split(/\s+|[_-]+/).concat(name.split(/\s+|[_-]+/));
                            return searchTokens.every(function (token) {
                                return allTokens.some(function (itemToken) {
                                    return itemToken.includes(token);
                                });
                            });
                        }
                        return false;
                    }).sort(function (a, b) {
                        return a.GroupName.localeCompare(b.GroupName);
                    }).slice(0, 50); // Limit to 50 results
                }
                // Show suggestions if any
                if (suggestions.length > 0) {
                    suggestions.forEach(function (data) {
                        $suggestionContainer.append(
                            `<div class="suggestion-item IncomeSet" data-code="${data.Code || ''}" data-id="${data.ID || ''}" data-name="${data.GroupName || ''}">
                   <span class="group-name"><b>${data.GroupName || ''}</b></span>
               </div>`
                        );
                    });

                    // Calculate the offset of the input field and position the suggestion box below it
                    var offset = $input.offset();
                    $suggestionContainer.css({
                        top: offset.top + $input.outerHeight(),
                        left: offset.left,
                        width: $input.outerWidth(),
                        position: 'absolute',
                        "z-index": 1000,
                    }).show();
                } else {
                    $suggestionContainer.hide();
                }
            } else {
                console.error("BP Partner Data is not defined or is empty");
                $suggestionContainer.hide();
            }
        });
        $(document).on('click', '.IncomeSet', function () {
            var ledgerCode = $(this).data('code');
            var groupName = $(this).data('name');
            var id = $(this).data('id');
            $("#Income").val(groupName)
            $("#Income").attr("data-id", id)
            $('.suggestions-container').hide();
        });
    });
</script>
