<!-- State Master Form Section -->
<section id="stateMasterSection">
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">
                    <i class="bi bi-geo-alt"></i> State Master
                </h3>
            </div>
            <div class="card-body">
                <form id="stateMasterForm">
                    <input type="hidden" id="Stat_Id" name="Stat_Id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Code" class="form-label">State Code <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-code-square"></i></span>
                                <input type="text" class="form-control" id="Code" name="Code" required maxlength="10">
                                <div class="invalid-feedback">Please provide a valid state code (2-10 characters).</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="Name" class="form-label">State Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-flag"></i></span>
                                <input type="text" class="form-control" id="Name" name="Name" required maxlength="100">
                                <div class="invalid-feedback">Please provide a state name (2-100 characters).</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Coun_Id" class="form-label">Country <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                <select class="form-select" id="Coun_Id" name="Coun_Id" required>
                                    <option value="">Select Country</option>
                                    <!-- Countries will be loaded here -->
                                </select>
                                <div class="invalid-feedback">Please select a country.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="GstCode" class="form-label">GST Code</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                                <input type="text" class="form-control" id="GstCode" name="GstCode" maxlength="10">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="IsActive" name="IsActive" checked>
                                <label class="form-check-label" for="IsActive">Active</label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 text-end">
                        <div class="col-md-12">
                            @if (ViewBag.BtnAuth != null)
                            {
                                <!-- Button Rendering Logic -->
                                @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                                {
                                    var btnName = item["BtnName"]?.ToString().Trim();
                                    var btnauth = item["Auth"]?.ToString();
                                    var icon = item["Icon"]?.ToString();
                                    var ColorClass = item["ColorClass"]?.ToString();

                                    if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                    {
                                        switch (btnName)
                                        {
                                            case "Save":
                                                <button type="button" id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                    <i class="@icon"></i>@btnName
                                                </button>
                                                break;
                                            case "Delete":
                                                <button type="button" id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                    <i class="@icon"></i>@btnName
                                                </button>
                                                break;
                                            case "Reset":
                                                <button type="reset" id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                    <i class="@icon"></i> Reset
                                                </button>
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                <div class="alert alert-primary" role="alert">

                                </div>
                            }
                        </div>
                    </div>
                </form>

                <div class="table-responsive mt-4">
                    <table id="stateMasterTable" class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Country</th>
                                <th>GST Code</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- jQuery CRUD Operations -->
<script>
    $(document).ready(function() {
        // Initialize form validation
        function validateForm() {
            let isValid = true;
            const code = $('#Code').val().trim();
            const name = $('#Name').val().trim();
            const countryId = $('#Coun_Id').val();

            // Validate Code (2-10 characters)
            if (code.length < 2 || code.length > 10) {
                $('#Code').addClass('is-invalid');
                isValid = false;
            } else {
                $('#Code').removeClass('is-invalid');
            }

            // Validate Name (2-100 characters)
            if (name.length < 2 || name.length > 100) {
                $('#Name').addClass('is-invalid');
                isValid = false;
            } else {
                $('#Name').removeClass('is-invalid');
            }

            // Validate Country selection
            if (!countryId) {
                $('#Coun_Id').addClass('is-invalid');
                isValid = false;
            } else {
                $('#Coun_Id').removeClass('is-invalid');
            }

            return isValid;
        }
        // Dynamic duplicate check
        function checkDuplicate() {
            const $codeInput = $('#Code');
            const $nameInput = $('#Name');
            const code = $codeInput.val().trim();
            const name = $nameInput.val().trim();
            if (!code && !name) return false;

            let codeExists = false;
            let nameExists = false;

            $('#stateMasterTable tbody tr').each(function () {
                const rowCode = $(this).find('td:eq(0)').text().trim();
                const rowName = $(this).find('td:eq(1)').text().trim();

                if (rowCode === code) codeExists = true;
                if (rowName === name) nameExists = true;

                if (codeExists && nameExists) return false; // break loop if both found
            });

            if (codeExists && nameExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Entry',
                    text: 'Both Code and Name already exist!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $codeInput.val('');
                $nameInput.val('');
            } else if (codeExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Code',
                    text: 'This Code already exists!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $codeInput.val('');
            } else if (nameExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Name',
                    text: 'This Name already exists!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $nameInput.val('');
            }

            return codeExists || nameExists;
        }
        // Bind live check
        $(document).on('change', '#Code, #Name', checkDuplicate);
         // Load all countries for dropdown
       function loadCountries() {
            $.ajax({
                url: '@Url.Action("GETCOUNTRY", "Master")',
                type: 'GET',
                success: function(response) {
                    if (!response || !response.length) return;

                    const dropdown = $('#Coun_Id').empty().append('<option value="">Select Country</option>');

                    let indiaId = response.find(c => c.Name.trim().toLowerCase() === 'india')?.Coun_Id;

                    response.forEach(c => dropdown.append($('<option>').val(c.Coun_Id).text(c.Name)));

                    if (indiaId) dropdown.val(indiaId); // select India if exists
                },
                error: function(xhr) {
                    Notify('error', 'Error', xhr.responseJSON?.message || xhr.responseText || 'Error loading countries');
                }
            });
}
        // Load all states
        function loadStates() {
            $.ajax({
                url: '@Url.Action("GETSTATE", "Master")',
                type: 'GET',
                beforeSend: function() {
                    // Show loading indicator if needed
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var tableBody = $('#stateMasterTable tbody');
                        tableBody.empty();

                        $.each(response, function(index, state) {
                            var row = `<tr data-id="${state.Stat_Id}">
                                <td>${state.Code || ''}</td>
                                <td>${state.Name || ''}</td>
                                <td>${state.CountryName || ''}</td>
                                <td>${state.GstCode || ''}</td>
                                <td>${state.IsActive == "A" ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary btn-edit" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        Notify('warning', 'No Data', 'No state records found.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading states';
                    Notify('error', 'Error', errorMessage);
                }
            });
        }

        // Initial load
        loadCountries();
        loadStates();

        // Save/Update state
        $('#btnSave').click(function() {
            if (!validateForm()) {
                Notify('warning', 'Validation Error', 'Please correct the form errors before saving.');
                return;
            }

            // Create a JavaScript object from the form data
            var formData = {
                Stat_Id: $('#Stat_Id').val(),
                Code: $('#Code').val().trim(),
                Name: $('#Name').val().trim(),
                Coun_Id: $('#Coun_Id').val(),
                GstCode: $('#GstCode').val().trim(),
                IsActive: $('#IsActive').is(':checked') ? "A" : "I"
            };

            var isEdit = formData.Stat_Id !== '';
            $.ajax({
                url: '@Url.Action("CREATESTATE", "Master")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                beforeSend: function() {
                    $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                },
                success: function(response) {
                    if (response && response.success) {
                        Notify('success', 'Success', response.message || (isEdit ? 'State updated successfully!' : 'State created successfully!'));
                        loadStates();
                        $('#stateMasterForm')[0].reset();
                        $('#Stat_Id').val('');
                        $('#btnDelete').prop('disabled', true);
                    } else {
                        Notify('warning', 'Warning', response.message || 'Operation completed but with warnings.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error saving state';
                    Notify('error', 'Error', errorMessage);
                },
                complete: function() {
                    $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                }
            });
        });

        // Delete state
        $('#btnDelete').click(function() {
            var stateId = $('#Stat_Id').val();
            if (!stateId) {
                Notify('warning', 'Warning', 'No state selected to delete.');
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETESTATE", "Master")',
                        type: 'POST',
                        data: { id: stateId },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'State deleted successfully!');
                                loadStates();
                                $('#stateMasterForm')[0].reset();
                                $('#Stat_Id').val('');
                            } else {
                                Notify('warning', 'Warning', response.message || 'State could not be deleted.');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting state';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        });

        // Edit state
        $(document).on('click', '.btn-edit', function() {
            var stateId = $(this).closest('tr').data('id');
            if (!stateId) {
                Notify('warning', 'Warning', 'No state ID found for editing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("GETSTATEBYID", "Master")',
                data: { id: stateId },
                type: 'GET',
                beforeSend: function() {
                    // Show loading indicator if needed
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var state = response[0];
                        $('#Stat_Id').val(state.Stat_Id);
                        $('#Code').val(state.Code);
                        $('#Name').val(state.Name);
                        $('#Coun_Id').val(state.Coun_Id);
                        $('#GstCode').val(state.GstCode);
                        $('#IsActive').prop('checked', state.IsActive === "A");
                        $('#btnDelete').prop('disabled', false);
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                    } else {
                        Notify('warning', 'Warning', 'No data returned for this state.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading state data';
                    Notify('error', 'Error', errorMessage);
                }
            });
        });

        // Reset form
        $('#btnReset').click(function() {
            $('#Stat_Id').val('');
            $('#btnDelete').prop('disabled', true);
            $('.is-invalid').removeClass('is-invalid');
        });

        // Real-time validation
        $('#Code, #Name, #Coun_Id').on('input change', function() {
            $(this).removeClass('is-invalid');
        });
    });
</script>