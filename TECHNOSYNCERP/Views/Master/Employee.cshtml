<!-- State Master Form Section -->
<section id="stateMasterSection">
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">
                    <i class="bi bi-geo-alt"></i> Employee Master
                </h3>
            </div>
            <div class="card-body">
                <form id="employeeMasterForm" novalidate>
                    <input type="hidden" id="Employee_Id" name="Employee_Id">

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="Code" class="form-label">Employee Code <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-code-square"></i></span>
                                <input type="text" class="form-control" id="Code" name="Code" readonly required maxlength="5"
                                       title="Auto-generated employee code (readonly).">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-flag"></i></span>
                                <input type="text" class="form-control" id="FirstName" name="FirstName" required maxlength="50"
                                       title="Only alphabets. Min 2 characters.">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="MiddleName" class="form-label">Middle Name</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-flag"></i></span>
                                <input type="text" class="form-control" id="MiddleName" name="MiddleName" maxlength="50"
                                       title="Middle name (optional).">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="LastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-flag"></i></span>
                                <input type="text" class="form-control" id="LastName" name="LastName" required maxlength="50"
                                       title="Only alphabets. Min 2 characters.">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="Position" class="form-label">Position <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-briefcase"></i></span>
                                <input type="text" class="form-control" id="Position" name="Position" required maxlength="50"
                                       title="Position (letters and numbers). Min 2 characters.">
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                            <label for="EmpRole" class="form-label">Role</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-briefcase"></i></span>
                                <select id="EmpRole" class="form-select">
                                    <option value="">Select</option>
                                </select>
                                <button type="button" id="btnAddRole" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#RoleMasterModal">
                                    <b><i class="bi bi-plus"></i></b>
                                </button>
                            </div>
                        </div>


                        <div class="col-md-3">
                            <label for="PhoneNo" class="form-label">Phone No</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                <input type="text" inputmode="numeric" pattern="\d{10,12}" class="form-control" id="PhoneNo" name="PhoneNo" maxlength="12"
                                       title="Optional landline/mobile. 10-12 digits (numbers only).">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="MobilePhone" class="form-label">Mobile Phone <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                <input type="text" inputmode="numeric" pattern="\d{10}" class="form-control" id="MobilePhone" name="MobilePhone" required maxlength="10"
                                       title="Mobile phone (10 digits).">
                            </div>
                        </div>


                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="ZipCode" class="form-label">Zip Code</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-mailbox"></i></span>
                                <input type="text" inputmode="numeric" pattern="\d{3,6}" class="form-control" id="ZipCode" name="ZipCode" maxlength="6"
                                       title="Zip Code (3-6 digits).">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="Coun_Id" class="form-label">Country <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                <select class="form-select" id="Coun_Id" name="Coun_Id" required title="Select Country">
                                    <option value="">Select Country</option>
                                    <!-- Countries will be loaded here -->
                                </select>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label for="Stat_Id" class="form-label">State <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <select class="form-select" id="Stat_Id" name="Stat_Id" required title="Select State" disabled>
                                    <option value="">Select State</option>
                                    <!-- States will be loaded here -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="City" class="form-label">City <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-buildings"></i></span>
                                <input type="text" class="form-control" id="City" name="City" required maxlength="100"
                                       title="City name (letters). Min 2 characters.">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="Street" class="form-label">Street <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-signpost"></i></span>
                                <input type="text" class="form-control" id="Street" name="Street" required maxlength="100"
                                       title="Street address. Min 2 characters.">
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-check form-switch mt-5">
                                <input class="form-check-input" type="checkbox" id="IsActive" name="IsActive" checked>
                                <label class="form-check-label" for="IsActive">Active</label>
                            </div>
                        </div>


                        <div class="col-md-12 mt-3">
                            <label for="Addres" class="form-label">Address <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-house"></i></span>
                                <textarea class="form-control" id="Addres" name="Addres" rows="1" placeholder="Enter your Address here..." required maxlength="150"
                                          title="Full address (min 5 chars)."></textarea>
                            </div>
                        </div>


                        <div class="row mb-3 mt-5">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="LinkUser" name="LinkUser">
                                    <label class="form-check-label" for="LinkUser">Link User</label>
                                </div>
                            </div>
                        </div>



                        <div class="row mb-3 text-end">
                            <div class="col-md-12">
                                @if (ViewBag.BtnAuth != null)
                                {
                                    <!-- Button Rendering Logic -->
                                    @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                                    {
                                        var btnName = item["BtnName"]?.ToString().Trim();
                                        var btnauth = item["Auth"]?.ToString();
                                        var icon = item["Icon"]?.ToString();
                                        var ColorClass = item["ColorClass"]?.ToString();

                                        if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                        {
                                            switch (btnName)
                                            {
                                                case "Save":
                                                    <button type="button" id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                        <i class="@icon"></i>@btnName
                                                    </button>
                                                    break;
                                                case "Delete":
                                                    <button type="button" id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                        <i class="@icon"></i>@btnName
                                                    </button>
                                                    break;
                                                case "Reset":
                                                    <button type="reset" id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                        <i class="@icon"></i> Reset
                                                    </button>
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-primary" role="alert">

                                    </div>
                                }
                            </div>
                        </div>
</form>

                <div class="table-responsive mt-4">
                    <table id="employeeMasterTable" class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Emp Code </th>
                                <th> First Name</th>
                                <th> Last Name</th>
                                <th>Position</th>
                                <th>Role </th>
                                <th>Phone Number  </th>
                                <th>Mobile Number  </th>
                                <th>Street</th>
                                <th>City </th>
                                <th>State  </th>
                                <th>Country</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<section>
    <!-- Role Master Modal -->
    <div class="modal fade" id="RoleMasterModal" tabindex="-1" aria-labelledby="RoleMasterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="RoleMasterModalLabel">Role Master</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="RoleMasterTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="create-role-tab" data-bs-toggle="tab" data-bs-target="#create-role" type="button" role="tab">Create Role</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="view-role-tab" data-bs-toggle="tab" data-bs-target="#view-role" type="button" role="tab">View ROLE</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0" id="RoleMasterTabsContent">
                        <div class="tab-pane fade show active" id="create-role" role="tabpanel">
                            <div class="row">
                                <input type="text" hidden id="ROLE_ID" />
                                
                                <div class="col-md-6 mb-3">
                                    <label for="txtRoleName" class="form-label">ROLE Name</label>
                                    <input type="text" class="form-control" id="txtRoleName">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ddlRoleStatus" class="form-label">Status</label>
                                    <select class="form-select" id="ddlRoleStatus">
                                        <option value="A">Active</option>
                                        <option value="I">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="view-role" role="tabpanel">
                            <div class="table-responsive" style="height:550px;">
                                <table class="table table-bordered table-striped table-hover" id="tblRoleMaster">
                                    <thead class="table-light">
                                        <tr>
                                            <th nowrap>Role Name</th>
                                            <th nowrap>Status</th>
                                            <th nowrap hidden>ID</th>
                                            <th nowrap>Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>M</td>
                                            <td>Meter</td>
                                            <td><span class="badge bg-success">Active</span></td>
                                            <td>1</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary role_edite"><i class="bi bi-pencil"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnRoleSave">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- jQuery CRUD Operations -->
<script>
    $(document).ready(function () {


        // ------------------------
        // Utility: Generic Validator
        // ------------------------
        function setInvalid($el, message) {
            $el.addClass('is-invalid');
            if (message) $el.attr('title', message);
        }
        function clearInvalid($el) {
            $el.removeClass('is-invalid');
        }

        // Validation rules (id => {required, pattern, min, max, message})
        const rules = {
            Code: { required: true, min: 1, max: 10, message: 'Employee code must be 2-10 characters.' },
            FirstName: { required: true, pattern: /^[A-Za-z\s]{2,}$/, message: 'Enter valid first name (letters only).' },
            MiddleName: { required: false, pattern: /^[A-Za-z\s]*$/, message: 'Enter valid middle name (letters only).' },
            LastName: { required: true, pattern: /^[A-Za-z\s]{2,}$/, message: 'Enter valid last name (letters only).' },
            PhoneNo: { required: false, pattern: /^\d{10,12}$/, message: 'Enter a valid phone number (10-12 digits).' },
            MobilePhone: { required: true, pattern: /^\d{10}$/, message: 'Enter a valid 10-digit mobile number.' },
            ZipCode: { required: false, pattern: /^\d{3,6}$/, message: 'Enter a valid Zip Code (3-6 digits).' },
            Coun_Id: { required: true, message: 'Select a country.' },
            Stat_Id: { required: true, message: 'Select a state.' },
            City: { required: true, pattern: /^[A-Za-z\s]{2,}$/, message: 'Enter valid city.' },
            Street: { required: true, pattern: /^.{2,100}$/, message: 'Enter valid street.' },
            Addres: { required: true, pattern: /^.{5,}$/, message: 'Enter a valid address (min 5 chars).' }
        };

        function validateFieldByRule(id) {
            const rule = rules[id];
            const $el = $('#' + id);
            const val = ($el.val() || '').trim();

            clearInvalid($el);

            if (!rule) return true; // no rule -> valid

            if (rule.required && !val) {
                setInvalid($el, rule.message || 'This field is required.');
                return false;
            }
            if (val && rule.pattern && !rule.pattern.test(val)) {
                setInvalid($el, rule.message);
                return false;
            }
            if (val && (rule.min || rule.max)) {
                if (rule.min && val.length < rule.min) { setInvalid($el, rule.message); return false; }
                if (rule.max && val.length > rule.max) { setInvalid($el, rule.message); return false; }
            }
            return true;
        }

        function validateForm() {
            let isValid = true;
            Object.keys(rules).forEach(function (k) {
                if (!validateFieldByRule(k)) isValid = false;
            });
            return isValid;
        }

        // ------------------------
        // Duplicate checking (client-side)
        // ------------------------
        function checkDuplicateOnTable(code, firstName, lastName, excludeEmployeeId) {
            let codeExists = false, nameExists = false;
            $('#employeeMasterTable tbody tr').each(function () {
                const rowId = $(this).data('id')?.toString() || '';
                if (excludeEmployeeId && excludeEmployeeId.toString() === rowId) return; // skip current editing
                const rowCode = $(this).find('td:eq(0)').text().trim(); // Changed from eq(1) to eq(0)
                const rowFirst = $(this).find('td:eq(1)').text().trim(); // Changed from eq(2) to eq(1)
                const rowLast = $(this).find('td:eq(2)').text().trim(); // Changed from eq(3) to eq(2)
                if (rowCode && code && rowCode.toLowerCase() === code.toLowerCase()) codeExists = true;
                if (rowFirst && rowLast && firstName && lastName &&
                    rowFirst.toLowerCase() === firstName.toLowerCase() &&
                    rowLast.toLowerCase() === lastName.toLowerCase()) nameExists = true;
            });
            return { codeExists, nameExists };
        }

        // ------------------------
        // Load countries
        // ------------------------
        function loadCountries() {
            $.ajax({
                url: '@Url.Action("GETCOUNTRY", "Master")',
                type: 'GET',
                success: function (response) {
                    const dropdown = $('#Coun_Id').empty().append('<option value="">Select Country</option>');
                    if (!response || !response.length) {
                        Notify('warning', 'No Countries', 'No countries returned from server.');
                        return;
                    }

                    // Try to find India (case-insensitive) and keep its id
                    let indiaId = null;
                    response.forEach(function (c) {
                        dropdown.append($('<option>').val(c.Coun_Id).text(c.Name));
                        if (!indiaId && c.Name && c.Name.trim().toLowerCase() === 'india') indiaId = c.Coun_Id;
                    });

                    // If there's a pending selected country value (during edit), apply it:
                    const pendingCountry = dropdown.data('pending-value');
                    if (pendingCountry) {
                        dropdown.val(pendingCountry).removeData('pending-value').trigger('change');
                        return;
                    }

                    // Prefer India if present, else leave default
                    if (indiaId) {
                        dropdown.val(indiaId).trigger('change');
                    }
                },
                error: function (xhr) {
                    Notify('error', 'Error', xhr.responseJSON?.message || xhr.responseText || 'Error loading countries');
                }
            });
        }
            {
                // ------------------------
                // Role Master
                // ------------------------

                var RoleData = [];

                // Page Load
                $(document).ready(function () {
                    loadRoleData();

                    $('#btnRoleReset').click(resetRoleForm);

                    $('#btnRoleSave').click(function () {
                        const roleId = $('#ROLE_ID').val();
                        if (roleId) {
                            updateRole();
                        } else {
                            createRole();
                        }
                    });
                });

                // ------------------------
                // Load Role List
                // ------------------------
                function loadRoleData() {
                    $.ajax({
                        type: "GET",
                        url: '@Url.Action("GETROLELIST", "Master")',
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            const $tbody = $("#tblRoleMaster tbody");
                            $tbody.empty();

                            if (data && data.length) {
                                getRole("");

                                data.forEach(item => {
                                    const statusBadge = item.IsActive === "A"
                                        ? '<span class="badge bg-success">Active</span>'
                                        : '<span class="badge bg-secondary">Inactive</span>';

                                    $tbody.append(`
                                <tr>
                                    <td>${item.RoleName}</td>
                                    <td>${statusBadge}</td>
                                    <td hidden>${item.RoleID}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary role_edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger role_delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `);
                                });
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error loading Role data');
                        }
                    });
                }

                // ------------------------
                // Get Role for Dropdown
                // ------------------------
                function getRole(flag) {
                    $.ajax({
                        type: "GET",
                        url: '@Url.Action("GETROLE", "Master")',
                        contentType: "application/json; charset=utf-8",
                        cache: true,
                        success: function (data) {
                            if (data && data.length) {
                                RoleData = data;

                                if (flag !== "A") {
                                    const defaultval = $('#EmpRole').val();
                                    const $select = $('#EmpRole');

                                    let options = ['<option value="">Select</option>'];
                                    data.forEach(item => {
                                        options.push(`
                                            <option value="${item.RoleID}">
                                                ${item.RoleName}
                                            </option>
                                        `);
                                    });

                                    $select.html(options.join(''));
                                    $select.val(defaultval);
                                }
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error loading role');
                        }
                    });
                }


                // ------------------------
                // Create Role
                // ------------------------
                function createRole() {
                    const rolePayload = {
                        RoleName: $('#txtRoleName').val().trim(),
                        IsActive: $('#ddlRoleStatus').val()
                    };

                    if (!rolePayload.RoleName) {
                        Notify('warning', 'Validation', 'Role Name is required');
                        return;
                    }

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("CREATEROLE", "Master")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(rolePayload),
                        success: function (response) {
                            if (response.success) {
                                Notify('success', 'Success', 'Role created successfully');
                                resetRoleForm();
                                loadRoleData();
                                $('#RoleMasterTabs a[href="#view-role"]').tab('show');
                            } else {
                                Notify('error', 'Error', response.message);
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error creating Role');
                        }
                    });
                }

                // ------------------------
                // Update Role
                // ------------------------
                function updateRole() {
                    const rolePayload = {
                        RoleID: $('#ROLE_ID').val(),
                        RoleName: $('#txtRoleName').val().trim(),
                        IsActive: $('#ddlRoleStatus').val()
                    };

                    if (!rolePayload.RoleName) {
                        Notify('warning', 'Validation', 'Role Name is required');
                        return;
                    }

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("UPDATEROLE", "Master")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(rolePayload),
                        success: function (response) {
                            if (response.success) {
                                Notify('success', 'Success', 'Role updated successfully');
                                resetRoleForm();
                                loadRoleData();
                                $('#RoleMasterTabs a[href="#view-role"]').tab('show');
                            } else {
                                Notify('error', 'Error', response.message);
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error updating Role');
                        }
                    });
                }

                // ------------------------
                // Edit Role
                // ------------------------
                $(document).on('click', '.role_edit', function () {
                    const row = $(this).closest('tr');

                    $('#ROLE_ID').val(row.find('td:nth-child(3)').text().trim());
                    $('#txtRoleName').val(row.find('td:nth-child(1)').text().trim());

                    const isActive = row.find('td:nth-child(2)').text().includes('Active');
                    $('#ddlRoleStatus').val(isActive ? 'A' : 'I');

                    $('#create-role-tab').click();
                });

                // ------------------------
                // Delete Role
                // ------------------------
                $(document).on('click', '.role_delete', function () {
                    const row = $(this).closest('tr');
                    const roleId = row.find('td:nth-child(3)').text().trim();
                    const roleName = row.find('td:nth-child(1)').text().trim();

                    if (!confirm(`Are you sure you want to delete role "${roleName}"?`)) return;

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("DELETEROLE", "Master")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({ roleId: roleId }),
                        success: function (response) {
                            if (response.success) {
                                Notify('success', 'Success', 'Role deleted successfully');
                                loadRoleData();
                            } else {
                                Notify('error', 'Error', response.message);
                            }
                        },
                        error: function (xhr) {
                            Notify('error', 'Error', xhr.responseText || 'Error deleting Role');
                        }
                    });
                });

                // ------------------------
                // Reset Form
                // ------------------------
                function resetRoleForm() {
                    $('#ROLE_ID').val('');
                    $('#txtRoleName').val('');
                    $('#ddlRoleStatus').val('A');
                }

            }

        // ------------------------
        // Load states for a country
        // ------------------------
        $('#Coun_Id').change(function() {
            const countryId = $(this).val();
            const $stateDropdown = $('#Stat_Id');

            if (!countryId) {
                $stateDropdown.empty().append('<option value="">Select State</option>').prop('disabled', true);
                return;
            }

            $.ajax({
                url: '@Url.Action("GETSTATEBYCOUNTRY", "Master")',
                data: { id: countryId },
                type: 'GET',
                beforeSend: function() {
                    $stateDropdown.prop('disabled', true).html('<option value="">Loading states...</option>');
                },
                success: function(response) {
                    $stateDropdown.empty().append('<option value="">Select State</option>');
                    if (response && response.length) {
                        response.forEach(function(state) {
                            $stateDropdown.append($('<option>').val(state.Stat_Id).text(state.Name));
                        });
                    }
                    $stateDropdown.prop('disabled', false);

                    // If someone set a pending state (from edit), select it now:
                    const pending = $stateDropdown.data('pending-value');
                    if (pending) {
                        $stateDropdown.val(pending).removeData('pending-value');
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading states';
                    Notify('error', 'Error', errorMessage);
                    $stateDropdown.prop('disabled', false).html('<option value="">Error loading states</option>');
                }
            });
        });

        // ------------------------
        // Load all Employees (table)
        // ------------------------
        function loadEmployee() {
            $.ajax({
                url: '@Url.Action("GETEMPLOYEE", "Master")',
                type: 'GET',
                success: function (response) {
                    var tableBody = $('#employeeMasterTable tbody');
                    tableBody.empty();

                    if (response && response.length > 0) {
                        $.each(response, function (index, employee) {
                            // For display, prefer name fields if provided by API; otherwise show ids
                            var countryDisplay = employee.Coun_Name || employee.Coun || employee.Coun_Id || '';
                            var stateDisplay   = employee.Stat_Name || employee.State || employee.Stat_Id || '';
                            var statusBadge = (employee.IsActive === "A" || employee.IsActive === 'Active') ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>';
                            //var roleDisplay = employee.RoleName || employee.RoleID ||  '';

                            var row = `<tr data-id="${employee.EmployeeID || ''}">
                                   <td>${employee.EmployeeCode || ''}</td>
                                   <td>${employee.FirstName || ''}</td>
                                   <td>${employee.LastName || ''}</td>
                                   <td>${employee.Position || ''}</td>
                                   <td>${employee.RoleName || ''}</td>
                                   <td>${employee.PhoneNo || ''}</td>
                                   <td>${employee.MobilePhone || ''}</td>
                                   <td>${employee.Street || ''}</td>
                                   <td>${employee.City || ''}</td>
                                   <td>${stateDisplay}</td>
                                   <td>${countryDisplay}</td>
                                   <td>${employee.Addres || ''}</td>
                                   <td>${statusBadge}</td>
                                   <td>
                                       <button type="button" class="btn btn-sm btn-primary  btn-edit" title="Edit">
                                           <i class="bi bi-pencil"></i>
                                       </button>
                                   </td>
                               </tr>`;
                            tableBody.append(row);
                        });

                        // Generate next code after loading employees
                        generateNextEmployeeCode();
                    } else {
                        // no data
                        tableBody.append('<tr><td colspan="14" class="text-center">No employee records found.</td></tr>');
                        // Set default code if no employees exist
                        $('#Code').val('1');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading employees';
                    Notify('error', 'Error', errorMessage);
                }
            });
        }

        // ------------------------
        // Auto-increment Employee Code
        // ------------------------
        function generateNextEmployeeCode() {
            let maxCode = 0; // Default starting point

            $('#employeeMasterTable tbody tr').each(function() {
                const codeText = $(this).find('td:eq(0)').text().trim(); // Get employee code from first column

                if (codeText) {
                    // Extract numeric part from the code
                    // This handles codes like "EMP001", "1001", "E001", etc.
                    const numericMatch = codeText.match(/\d+/g);

                    if (numericMatch) {
                        // Join all numeric parts if there are multiple
                        const numericString = numericMatch.join('');
                        const codeNumber = parseInt(numericString);

                        if (!isNaN(codeNumber) && codeNumber > maxCode) {
                            maxCode = codeNumber;
                        }
                    } else if (!isNaN(codeText)) {
                        // If the entire code is a number
                        const codeNumber = parseInt(codeText);
                        if (!isNaN(codeNumber) && codeNumber > maxCode) {
                            maxCode = codeNumber;
                        }
                    }
                }
            });

            // Set the next code
            $('#Code').val((maxCode + 1).toString());
        }

        // Initial load
        loadCountries();
        loadEmployee();

        // ------------------------
        // Form interactions & realtime validation
        // ------------------------
        // Validate relevant fields on input/change
        Object.keys(rules).forEach(function(id) {
            $('#' + id).on('input change', function() {
                validateFieldByRule(id);
            });
        });

        // Remove invalid class on manual change for selects/buttons
        $('#Code, #FirstName, #LastName, #Coun_Id, #Stat_Id, #MobilePhone').on('input change', function() {
            $(this).removeClass('is-invalid');
        });
        $("#LinkUser").change(function () {
            // Build payload
            var formData = {
                EmployeeID: $('#Employee_Id').val(),
                EmployeeCode: $('#Code').val(),
                FirstName: $('#FirstName').val().trim(),
                MiddleName: $('#MiddleName').val().trim(),
                LastName: $('#LastName').val().trim(),
                RoleID: $('#EmpRole').val(),
                Position: $('#Position').val().trim(),
                PhoneNo: $('#PhoneNo').val().trim(),
                MobilePhone: $('#MobilePhone').val().trim(),
                Street: $('#Street').val().trim(),
                Coun_Id: $('#Coun_Id').val(),
                Stat_Id: $('#Stat_Id').val(),
                City: $('#City').val().trim(),
                ZipCode: $('#ZipCode').val().trim(),
                Addres: $('#Addres').val().trim(),
                IsActive: $('#IsActive').is(':checked') ? "A" : "I",
                LinkUser: $('#LinkUser').is(':checked') ? "Y" : "N"


            };
               const getUsersUrl = '@Url.Action("GETUSERS", "Auth")'
               const postUserUrl = '@Url.Action("Users", "Auth")'
                 if (formData.LinkUser == "Y") {
                     const user = {
                         UserID: null,
                         EmpId: $('#Employee_Id').val(),
                         Username: $('#FirstName').val() + $('#LastName').val(),
                         Password: $('#FirstName').val().trim() + $('#MobilePhone').val().trim().slice(-4),
                         FullName: $('#FirstName').val() + ' ' + $('#MiddleName').val() + ' ' + $('#LastName').val(),
                         Email:"",
                         Mobile: $('#MobilePhone').val(),
                         Role: "U",
                         LicenseValidFrom:"",
                         LicenseValidTo: "",
                         Licencekey:"",
                         IsActive: "1",
                     };


                     $.ajax({
                         type: "POST",
                         url: '@Url.Action("Users", "Auth")',
                         contentType: "application/json; charset=utf-8",
                         data: JSON.stringify(user),
                         success: function (data) {
                             if (data.success) {
                                 Notify('success', 'Success', data.message);
                             } else {
                                 Notify('error', 'Error', data.message);
                             }
                         },
                         error: function (xhr) {
                             const errorMessage = xhr.responseJSON?.message || "Unknown error";
                             Notify('error', 'Error', data.message);
                         }
                     });
                 }
        })
        // ------------------------
        // Save/Update employee
        // ------------------------
        $('#btnSave').click(function () {
                // run validation
                if (!validateForm()) {
                    Notify('warning', 'Validation Error', 'Please correct the highlighted fields before saving.');
                    return;
                }

                // Duplicate check (client-side)
                var codeVal = $('#Code').val().trim();
                var firstVal = $('#FirstName').val().trim();
                var lastVal = $('#LastName').val().trim();
                var currentEmployeeId = $('#Employee_Id').val();

                var dup = checkDuplicateOnTable(codeVal, firstVal, lastVal, currentEmployeeId);
                if (dup.codeExists || dup.nameExists) {
                    let msg = '';
                    if (dup.codeExists && dup.nameExists) msg = 'Both Code and Name already exist.';
                    else if (dup.codeExists) msg = 'Employee Code already exists.';
                    else msg = 'Employee with same name already exists.';
                    Swal.fire({ icon: 'warning', title: 'Duplicate Entry', text: msg, timer: 2500, timerProgressBar: true });
                    return;
                }

                // Build payload
                var formData = {
                    EmployeeID: $('#Employee_Id').val(),
                    EmployeeCode: $('#Code').val(),
                    FirstName: $('#FirstName').val().trim(),
                    MiddleName: $('#MiddleName').val().trim(),
                    LastName: $('#LastName').val().trim(),
                    RoleID: $('#EmpRole').val(),
                    Position: $('#Position').val().trim(),
                    PhoneNo: $('#PhoneNo').val().trim(),
                    MobilePhone: $('#MobilePhone').val().trim(),
                    Street: $('#Street').val().trim(),
                    Coun_Id: $('#Coun_Id').val(),
                    Stat_Id: $('#Stat_Id').val(),
                    City: $('#City').val().trim(),
                    ZipCode: $('#ZipCode').val().trim(),
                    Addres: $('#Addres').val().trim(),
                    IsActive: $('#IsActive').is(':checked') ? "A" : "I",
                    LinkUser: $('#LinkUser').is(':checked') ? "Y" : "N"
                };
                          // Replace with actual URL if not Razor view


                var isEdit = formData.EmployeeID && formData.EmployeeID.length > 0;

                $.ajax({
                    url: '@Url.Action("CREATEEMPLOYEE", "Master")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    beforeSend: function() {
                        $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    },
                    success: function (response) {
                        if (response && response.success) {
                            Notify('success', 'Success', response.message || (isEdit ? 'Employee updated successfully!' : 'Employee created successfully!'));
                            // Reset form & reload
                            $('#employeeMasterForm')[0].reset();
                            $('#Stat_Id').empty().append('<option value="">Select State</option>').prop('disabled', true);
                            $('#Employee_Id').val('');
                            $('#btnDelete').prop('disabled', true);
                            loadEmployee();
                            loadCountries(); // Reload countries to reset selection
                        } else {
                            Notify('warning', 'Warning', response.message || 'Operation completed but with warnings.');
                        }
                    },
                    error: function(xhr, status, error) {
                        const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error saving employee';
                        Notify('error', 'Error', errorMessage);
                    },
                    complete: function() {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    }
                });
            });
        // ------------------------
        // Delete employee
        // ------------------------
        $('#btnDelete').click(function() {
            var employeeId = $('#Employee_Id').val();
            if (!employeeId) {
                Notify('warning', 'Warning', 'No employee selected to delete.');
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETEEMPLOYEE", "Master")',
                        type: 'POST',
                        data: { id: employeeId },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'Employee deleted successfully!');
                                $('#employeeMasterForm')[0].reset();
                                $('#Employee_Id').val('');
                                $('#btnDelete').prop('disabled', true);
                                loadEmployee();
                                loadCountries(); // Reload countries to reset selection
                            } else {
                                Notify('warning', 'Warning', response.message || 'Employee could not be deleted.');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting employee';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        });

        // ------------------------
        // Edit employee - load to form
        // ------------------------
        $(document).on('click', '.btn-edit', function () {

            var employeeId = $(this).closest('tr').data('id');
            if (!employeeId) {
                Notify('warning', 'Warning', 'No employee ID found for editing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("GETEMPLOYEEBYID", "Master")',
                data: { id: employeeId },
                type: 'GET',
                beforeSend: function() {
                    // optional loading
                },
                success: function (response) {
                    if (response && response.length > 0) {
                        var employee = response[0];

                        $('#Employee_Id').val(employee.EmployeeID || '');
                        $('#Code').val(employee.EmployeeCode || '');
                        $('#FirstName').val(employee.FirstName || '');
                        $('#MiddleName').val(employee.MiddleName || '');
                        $('#LastName').val(employee.LastName || '');
                        $('#Position').val(employee.Position || '');
                        $('#EmpRole').val(employee.RoleID || '');
                        $('#PhoneNo').val(employee.PhoneNo || '');
                        $('#MobilePhone').val(employee.MobilePhone || '');
                        $('#ZipCode').val(employee.ZipCode || '');
                        $('#Street').val(employee.Street || '');
                        $('#City').val(employee.City || '');
                        $('#Addres').val(employee.Addres || '');
                        $('#IsActive').prop('checked', (employee.IsActive === "A"));
                        $('#LinkUser').prop('checked', (employee.IsActive === "Y"));


                        // Country/state: set country then wait for states to load and set state
                        if (employee.Coun_Id) {
                            // If countries not yet populated, store pending and load
                            const $country = $('#Coun_Id');
                            if ($country.find('option').length <= 1) {
                                // countries not loaded yet; store pending and load countries
                                $country.data('pending-value', employee.Coun_Id);
                                loadCountries();
                            } else {
                                $country.val(employee.Coun_Id).trigger('change');
                            }

                            // set pending state selection to be applied after states load
                            if (employee.Stat_Id) {
                                $('#Stat_Id').data('pending-value', employee.Stat_Id);
                            }
                        }

                        $('#btnDelete').prop('disabled', false);
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                    }
                    else {
                        Notify('warning', 'Warning', 'No data returned for this employee.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading employee data';
                    Notify('error', 'Error', errorMessage);
                }
            });
        });

        // ------------------------
        // Reset handler
        //// ------------------------
        $('#btnReset').click(function() {
            setTimeout(function () {
                loadCountries();
                $('#Employee_Id').val('');
                $('#Code').val('');
                $('#btnDelete').prop('disabled', true);
                $('.is-invalid').removeClass('is-invalid');

                // Generate new code on reset
                generateNextEmployeeCode();
            }, 50);
        });







    });
</script>