<!-- Financial Year Master Form Section -->
<section id="fYearMasterSection">
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title">
                    <i class="bi bi-calendar-range"></i> Financial Year Master
                </h3>
            </div>
            <div class="card-body">
                <form id="fYearMasterForm">
                    <input type="hidden" id="FYearId" name="FYearId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="FYear" class="form-label">Financial Year <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="text" class="form-control" id="FYear" name="FYear" required maxlength="50">
                                <div class="invalid-feedback">Please provide a valid financial year.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="Year" class="form-label">Year <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                <input type="number" class="form-control" id="Year" name="Year" required min="2000" max="2100">
                                <div class="invalid-feedback">Please provide a valid year (2000-2100).</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="StarDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                                <input type="date" class="form-control" id="StarDate" name="StarDate" required>
                                <div class="invalid-feedback">Please provide a valid start date.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="EndDate" class="form-label">End Date <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                                <input type="date" class="form-control" id="EndDate" name="EndDate" required>
                                <div class="invalid-feedback">Please provide a valid end date.</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Status" class="form-label">Status</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-info-circle"></i></span>
                                <select class="form-select" id="Status" name="Status">
                                    <option value="O">Open</option>
                                    <option value="C">Closed</option>
                                    <option value="L">Locked</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 text-end">
                        <div class="col-md-12">
                                @if (ViewBag.BtnAuth != null)
                                {
                                    <!-- Button Rendering Logic -->
                                    @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                                    {
                                        var btnName = item["BtnName"]?.ToString().Trim();
                                        var btnauth = item["Auth"]?.ToString();
                                        var icon = item["Icon"]?.ToString();
                                        var ColorClass = item["ColorClass"]?.ToString();

                                        if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                        {
                                            switch (btnName)
                                            {
                                                case "Save":
                                                    <button type="button" id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                        <i class="@icon"></i>@btnName
                                                    </button>
                                                    break;
                                                case "Delete":
                                                    <button type="button" id="btnDelete" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2" disabled>
                                                        <i class="@icon"></i>@btnName
                                                    </button>
                                                    break;
                                                case "Reset":
                                                    <button type="reset" id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                        <i class="@icon"></i> Reset
                                                    </button>
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-primary" role="alert">

                                    </div>
                                }
                        </div>
                    </div>
                </form>

                <div class="table-responsive mt-4">
                    <table id="fYearMasterTable" class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Financial Year</th>
                                <th>Year</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- jQuery CRUD Operations -->
<script>
    $(document).ready(function() {
        // Initialize form validation
        function validateForm() {
            let isValid = true;
            const fYear = $('#FYear').val().trim();
            const year = $('#Year').val();
            const starDate = $('#StarDate').val();
            const endDate = $('#EndDate').val();

            // Validate Financial Year
            if (fYear.length < 4) {
                $('#FYear').addClass('is-invalid');
                isValid = false;
            } else {
                $('#FYear').removeClass('is-invalid');
            }

            // Validate Year (2000-2100)
            if (year === '' || isNaN(year) || parseInt(year) < 2000 || parseInt(year) > 2100) {
                $('#Year').addClass('is-invalid');
                isValid = false;
            } else {
                $('#Year').removeClass('is-invalid');
            }

            // Validate Start Date
            if (!starDate) {
                $('#StarDate').addClass('is-invalid');
                isValid = false;
            } else {
                $('#StarDate').removeClass('is-invalid');
            }

            // Validate End Date
            if (!endDate) {
                $('#EndDate').addClass('is-invalid');
                isValid = false;
            } else {
                $('#EndDate').removeClass('is-invalid');
            }

            // Validate date range
            if (starDate && endDate && new Date(starDate) >= new Date(endDate)) {
                $('#StarDate').addClass('is-invalid');
                $('#EndDate').addClass('is-invalid');
                isValid = false;
            }

            return isValid;
        }
        // Dynamic duplicate check
        function checkDuplicate() {
            const $codeInput = $('#Year');
            const $nameInput = $('#FYear');
            const code = $codeInput.val().trim();
            const name = $nameInput.val().trim();
            if (!code && !name) return false;

            let codeExists = false;
            let nameExists = false;

            $('#fYearMasterTable tbody tr').each(function () {
                const rowCode = $(this).find('td:eq(0)').text().trim();
                const rowName = $(this).find('td:eq(1)').text().trim();

                if (rowCode === code) codeExists = true;
                if (rowName === name) nameExists = true;

                if (codeExists && nameExists) return false; // break loop if both found
            });

            if (codeExists && nameExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Entry',
                    text: 'Both Year  and Financial Year already exist!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $codeInput.val('');
                $nameInput.val('');
            } else if (codeExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Year ',
                    text: 'This Year  already exists!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $codeInput.val('');
            } else if (nameExists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Duplicate Financial Year',
                    text: 'This Financial Year already exists!',
                    timer: 2000,
                    timerProgressBar: true
                });
                $nameInput.val('');
            }

            return codeExists || nameExists;
        }
        // Bind live check
        $(document).on('change', '#Year , #FYear', checkDuplicate);
        // Load all Financial Year records
        function loadFYear() {
            $.ajax({
                url: '@Url.Action("GETFYYEAR", "Master")',
                type: 'GET',
                beforeSend: function() {
                    // Show loading indicator if needed
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var tableBody = $('#fYearMasterTable tbody');
                        tableBody.empty();

                        $.each(response, function(index, fYear) {
                            var row = `<tr data-id="${fYear.FYearId}">
                                <td>${fYear.FYear || ''}</td>
                                <td>${fYear.Year || ''}</td>
                                <td>${fYear.StarDate  || ''}</td>
                                <td>${fYear.EndDate || ''}</td>
                                <td>${fYear.Status || ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary btn-edit" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>`;
                            tableBody.append(row);
                        });
                    } else {
                        Notify('warning', 'No Data', 'No Financial Year records found.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading Financial Year records';
                    Notify('error', 'Error', errorMessage);
                }
            });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Initial load
        loadFYear();

        // Save/Update Financial Year
        $('#btnSave').click(function() {
            if (!validateForm()) {
                Notify('warning', 'Validation Error', 'Please correct the form errors before saving.');
                return;
            }

            // Create a JavaScript object from the form data
            var formData = {
                FYearId: $('#FYearId').val(),
                FYear: $('#FYear').val().trim(),
                Year: $('#Year').val(),
                StarDate: $('#StarDate').val(),
                EndDate: $('#EndDate').val(),
                Status: $('#Status').val()
            };

            var isEdit = formData.FYearId !== '';

            $.ajax({
                url:  '@Url.Action("CREATEFYEAR", "Master")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(formData),
                beforeSend: function() {
                    $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                },
                success: function(response) {
                    if (response && response.success) {
                        Notify('success', 'Success', response.message || (isEdit ? 'Financial Year updated successfully!' : 'Financial Year created successfully!'));
                        loadFYear();
                        $('#fYearMasterForm')[0].reset();
                        $('#FYearId').val('');
                        $('#btnDelete').prop('disabled', true);
                    } else {
                        Notify('warning', 'Warning', response.message || 'Operation completed but with warnings.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error saving Financial Year';
                    Notify('error', 'Error', errorMessage);
                },
                complete: function() {
                    $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                }
            });
        });

        // Delete Financial Year
        $('#btnDelete').click(function() {
            var fYearId = $('#FYearId').val();
            if (!fYearId) {
                Notify('warning', 'Warning', 'No Financial Year selected to delete.');
                return;
            }

            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETEFYEAR", "Master")',
                        type: 'POST',
                        data: { id: fYearId },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'Financial Year deleted successfully!');
                                loadFYear();
                                $('#fYearMasterForm')[0].reset();
                                $('#FYearId').val('');
                            } else {
                                Notify('warning', 'Warning', response.message || 'Financial Year could not be deleted.');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Financial Year';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        });

        // Edit Financial Year
        $(document).on('click', '.btn-edit', function() {
            var fYearId = $(this).closest('tr').data('id');
            if (!fYearId) {
                Notify('warning', 'Warning', 'No Financial Year ID found for editing.');
                return;
            }

            $.ajax({
                url: '@Url.Action("GETFYEARBYID", "Master")',
                data: { id: fYearId },
                type: 'GET',
                beforeSend: function() {
                    // Show loading indicator if needed
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var fYear = response[0];
                        $('#FYearId').val(fYear.FYearId);
                        $('#FYear').val(fYear.FYear);
                        $('#Year').val(fYear.Year);
                        $('#StarDate').val(formatDateForInput(fYear.StarDate));
                        $('#EndDate').val(formatDateForInput(fYear.EndDate));
                        $('#Status').val(fYear.Status || 'Open');
                        $('#btnDelete').prop('disabled', false);
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                    } else {
                        Notify('warning', 'Warning', 'No data returned for this Financial Year.');
                    }
                },
                error: function(xhr, status, error) {
                    const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error loading Financial Year data';
                    Notify('error', 'Error', errorMessage);
                }
            });
        });

        // Format date for input field
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Reset form
        $('#btnReset').click(function() {
            $('#FYearId').val('');
            $('#btnDelete').prop('disabled', true);
            $('.is-invalid').removeClass('is-invalid');
            $('#Status').val('Open');
        });

        // Real-time validation
        $('#FYear, #Year, #StarDate, #EndDate').on('input change', function() {
            $(this).removeClass('is-invalid');
        });
    });
</script>