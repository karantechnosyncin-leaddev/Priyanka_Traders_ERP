<style>
</style>
<div class="container-fluid">
    <div class="row mt-2">
        <div class="col-12">
            <div class="card p-2 rounded shadow-sm">
                <div class="row">
                    <div class="col-md-6 d-flex align-items-center">
                        <h3 id="doctitle"><b>Inprogress Rejection Record</b></h3>
                    </div>
                    <div class="col-md-6 d-flex justify-content-end align-items-center flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {

                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();
                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {

                                        case "Export":
                                            <button id="btnPdf" class="btn btn-outline-danger me-2 mb-1">
                                                <i class="bi bi-file-pdf me-1"></i> PDF
                                            </button>
                                            <button id="btnExcel" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> EXCEL
                                            </button>
                                            <button id="btnCSV" class="btn btn-outline-success me-2 mb-1">
                                                <i class="bi bi-file-earmark-excel me-1"></i> CSV
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt-3">
            <div class="card p-3 rounded shadow-sm">
                <!-- Action Buttons -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-end flex-wrap">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Save":
                                            <button id="btnSave" data-action="create" data-item-id="" class="btn @ColorClass mb-1  me-2">
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        @*    case "Update":
                                            <button id="btnUpdate" data-action="update" class="btn @ColorClass mb-1  me-2" disabled>
                                                <i class="@icon"></i> @btnName
                                            </button>
                                            break; *@
                                        case "Print":
                                            <button id="btnassmPrint" class="btn @ColorClass mb-1   me-2" >
                                                <i class="@icon"></i>@btnName
                                            </button>
                                            break;
                                        case "Reset":
                                            <button id="btnReset" class="btn @ColorClass mb-1   me-2">
                                                <i class="@icon"></i> Reset
                                            </button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>

                <!-- Header Information -->
                <div class="row">
                    <div class="col-md-2 col-6 mb-2" hidden>
                        <input id="DocumentEntry" hidden class="form-control" type="text" readonly />
                        <input id="doctype" type="text" hidden value="AIRR" class="form-control" />
                    </div>

                    <div class="col-md-2 col-6 mb-2">
                        <label for="RevNo" class="form-label">Rev No</label>
                        <input id="RevNo" class="form-control" value="0" type="text" readonly />
                    </div>
                    <div class="col-md-2 col-6 mb-2">
                        <label for="FormatNo" class="form-label">Format No</label>
                        <input id="FormatNo" class="form-control" value="BE/Prod/11(B)" type="text" readonly />
                    </div>
                    <div class="col-md-2 col-6 mb-2">
                        <label for="FromDate" class="form-label">From Date</label>
                        <input id="FromDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-2 col-6 mb-2">
                        <label for="ToDate" class="form-label">To Date</label>
                        <input id="ToDate" class="form-control datepicker" type="date" />
                    </div>
                    <div class="col-md-2 col-6 mb-2">
                        <label for="FYearId" class="form-label">Fiscal Year</label>
                        <select id="FYearId" class="form-select">
                            <option value="">Select Fiscal Year</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <!-- Line Items -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table  table-hover" id="mainitemtable">
                                <thead class="table-light">
                                    <tr>
                                        <th nowrap>Sr No</th>
                                        <th nowrap>Delete</th>
                                        <th nowrap>Date</th>
                                        <th nowrap>Operator Name</th>

                                        <th nowrap>CatNo</th>
                                        <th nowrap>Qty</th>
                                        <th nowrap>UOM</th>
                                        <th nowrap>Short Molding</th>
                                        <th nowrap>White Spot</th>
                                        <th nowrap>Yellow Spot</th>
                                        <th nowrap>Kidney Damage</th>
                                        <th nowrap>Slot Missing</th>
                                        <th nowrap>Breakage</th>
                                        <th nowrap>Other Prob</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    <tr data-id='' data-changeflag="N" class="line-item">
                                        <td>1</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                        <td><input type="date" class="form-control  form-control-sm datepicker Date" /></td>
                                        <td><input style='width:250px!important;' type="text" class="form-control form-control-sm  text-end  OperatorName" placeholder="Oprator Name" value=""></td>
                                        <td><input style='width:100px!important;' type="text" class="form-control form-control-sm  text-end  CatNo" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Qty" value=""></td>
                                        <td><input style='width:100px!important;' type="text" class="form-control form-control-sm text-end UOM" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end ShortMolding" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end WhiteSpot" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end YellowSpot" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end KidneyDamage" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end SlotMissing" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Breakage" value=""></td>
                                        <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end OtherProb" value=""></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 text-end mt-3">
                        @if (ViewBag.BtnAuth != null)
                        {
                            <!-- Button Rendering Logic -->
                            @foreach (var item in (List<Dictionary<string, object>>)ViewBag.BtnAuth)
                            {
                                var btnName = item["BtnName"]?.ToString().Trim();
                                var btnauth = item["Auth"]?.ToString();
                                var icon = item["Icon"]?.ToString();
                                var ColorClass = item["ColorClass"]?.ToString();

                                if (btnauth == "Y" && !string.IsNullOrEmpty(btnName))
                                {
                                    switch (btnName)
                                    {
                                        case "Add New Line":
                                            <button class="btn @ColorClass mb-1 " id="btnAddLine"><i class="@icon"></i> @btnName</button>
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-primary" role="alert">

                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals -->
<script>
    $(document).ready(function () {
        // Initialize variables
        let selectedRowIndex = null;
        $('.datepicker').val(new Date().toISOString().split('T')[0]);
        loadFiscalYears();
        // Add new line item
        $('#btnAddLine').click(function () {
            savedocument("S")
            addNewLineItem();
        });
        // Save document
        $('#btnSave').click(function () {
            savedocument("S");
        });
        // Save document
        $('#btnPark').click(function () {
            savedocument("P");
        });
        // Update document
        $('#btnUpdate').click(function () {
            savedocument();
        });
        // Reset form
        $('#btnReset').click(function () {
            resetForm();
        });
        @*$('#btnDelete').click(function() {
            deleteDoc();
        });
        function deleteDoc(){
          var id = $('#DocumentEntry').val();
            if(!id){
                Notify('error', 'Document Entry is required for deletion','');
                return;
            }
             Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("DELETEPURCHQUOT", "Purchase")',
                        type: 'POST',
                        data: { id: $("#DocumentEntry").val() },
                        beforeSend: function() {
                            $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                        },
                        success: function(response) {
                            if (response && response.success) {
                                Notify('success', 'Success', response.message || 'Document deleted successfully!');
                                 resetForm();
                            } else {
                                Notify('warning', 'Warning', response.message || 'Document deleted successfully!');
                            }
                        },
                        error: function(xhr, status, error) {
                            const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Document';
                            Notify('error', 'Error', errorMessage);
                        },
                        complete: function() {
                            $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                        }
                    });
                }
            });
        }*@
        // Function to add new line item
        function addNewLineItem() {
            const table = $('#mainitemtable tbody');
            const lastRow = table.find('tr').last();

            // Check if there is at least one row and its ItemCode is empty
            if (lastRow.length && !lastRow.find('.OperatorName').val().trim()) {
                lastRow.find('.OperatorName').focus();
                return; // Stop execution if the previous row's ItemCode is empty
            }

            const rowCount = table.find('tr').length;
            const newRow = `
                    <tr data-id='' data-changeflag="N" class="line-item">
                         <td>${rowCount + 1}</td>
                         <td class="text-center">
                             <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                 <i class="bi bi-trash"></i>
                             </button>
                         </td>
                         <td><input type="date" class="form-control  form-control-sm datepicker Date" /></td>
                         <td><input style='width:250px!important;' type="text" class="form-control form-control-sm  text-end  OperatorName" placeholder="Oprator Name" value=""></td>

                         <td><input style='width:100px!important;' type="text" class="form-control form-control-sm  text-end  CatNo" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Qty" value=""></td>
                         <td><input style='width:100px!important;' type="text" class="form-control form-control-sm text-end UOM" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end ShortMolding" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end WhiteSpot" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end YellowSpot" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end KidneyDamage" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end SlotMissing" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Breakage" value=""></td>
                         <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end OtherProb" value=""></td>
                    </tr>
            `;
            table.append(newRow);
            const newRowElement = table.find('tr').last();
            newRowElement.find('.Date').val(new Date().toISOString().split('T')[0]);
            newRowElement.find('.OperatorName').focus();

            if (rowCount > 0) {
                table.find('tr').each(function () {
                    $(this).find('.remove-line').prop('disabled', false);
                });
            }
        }
        $(document).on("input", "#mainitemtable tbody input,textarea", function () {
            var row = $(this).closest("tr");
            row.attr("data-changeflag", "Y")
        })

       function loadFiscalYears() {
          $.ajax({
               url: '@Url.Action("GETOPENFYEAR", "Inventory")',
              method: 'GET',
              success: function(response) {
                  const select = $('#FYearId');
                  select.empty();

                  response.forEach(function(year) {
                      select.append(`<option value="${year.FYearId}">${year.FYear}</option>`);
                  });
              },
              error: function(xhr) {
                          Notify('error', 'Error', xhr.responseText );
              }
          });
      }

        function savedocument(flag) {
            removeempty()
            const headerData = getHeaderData();
            const lineItems = getLineItems();
            if (!validateForm(headerData, lineItems)) {
                return;
            }
            const data = {
                header: headerData,
                lines: lineItems,
            };
            // AJAX call to save
            $.ajax({
                url: '@Url.Action("CREATEINPROGRESSREJEC", "Assembly")' + '?flag=' + flag + '&doctype=' + $("#doctype").val(),
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    } else {
                        $('#btnPark').prop('disabled', true).html('<i class="bi bi-p-circle"></i> Processing...');
                    }
                },
                success: function (response) {

                    if(response.success){
                       Notify('success', response.message,'');
                       currentDocEntry = response.docEntry;
                       //$('#btnUpdate').prop('disabled', false);
                       $('#btnDelete').prop('disabled', false);
                       $('#btnCancel').prop('disabled', false);
                       $('#DocumentEntry').val(response.docEntry);
                       $('#addFilesButton').click();
                     //  $("#btnReset").click();
                        if (flag == "S") {
                             Get_RowBinding()
                        } else {
                            $("#btnReset").click();
                        }
                    }else{
                       Notify('error','Faild To Create ', response.message);
                    }
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseText || 'Error To Save Data';
                    Notify('error', 'Error', errorMessage);
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }

                },complete: function() {
                    if (flag == "S") {
                        $('#btnSave').prop('disabled', false).html('<i class="bi bi-save"></i> Save');
                    } else {
                        $('#btnPark').prop('disabled', false).html('<i class="bi bi-p-circle"></i> Park');
                    }
                }
            });
        }
        function removeempty(){
            var tablerow= $('#mainitemtable tbody tr').length;
            if(tablerow >1){
                $('#mainitemtable tbody tr').each(function(){
                     var row = $(this).closest("tr");
                    if (row.length && !row.find('.OperatorName').val().trim()) {
                        row.remove();
                        return; // Stop execution if the previous row's ItemCode is empty
                    }
                });
            }
        }
        function getHeaderData() {
            return {
                DocEntry: $('#DocumentEntry').val() || null,
                RevNo: $('#RevNo').val(),
                FYearId: $('#FYearId').val(),
                FormatNo: $('#FormatNo').val()
            };
        }
        function getLineItems() {
            const lineItems = [];
            $('#mainitemtable tbody tr').each(function(index) {
                const row = $(this);
                var val =  row.attr("data-changeflag");
                if (val == "Y") {
                    lineItems.push({
                        ID: row.data('id').toString() || null,
                        RevNo: "",
                        Date: row.find('.Date').val() || '',
                        OpetorName: row.find('.OperatorName').val()|| "",
                        CatNo: row.find('.CatNo').val() || "",

                        Qty: parseFloat(row.find('.Qty').val()) || 0,

                        UOM: row.find('.UOM').val() || "",

                        ShortMolding: row.find('.ShortMolding').val() || "",
                        WhiteSpot: row.find('.WhiteSpot').val() || "",
                        YellowSpot: row.find('.YellowSpot').val() || "",
                        KidneyDamage: row.find('.KidneyDamage').val() || "",
                        SlotMissing: row.find('.SlotMissing').val() || "",
                        Breakage: row.find('.Breakage').val() || "",
                        OtherProb: row.find('.OtherProb').val() || "",
                    });
                }

            });
            return lineItems;
        }
        function validateForm(header, lines) {

            if (!header.FormatNo) {
                Notify('error', 'Format No is required','');
                return false;
            }
            if (!header.RevNo) {
                Notify('error', 'Rev No is required','');
                return false;
            }
            if (!header.FYearId) {
                Notify('error', 'Fiscal year is required','');
                return false;
            }
            if (lines.length ==0) {
                Notify('warning', 'No Changes Found To Update', '');
                return false;
            }
            var index= 1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (!line.OpetorName) {
                    Notify('error', `Oprator Name is required for line ${index }`,'');
                    return false;
                }
                if (!line.Date) {
                    Notify('error', `Date is required for line ${index}`,'');
                    return false;
                }
                index++;
            }
            return true;
        }
        function resetForm() {

                currentDocEntry = null;
                isEditMode = false;
                // Reset header fields
                $('#DocumentEntry').val('');
                $('#FYearId').val('');
            $('#mainitemtable tbody').empty();
            $('#FromDate').val(new Date().toISOString().split('T')[0]);
            $('#ToDate').val(new Date().toISOString().split('T')[0]);
                Get_RowBinding()
                // Reset buttons
               $('#btnSave').prop('disabled', false);
               $('#btnPark').prop('disabled', false);
               $('#btnDelete').prop('disabled', true);
               $('#btnCopyFrom').prop('disabled', true);
                loadFiscalYears();
            }
         // Modify the remove-line click handler
        $(document).on('click', '.remove-line', function () {

            const row = $(this).closest('tr');
            var id = row.attr("data-id");
            const table = $('#mainitemtable tbody');
            const rowCount = table.find('tr').length;
            if (!id) {
                if (rowCount > 1) {
                    row.remove();
                    table.find('tr').each(function (index) {
                        $(this).find('td:first').text(index + 1);
                    });
                    // Disable remove button if only one row left
                    if (table.find('tr').length === 1) {
                        table.find('tr').first().find('.remove-line').prop('disabled', true);
                    }
                } else {
                    Notify('warning', 'At least one item is required');
                }
                return;
            } else {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("DELETEINPROGRESSREJREC", "Assembly")',
                            type: 'POST',
                            data: { id: id },
                            beforeSend: function () {
                                $('#btnDelete').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Deleting...');
                            },
                            success: function (response) {
                                if (response && response.success) {
                                    Notify('success', 'Success', response.message || 'Record deleted successfully!');
                                    Get_RowBinding()
                                } else {
                                    Notify('warning', 'Warning', response.message || 'Record could not be deleted.');
                                }
                            },
                            error: function (xhr, status, error) {
                                const errorMessage = xhr.responseJSON?.message || xhr.responseText || 'Error deleting Record';
                                Notify('error', 'Error', errorMessage);
                            },
                            complete: function () {
                                $('#btnDelete').prop('disabled', false).html('<i class="bi bi-trash"></i> Delete');
                            }
                        });
                    }
                });
            }
        });
        //Load Row
        {
            $("#FromDate,#ToDate").change(function () {
                Get_RowBinding()
            })
            Get_RowBinding()
            function Get_RowBinding() {
                $("#mainitemtable tbody").empty();
                $.ajax({
                    url: '@Url.Action("GETINPROGRESSROW", "Assembly")',
                    method: 'GET',
                    data: { FromDate: $("#FromDate").val(), ToDate: $("#ToDate").val() },
                    success: function (response) {
                        if (Array.isArray(response) && response.length > 0) {
                            $("#DocumentEntry").val(response[0].DocEntry)
                            for (var i = 0; i < response.length; i++) {
                                var item = response[i];
                                const newRow = `
                                     <tr data-id='${item.ID}' data-changeflag="N" class="line-item">
                                            <td>${i + 1}</td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-danger remove-line" disabled>
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                            <td><input type="date" class="form-control  form-control-sm datepicker Date" value='${item.Date}' /></td>
                                            <td><input style='width:250px!important;' type="text" class="form-control form-control-sm  text-end  OperatorName" placeholder="Oprator Name" value="${item.OpetorName}"></td>
                                              <td><input style='width:100px!important;' type="text" class="form-control form-control-sm  text-end  CatNo" value="${item.CatNo}"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Qty" value="${parseFloat(item.Qty).toFixed(2)}"></td>
                                              <td><input style='width:100px!important;' type="text" class="form-control form-control-sm text-end UOM" value="${item.UOM}"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end ShortMolding" value="${parseFloat(item.ShortMolding).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end WhiteSpot" value="${parseFloat(item.WhiteSpot).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end YellowSpot" value="${parseFloat(item.YellowSpot).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end KidneyDamage" value="${parseFloat(item.KidneyDamage).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end SlotMissing" value="${parseFloat(item.SlotMissing).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end Breakage" value="${parseFloat(item.Breakage).toFixed(2) }"></td>
                                              <td><input style='width:100px!important;' type="number" class="form-control form-control-sm text-end OtherProb" value="${parseFloat(item.OtherProb).toFixed(2) }"></td>
                                      </tr>
                               `;
                                $("#mainitemtable tbody").append(newRow)
                            }
                            function formatDate(inputDate) {
                                const [datePart] = inputDate.split(' ');
                                const [day, month, year] = datePart.split('-');
                                return `${year}-${month}-${day}`;
                            }
                            addNewLineItem()
                        } else {
                            addNewLineItem()
                        }
                    },
                    error: function (xhr) {
                        Notify('error', 'Error', xhr.responseText);
                    }
                });
            }
        }
         //Print Layout
        {
            $("#btnassmPrint").click(function () {
                    PrintLayout1()
            })
            function PrintLayout1() {
                var FromDate = $("#FromDate").val();
                var ToDate = $("#ToDate").val();
                if (FromDate == "" || ToDate == "")
                {
                    Notify('warning','Please Select Valid Date ..!','');
                    return;
                }
                // AJAX call to save
                $.ajax({
                    url: '@Url.Action("GenerateAssembyLayout", "Layout")',
                    method: 'GET',
                    contentType: 'application/json',
                    data: { FromDate: FromDate, ToDate: ToDate, DocType: $("#doctype").val()},
                    beforeSend: function() {
                        $('#btnassmPrint').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Processing...');
                    },
                    success: function (response) {
                        if (response.success) {
                            console
                            if (response.message && response.fileName) {
                                // Extract the base64 part after the comma
                                const base64Data = response.message.split(',')[1];
                                // Decode the base64 string
                                const byteCharacters = atob(base64Data);
                                const byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                const byteArray = new Uint8Array(byteNumbers);
                                const blob = new Blob([byteArray], { type: 'application/pdf' });
                                const pdfUrl = URL.createObjectURL(blob);

                                // Open PDF in a new tab
                                const newTab = window.open(pdfUrl, '_blank');
                                if (newTab) {
                                    newTab.focus();
                                } else {
                                    alert("Please allow popups to view the PDF.");
                                }

                                // Revoke the URL after some time (to free memory)
                                setTimeout(() => {
                                    URL.revokeObjectURL(pdfUrl);
                                }, 5 * 60 * 1000); // keep alive for 5 minutes so PDF loads fine
                            }
                        } else {
                            Notify('error', 'Failed To Create', response.message);
                        }
                    },
                    error: function(xhr) {
                        const errorMessage = xhr.responseText || 'Error loading ITEM GROUP';
                        Notify('error', 'Error', errorMessage);

                    },complete: function() {
                        $('#btnassmPrint').prop('disabled', false).html('<i class="bi bi-printer"></i> Print');
                    }
                });
            }
        }
    });
</script>
